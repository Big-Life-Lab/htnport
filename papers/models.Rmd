---
title: "HTNPoRT Paper - Modelling"
author: "Rafidul Islam"
output: pdf_document
---

### Load packages, functions, and metadata

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Set working directory at RDC
setwd("P:/10619/Dropbox/htnport")

# Load packages and functions
.libPaths("P:/10619/Rpackages")
library(haven)
library(dplyr)
library(recodeflow)
library(survey)
library(srvyr)
library(e1071)
library(rms)
library(ggplot2)
library(iml)
library(ggeffects)
library(scales)

source("R/alcohol.R")
source("R/blood-pressure.R")
source("R/cholesterol-and-obesity.R")
source("R/diabetes.R")
source("R/diet.R")
source("R/exercise.R")
source("R/family-history.R")
source("R/income.R")
source("R/kidney.R")
source("R/medications.R")
source("R/sample.R")

source("R/impute-variables.R")
source("R/descriptive-functions.R")
source("R/centering-utils.R")
source("R/model-functions.R")
source("R/calibration.R")

# Load metadata
config <- config::get()
my_variables <- read.csv(config$variables)
my_variable_details <- read.csv(config$variable_details)
```

### Load medication data and recode medication variables

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Load medication data
cycle1_meds <- read_sas(config$data$`cycle1-meds`)
names(cycle1_meds) <- tolower(names(cycle1_meds)) 
cycle2_meds <- read_sas(config$data$`cycle2-meds`)
cycle3_meds <- read_stata(config$data$`cycle3-meds`)
cycle4_meds <- read_stata(config$data$`cycle4-meds`)
names(cycle4_meds) <- tolower(names(cycle4_meds)) 
cycle5_meds <- read_stata(config$data$`cycle5-meds`)
cycle6_meds <- read_stata(config$data$`cycle6-meds`)
names(cycle6_meds) <- tolower(names(cycle6_meds)) 

# Recode medication variables from medication data
cycle1_medication_data <- recodeflow::rec_with_table(cycle1_meds, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
cycle2_medication_data <- recodeflow::rec_with_table(cycle2_meds, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
cycle3_medication_data <- recodeflow::rec_with_table(cycle3_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle4_medication_data <- recodeflow::rec_with_table(cycle4_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle5_medication_data <- recodeflow::rec_with_table(cycle5_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle6_medication_data <- recodeflow::rec_with_table(cycle6_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
```

### Load overall data, flatten/merge medication data to overall data, and recode all variables from each cycle

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Load overall cycle data
cycle1 <- read_stata(config$data$cycle1)
cycle2 <- read_stata(config$data$cycle2)
cycle3 <- read_stata(config$data$cycle3)
cycle4 <- read_stata(config$data$cycle4)
cycle5 <- read_stata(config$data$cycle5)
cycle6 <- read_stata(config$data$cycle6)
names(cycle6) <- tolower(names(cycle6)) 

# Assign cycle variable to each cycle for imputation purposes
cycle1$cycle <- 1
cycle2$cycle <- 2
cycle3$cycle <- 3
cycle4$cycle <- 4
cycle5$cycle <- 5
cycle6$cycle <- 6

# Derive outcome medication criterion in medication data, and merge that data to overall cycle data
cycle1_medication_data$anymed2 <- as.numeric(as.character(cycle1_medication_data$anymed))
cycle2_medication_data$anymed2 <- as.numeric(as.character(cycle2_medication_data$anymed))

cycle1_medication_data$diab_drug2 <- as.numeric(as.character(cycle1_medication_data$diab_drug))
cycle2_medication_data$diab_drug2 <- as.numeric(as.character(cycle2_medication_data$diab_drug))

cycle1_medication_data <- dplyr::select(cycle1_medication_data, clinicid, anymed2, diab_drug2)
cycle2_medication_data <- dplyr::select(cycle2_medication_data, clinicid, anymed2, diab_drug2)

cycle1 <- merge(cycle1, cycle1_medication_data, by = "clinicid")
cycle2 <- merge(cycle2, cycle2_medication_data, by = "clinicid")
cycle3 <- process_long_medication_data(cycle3, cycle3_medication_data)
cycle4 <- process_long_medication_data(cycle4, cycle4_medication_data)
cycle5 <- process_long_medication_data(cycle5, cycle5_medication_data)
cycle6 <- process_long_medication_data(cycle6, cycle6_medication_data)

# Recode variables from each cycle
cycle1_data <- recodeflow::rec_with_table(cycle1, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle2_data <- recodeflow::rec_with_table(cycle2, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle3_data <- recodeflow::rec_with_table(cycle3, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle4_data <- recodeflow::rec_with_table(cycle4, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle5_data <- recodeflow::rec_with_table(cycle5, recodeflow:::select_vars_by_role(c("Recode"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle6_data <- recodeflow::rec_with_table(cycle6, recodeflow:::select_vars_by_role(c("Recode"), my_variables), variable_details = my_variable_details, log = TRUE)
```

### Combine cycles to obtain sample, and merge extra exercise data and bootstrap weights to the sample data

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Combine cycles to obtain sample
cycles1to6_data <- dplyr::bind_rows(cycle1_data, cycle2_data, cycle3_data, cycle4_data, cycle5_data, cycle6_data)
cycles1to6_data <- dplyr::filter(cycles1to6_data, insample == 1)

# Load and merge extra accelerometer data to sample data
tracey <- read_sas(config$data$tracey)
tracey$clinicid <-tracey$CLINICID
tracey$mvpa_min <- tracey$avg_mvpa
tracey$minperweek <- tracey$mvpa_min * 7
tracey <- subset(tracey, select = -c(CLINICID, avg_mvpa, adultPAG))

cycles1to6_data <- dplyr::left_join(cycles1to6_data, tracey, by = c("clinicid"))
cycles1to6_data <- cycles1to6_data %>%
  dplyr::mutate(mvpa_min = coalesce(mvpa_min.x, mvpa_min.y),
         minperweek = coalesce(minperweek.x, minperweek.y)) %>%
  dplyr::mutate(mvpa_min = ifelse(is.na(mvpa_min), haven::tagged_na("b"), mvpa_min),
         minperweek = ifelse(is.na(minperweek), haven::tagged_na("b"), minperweek)) %>%
  dplyr::select(c(clinicid, wgt_full, clc_sex, highbp14090, control14090, control14090_adj, recodeflow:::select_vars_by_role(c("imputation-predictor", "cali-subgroup"), my_variables)))
```

### Reobtain imputed data and bootstrap weights and segregrate such data by sex

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Impute data
imputed_cycles1to6_data <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))
imputed_cycles1to6_data$clinicid <- cycles1to6_data$clinicid

# Load bootstrap weights for all cycles and merge them to imputed sample data
cycles1to6_bsw <- read_stata(config$data$cycles1to6_bsw)
names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw))

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

# Synthetic dataset for test use outside RDC
# set.seed(123)
# imputed_cycles1to6_data <- data.frame(
#   highbp14090_adj = sample(1:2, 1000, replace = TRUE), # Binary hypertension outcome
#   highbp14090 = sample(1:2, 1000, replace = TRUE), # Binary unadjusted hypertension outcome
#   control14090_adj = sample(1:2, 1000, replace = TRUE), # Binary controlled hypertension outcome
#   control14090 = sample(1:2, 1000, replace = TRUE), # Binary controlled and unadjusted hypertension outcome
#   highbp13080_adj = sample(1:2, 1000, replace = TRUE), # Binary 130/80 hypertension outcome
#   ccc_51 = sample(1:2, 1000, replace = TRUE), # Binary self-reported diabetes
#   ckd = sample(1:2, 1000, replace = TRUE), # Binary chronic kidney disease
#   edudr04 = sample(1:3, 1000, replace = TRUE), # Categorical education
#   fmh_15 = sample(1:2, 1000, replace = TRUE), # Binary family history
#   gendmhi = sample(1:2, 1000, replace = TRUE), # Categorical self-rated mental health
#   gen_025 = sample(1:2, 1000, replace = TRUE), # Binary self-perceived stress
#   gen_045 = sample(1:2, 1000, replace = TRUE), # Binary sense of belonging
#   low_drink_score1 = sample(1:4, 1000, replace = TRUE), # Categorical alcohol consumption level
#   married = sample(1:3, 1000, replace = TRUE), # Categorical marital status
#   smoke = sample(1:3, 1000, replace = TRUE), # Categorical smoking status
#   working = sample(1:2, 1000, replace = TRUE), # Binary working status
#   clc_sex = sample(1:2, 1000, replace = TRUE), # Binary sex
#   wgt_full = runif(1000, 0, 1), # Numeric weights
#   clc_age = sample(20:79, 1000, replace = TRUE), # Integer age
#   hwmdbmi = runif(1000, 9.47, 56.77), # Numeric body mass index
#   minperweek = runif(1000, 0, 2004), # Numeric physical activity minutes
#   totalfv = runif(1000, 0, 20), # Numeric fruit and vegetable consumption
#   whr = runif(1000, 25, 100), # Numeric waist-to-height ratio
#   slp_11 = runif(1000, 2, 18), # Numeric sleep duration
#   diabx = sample(1:2, 1000, replace = TRUE), # Binary overall diabetes
#   cycle = sample(1:6, 1000, replace = TRUE), # Cycle variable ranging from 1 to 6
#   anymed2 = sample(0:1, 1000, replace = TRUE), # Binary HTN medication (derived)
#   ccc_32 = sample(1:2, 1000, replace = TRUE), # Binary HTN medication (self-reported)
#   cardiov = sample(1:2, 1000, replace = TRUE), # Binary CVD
#   adj_hh_inc = runif(1000, 20000, 150000), # Numeric income
#   agegroup4 = sample(1:4, 1000, replace = TRUE), # Categorical age group
#   alcdwky = sample(0:84, 1000, replace = TRUE), # Integer alcohol consumption per week
#   bmigroup = sample(1:4, 1000, replace = TRUE), # Categorical BMI group
#   gendhdi = sample(0:4, 1000, replace = TRUE), # Categorical self-rated health
#   gfr = runif(1000, 6, 240), # Numeric glomerular filtration rate
#   hwm_13kg = runif(1000, 42.0, 176.5), # Numeric weight in kg
#   hwm_14cx = runif(1000, 61.4, 162.5), # Numeric waist circumference in cm
#   img_03 = sample(1:2, 1000, replace = TRUE), # Binary immigration variable
#   lab_bpb = runif(1000, 0.009, 1.2), # Numeric blood lead measurement
#   lab_hba1 = runif(1000, 0.042, 0.130), # Numeric HbA1c
#   mvpa150wk = sample(1:2, 1000, replace = TRUE), # Binary moderate-vigorous activity
#   nonhdltodd = sample(1:2, 1000, replace = TRUE), # Binary non-HDL cholesterol
#   gooddiet = sample(1:2, 1000, replace = TRUE), # Binary poor diet indicator
#   pgdcgt = sample(1:13, 1000, replace = TRUE), # Categorical ethnicity
#   bsw1 = runif(1000, 0, 1), # Numeric bootstrap weights
#   bsw2 = runif(1000, 0, 1) # Numeric bootstrap weights
# )

# Truncate skewed continuous variables if necessary
imputed_cycles1to6_data <- truncate_skewed(imputed_cycles1to6_data)

# Recode 2s as 0s in binary predictors and factorize all categorical predictors
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                highbp14090 = ifelse(highbp14090 == 2, 0, highbp14090),
                control14090_adj = ifelse(control14090_adj == 2, 0, control14090_adj),
                highbp13080_adj = ifelse(highbp13080_adj == 2, 0, highbp13080_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

# Separate male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)
```

### Center and weight data

```{r, include = FALSE, warning = FALSE, message = FALSE}
# male
# -------- dummy variables --------
male_data <- step_dummy(male_data, cat_variables)

# -------- rcs --------
# age
k_age <- 4
rcs.fit <- rcs(male_data$clc_age, k_age)
knots_age <- attributes(rcs.fit)$parms # knot locations
# BMI
k_bmi <- 3
rcs.fit <- rcs(male_data$hwmdbmi, k_bmi)
knots_bmi <- attributes(rcs.fit)$parms # knot locations
# exercise
k_exercise <- 3
rcs.fit <- rcs(male_data$minperweek, k_exercise)
knots_exercise <- attributes(rcs.fit)$parms # knot locations
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
male_data <- step_rcs(male_data, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
male_data <- step_interaction(male_data, interaction_list)

# Apply survey weights to original data
male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

# Get weighted mean values from the ORIGINAL dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

means <- get_mean(weighted_male, vars_mean)

# centering vars in the ORIGINAL dataset
vars_center <- names(means)
male_data_c <- step_center(male_data, vars_center, means)

# Obtain weighted and centered full and reduced models
male_data_c <- male_data_c %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj)) %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data_c %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male_c <- male_data_c %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

# female
# -------- dummy variables --------
female_data <- step_dummy(female_data, cat_variables)

# -------- rcs --------
# age
k_age <- 4
rcs.fit <- rcs(female_data$clc_age, k_age)
knots_age <- attributes(rcs.fit)$parms # knot locations
# BMI
k_bmi <- 3
rcs.fit <- rcs(female_data$hwmdbmi, k_bmi)
knots_bmi <- attributes(rcs.fit)$parms # knot locations
# exercise
k_exercise <- 3
rcs.fit <- rcs(female_data$minperweek, k_exercise)
knots_exercise <- attributes(rcs.fit)$parms # knot locations
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
female_data <- step_rcs(female_data, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
female_data <- step_interaction(female_data, interaction_list)

# Apply survey weights to original data
female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

# Get weighted mean values from the ORIGINAL dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

means <- get_mean(weighted_female, vars_mean)

# centering vars in the ORIGINAL dataset
vars_center <- names(means)
female_data_c <- step_center(female_data, vars_center, means)

# Obtain weighted and centered full and reduced models
female_data_c <- female_data_c %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj)) %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data_c %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female_c <- female_data_c %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )
```

### Fit male and female models using weighted, centered male and female data.

```{r, warning = FALSE, message = FALSE}
# Fit male and female models
weighted_male_c$degf <- 68
male_model <- survey::svyglm(highbp14090_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + married_2_C + married_3_C + edudr04_1_C + edudr04_2_C + working_2_C + gendmhi_1_C + gen_025_2_C + gen_045_2_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + low_drink_score1_2_C + low_drink_score1_3_C + low_drink_score1_4_C + minperweek_rcs_1_C + minperweek_rcs_2_C + smoke_1_C + smoke_2_C + slp_11_C + totalfv_C + diabx_1_C + ckd_1_C + clc_age_rcs_1_by_gen_045_2_C + clc_age_rcs_2_by_gen_045_2_C + clc_age_rcs_3_by_gen_045_2_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_minperweek_rcs_1_C + 
clc_age_rcs_2_by_minperweek_rcs_1_C + clc_age_rcs_3_by_minperweek_rcs_1_C + 
clc_age_rcs_1_by_minperweek_rcs_2_C + clc_age_rcs_2_by_minperweek_rcs_2_C + 
clc_age_rcs_3_by_minperweek_rcs_2_C + clc_age_rcs_1_by_smoke_1_C + 
clc_age_rcs_2_by_smoke_1_C + clc_age_rcs_3_by_smoke_1_C + clc_age_rcs_1_by_smoke_2_C + clc_age_rcs_2_by_smoke_2_C + clc_age_rcs_3_by_smoke_2_C + 
clc_age_rcs_1_by_slp_11_C + clc_age_rcs_2_by_slp_11_C + clc_age_rcs_3_by_slp_11_C +
clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C + clc_age_rcs_1_by_ckd_1_C + clc_age_rcs_2_by_ckd_1_C + clc_age_rcs_3_by_ckd_1_C, design = weighted_male_c, family = quasibinomial())

weighted_female_c$degf <- 68
female_model <- survey::svyglm(highbp14090_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + married_2_C + married_3_C + edudr04_1_C + edudr04_2_C + working_2_C + gendmhi_1_C + gen_025_2_C + gen_045_2_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + low_drink_score1_2_C + low_drink_score1_3_C + low_drink_score1_4_C + minperweek_rcs_1_C + minperweek_rcs_2_C + smoke_1_C + smoke_2_C + slp_11_C + totalfv_C + diabx_1_C + ckd_1_C + clc_age_rcs_1_by_gen_045_2_C + clc_age_rcs_2_by_gen_045_2_C + clc_age_rcs_3_by_gen_045_2_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_minperweek_rcs_1_C + 
clc_age_rcs_2_by_minperweek_rcs_1_C + clc_age_rcs_3_by_minperweek_rcs_1_C + 
clc_age_rcs_1_by_minperweek_rcs_2_C + clc_age_rcs_2_by_minperweek_rcs_2_C + 
clc_age_rcs_3_by_minperweek_rcs_2_C + clc_age_rcs_1_by_smoke_1_C + 
clc_age_rcs_2_by_smoke_1_C + clc_age_rcs_3_by_smoke_1_C + clc_age_rcs_1_by_smoke_2_C + clc_age_rcs_2_by_smoke_2_C + clc_age_rcs_3_by_smoke_2_C + 
clc_age_rcs_1_by_slp_11_C + clc_age_rcs_2_by_slp_11_C + clc_age_rcs_3_by_slp_11_C +
clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C + clc_age_rcs_1_by_ckd_1_C + clc_age_rcs_2_by_ckd_1_C + clc_age_rcs_3_by_ckd_1_C, design = weighted_female_c, family = quasibinomial())
```

### Multicollinearity assessments and correlation matrices

```{r, warning = FALSE, message = FALSE}
# Obtain raw sex-specific data without transformations and centering
male_data_simple <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data_simple <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

# Multicollinearity assessment
simple_weighted_male <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = male_data
)

simple_weighted_female <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = female_data
)

calculate_simplified_vif(design = simple_weighted_male)
calculate_simplified_vif(design = simple_weighted_female)

# Correlation matrix
male_data_simple <- dplyr::select(male_data_simple, recodeflow:::select_vars_by_role(c("Predictor"), my_variables))
female_data_simple <- dplyr::select(female_data_simple, recodeflow:::select_vars_by_role(c("Predictor"), my_variables))

male_cor_mat <- cor(male_data_simple)
female_cor_mat <- cor(female_data_simple)

write.csv(male_cor_mat, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/Correlation Matrix/Male Correlation Matrix.csv")
write.csv(female_cor_mat, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/Correlation Matrix/Female Correlation Matrix.csv")
```

### Model specification

```{r, warning = FALSE, message = FALSE}
# Apply stepdown function to male and female models
# weighted_male_c$degf <- 68
# male_reduced_model <- stepdown(male_model, male_data_c)
# 
# weighted_female_c$degf <- 68
# female_reduced_model <- stepdown(female_model, female_data_c)

weighted_male_c$degf <- 68
male_reduced_model <- survey::svyglm(highbp14090_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + diabx_1_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C, design = weighted_male_c, family = quasibinomial())

weighted_female_c$degf <- 68
female_reduced_model <- survey::svyglm(highbp14090_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + diabx_1_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C, design = weighted_female_c, family = quasibinomial())
```

### Full model assessment for derivation sample

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for full models
male_predicted_probabilities <- generate_predicted_probabilities(male_model)
female_predicted_probabilities <- generate_predicted_probabilities(female_model)

# Calibration plots with performance metrics
calibration(male_predicted_probabilities, male_data$highbp14090_adj)
calibration(female_predicted_probabilities, female_data$highbp14090_adj)

# Calibration in-the-whole and across percentiles
compare_probs(male_data, male_predicted_probabilities)
compare_probs(female_data, female_predicted_probabilities)

# Plot cumulative frequency of predicted probabilities
plot(sort(male_predicted_probabilities), seq_along(male_predicted_probabilities), type = "s", col = "blue", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
plot(sort(female_predicted_probabilities), seq_along(female_predicted_probabilities), type = "s", col = "red", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")

# Predicted probability percentiles
percentiles <- 1:100

predicted_percentiles_full <- data.frame(
  percentile = percentiles,
  `predicted risk (male)` = quantile(male_predicted_probabilities, probs = percentiles / 100, na.rm = TRUE),
  `predicted risk (female)` = quantile(female_predicted_probabilities, probs = percentiles / 100, na.rm = TRUE)
)

write.csv(predicted_percentiles_full, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Full Model Predicted Percentiles.csv")
```

### Reduced model assessment for derivation sample

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for reduced models
male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model)

# Calibration plots with performance metrics
calibration(male_predicted_probabilities, male_data$highbp14090_adj)
calibration(female_predicted_probabilities, female_data$highbp14090_adj)

# Calibration in-the-whole and across percentiles
compare_probs(male_data, male_predicted_probabilities)
compare_probs(female_data, female_predicted_probabilities)

# Plot cumulative frequency of predicted probabilities
plot(sort(male_predicted_probabilities), seq_along(male_predicted_probabilities), type = "s", col = "blue", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
plot(sort(female_predicted_probabilities), seq_along(female_predicted_probabilities), type = "s", col = "red", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")

# Predicted probability percentiles
percentiles <- 1:100

predicted_percentiles_reduced <- data.frame(
  percentile = percentiles,
  `predicted risk (male)` = quantile(male_predicted_probabilities, probs = percentiles / 100, na.rm = TRUE),
  `predicted risk (female)` = quantile(female_predicted_probabilities, probs = percentiles / 100, na.rm = TRUE)
)

write.csv(predicted_percentiles_reduced, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Reduced Model Predicted Percentiles.csv")
```

### Full model assessment for bootstrap samples - BOOTSTRAP VALIDATION 1/2

```{r, warning = FALSE, message = FALSE}
# Perform bootstrapping for both male and female full models
n_bootstrap <- 1000  # Number of bootstrap resamples
set.seed(123)

# For male full model
bootstrap_results_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data), replace = TRUE)
  bootstrap_function(male_data, boot_indices, male_model)
}, simplify = FALSE)

# For female full model
bootstrap_results_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data), replace = TRUE)
  bootstrap_function(female_data, boot_indices, female_model)
}, simplify = FALSE)

# Aggregate and summarize results for male
nagelkerke_r2_male <- sapply(bootstrap_results_male, function(x) x$nagelkerke_r2)
brier_score_male <- sapply(bootstrap_results_male, function(x) x$brier_score)
auc_male <- sapply(bootstrap_results_male, function(x) x$auc_value)
auc_male_ci_lower <- sapply(bootstrap_results_male, function(x) x$auc_ci_lower)
auc_male_ci_upper <- sapply(bootstrap_results_male, function(x) x$auc_ci_upper)
auc_male_optimism <- sapply(bootstrap_results_male, function(x) x$auc_optimism)
ratio_90_10_male <- sapply(bootstrap_results_male, function(x) x$ratio_90_10)
ratio_95_5_male <- sapply(bootstrap_results_male, function(x) x$ratio_95_5)
relative_difference_overall_male <- sapply(bootstrap_results_male, function(x) x$relative_difference_overall)
calibration_slope_male <- sapply(bootstrap_results_male, function(x) x$calibration_slope)

# Aggregate and summarize results for female
nagelkerke_r2_female <- sapply(bootstrap_results_female, function(x) x$nagelkerke_r2)
brier_score_female <- sapply(bootstrap_results_female, function(x) x$brier_score)
auc_female <- sapply(bootstrap_results_female, function(x) x$auc_value)
auc_female_ci_lower <- sapply(bootstrap_results_female, function(x) x$auc_ci_lower)
auc_female_ci_upper <- sapply(bootstrap_results_female, function(x) x$auc_ci_upper)
auc_female_optimism <- sapply(bootstrap_results_female, function(x) x$auc_optimism)
ratio_90_10_female <- sapply(bootstrap_results_female, function(x) x$ratio_90_10)
ratio_95_5_female <- sapply(bootstrap_results_female, function(x) x$ratio_95_5)
relative_difference_overall_female <- sapply(bootstrap_results_female, function(x) x$relative_difference_overall)
calibration_slope_female <- sapply(bootstrap_results_female, function(x) x$calibration_slope)

# Combine into a data frame
results_summary <- data.frame(
  Metric = c("Mean Nagelkerke R²", "Mean Brier Score", "Mean AUC", "Mean AUC 95% CI Lower", "Mean AUC 95% CI Upper", "Mean AUC Optimism", "Mean 90:10 Predicted Ratio", "Mean 95:5 Predicted Ratio", "Mean Observed v. Predicted", "Mean Calibration Slope"),
  Male = c(mean(nagelkerke_r2_male), mean(brier_score_male), mean(auc_male),
           mean(auc_male_ci_lower), mean(auc_male_ci_upper), mean(auc_male_optimism),
           mean(ratio_90_10_male), mean(ratio_95_5_male), mean(relative_difference_overall_male), mean(calibration_slope_male)),
  Female = c(mean(nagelkerke_r2_female), mean(brier_score_female), mean(auc_female),
             mean(auc_female_ci_lower), mean(auc_female_ci_upper), mean(auc_female_optimism),
             mean(ratio_90_10_female), mean(ratio_95_5_female), mean(relative_difference_overall_female), mean(calibration_slope_female))
)

# Print the summary data frame
print(results_summary)

# Optimism-corrected AUCs and their 95% CIs
auc_male_corrected <- auc_male - auc_male_optimism
auc_female_corrected <- auc_female - auc_female_optimism

auc_male_corrected_ci <- quantile(auc_male_corrected, probs = c(0.025, 0.975))
auc_female_corrected_ci <- quantile(auc_female_corrected, probs = c(0.025, 0.975))

cat("Male Optimism-Corrected AUC:", round(mean(auc_male_corrected), 3),
    "\n95% CI:", round(auc_male_corrected_ci[1], 3), "-", round(auc_male_corrected_ci[2], 3), "\n\n")

cat("Female Optimism-Corrected AUC:", round(mean(auc_female_corrected), 3),
    "\n95% CI:", round(auc_female_corrected_ci[1], 3), "-", round(auc_female_corrected_ci[2], 3))
```

### Reduced model assessment for bootstrap samples - BOOTSTRAP VALIDATION 2/2

```{r, warning = FALSE, message = FALSE}
# Perform bootstrapping for both male and female reduced models
n_bootstrap <- 1000  # Number of bootstrap resamples
set.seed(123)

# For male reduced model
bootstrap_results_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data), replace = TRUE)
  bootstrap_function(male_data, boot_indices, male_reduced_model)
}, simplify = FALSE)

# For female reduced model
bootstrap_results_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data), replace = TRUE)
  bootstrap_function(female_data, boot_indices, female_reduced_model)
}, simplify = FALSE)

# Aggregate and summarize results for male
nagelkerke_r2_male <- sapply(bootstrap_results_male, function(x) x$nagelkerke_r2)
brier_score_male <- sapply(bootstrap_results_male, function(x) x$brier_score)
auc_male <- sapply(bootstrap_results_male, function(x) x$auc_value)
auc_male_ci_lower <- sapply(bootstrap_results_male, function(x) x$auc_ci_lower)
auc_male_ci_upper <- sapply(bootstrap_results_male, function(x) x$auc_ci_upper)
auc_male_optimism <- sapply(bootstrap_results_male, function(x) x$auc_optimism)
ratio_90_10_male <- sapply(bootstrap_results_male, function(x) x$ratio_90_10)
ratio_95_5_male <- sapply(bootstrap_results_male, function(x) x$ratio_95_5)
relative_difference_overall_male <- sapply(bootstrap_results_male, function(x) x$relative_difference_overall)
calibration_slope_male <- sapply(bootstrap_results_male, function(x) x$calibration_slope)

# Aggregate and summarize results for female
nagelkerke_r2_female <- sapply(bootstrap_results_female, function(x) x$nagelkerke_r2)
brier_score_female <- sapply(bootstrap_results_female, function(x) x$brier_score)
auc_female <- sapply(bootstrap_results_female, function(x) x$auc_value)
auc_female_ci_lower <- sapply(bootstrap_results_female, function(x) x$auc_ci_lower)
auc_female_ci_upper <- sapply(bootstrap_results_female, function(x) x$auc_ci_upper)
auc_female_optimism <- sapply(bootstrap_results_female, function(x) x$auc_optimism)
ratio_90_10_female <- sapply(bootstrap_results_female, function(x) x$ratio_90_10)
ratio_95_5_female <- sapply(bootstrap_results_female, function(x) x$ratio_95_5)
relative_difference_overall_female <- sapply(bootstrap_results_female, function(x) x$relative_difference_overall)
calibration_slope_female <- sapply(bootstrap_results_female, function(x) x$calibration_slope)

# Combine into a data frame
results_summary <- data.frame(
  Metric = c("Mean Nagelkerke R²", "Mean Brier Score", "Mean AUC", "Mean AUC 95% CI Lower", "Mean AUC 95% CI Upper", "Mean AUC Optimism", "Mean 90:10 Predicted Ratio", "Mean 95:5 Predicted Ratio", "Mean Observed v. Predicted", "Mean Calibration Slope"),
  Male = c(mean(nagelkerke_r2_male), mean(brier_score_male), mean(auc_male),
           mean(auc_male_ci_lower), mean(auc_male_ci_upper), mean(auc_male_optimism),
           mean(ratio_90_10_male), mean(ratio_95_5_male), mean(relative_difference_overall_male), mean(calibration_slope_male)),
  Female = c(mean(nagelkerke_r2_female), mean(brier_score_female), mean(auc_female),
             mean(auc_female_ci_lower), mean(auc_female_ci_upper), mean(auc_female_optimism),
             mean(ratio_90_10_female), mean(ratio_95_5_female), mean(relative_difference_overall_female), mean(calibration_slope_female))
)

# Print the summary data frame
print(results_summary)

# Optimism-corrected AUCs and their 95% CIs
auc_male_corrected <- auc_male - auc_male_optimism
auc_female_corrected <- auc_female - auc_female_optimism

auc_male_corrected_ci <- quantile(auc_male_corrected, probs = c(0.025, 0.975))
auc_female_corrected_ci <- quantile(auc_female_corrected, probs = c(0.025, 0.975))

cat("Male Optimism-Corrected AUC:", round(mean(auc_male_corrected), 3),
    "\n95% CI:", round(auc_male_corrected_ci[1], 3), "-", round(auc_male_corrected_ci[2], 3), "\n\n")

cat("Female Optimism-Corrected AUC:", round(mean(auc_female_corrected), 3),
    "\n95% CI:", round(auc_female_corrected_ci[1], 3), "-", round(auc_female_corrected_ci[2], 3))
```

### Calibration across subgroups for full models

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for full models
male_predicted_probabilities <- generate_predicted_probabilities(male_model)
female_predicted_probabilities <- generate_predicted_probabilities(female_model)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
subgroups <- subgroups[subgroups != "clc_age"]

# Initialize an empty list to store calibration results
male_calibration_results <- list()

# Define x-axis labels
subgroup_labels <- list(
  "adj_hh_inc" = "Adjusted household income ($)",
  "agegroup4" = "Age group",
  "alcdwky" = "Weekly alcohol consumption (drinks/week)",
  "ckd" = "Chronic kidney disease",
  "diabx" = "Diabetes",
  "edudr04" = "Highest education level",
  "fmh_15" = "Hypertension family history",
  "gendhdi" = "Self-rated health",
  "gendmhi" = "Self-rated mental health",
  "gen_025" = "Self-perceived stress",
  "gen_045" = "Sense of belonging",
  "gfr" = "Glomerular filtration rate (mL/min/1.73 m²)",
  "gooddiet" = "Diet level",
  "hwm_13kg" = "Weight (kg)",
  "hwm_14cx" = "Waist circumference (cm)",
  "hwmdbmi" = "Body mass index (kg/m²)",
  "img_03" = "Immigrant",
  "lab_bpb" = "Blood lead (µmol/L)",
  "lab_hba1" = "HbA1c",
  "low_drink_score1" = "Alcohol consumption level",
  "married" = "Marital status",
  "minperweek" = "Physical activity minutes (min/week)",
  "mvpa150wk" = "Physical activity level",
  "nonhdltodd" = "High cholesterol",
  "pgdcgt" = "Ethnicity",
  "slp_11" = "Sleep duration (hrs/night)",
  "smoke" = "Smoking status",
  "totalfv" = "Daily fruit and vegetable consumption (times/day)",
  "whr" = "Waist-to-height ratio (%)",
  "working" = "Working status"
)

# Define level labels for categorical variables
level_labels <- list(
  "agegroup4" = c("1" = "20-39 years", "2" = "40-59 years", "3" = "60-69 years", "4" = "70-79 years"),
  "married" = c("1" = "Married or common-law", "2" = "Widowed, separated, or divorced", "3" = "Single and never married"),
  "edudr04" = c("0" = "Post-secondary school", "1" = "Secondary school", "2" = "Less than secondary school"),
  "pgdcgt" = c("1" = "White", "2" = "Not white"),
  "img_03" = c("1" = "Yes", "2" = "No"),
  "working" = c("1" = "Has a job", "2" = "Does not have a job"),
  "gendhdi" = c("1" = "Poor or fair", "2" = "Good, very good, or excellent"),
  "gendmhi" = c("1" = "Poor or fair", "0" = "Good, very good, or excellent"),
  "gen_025" = c("1" = "Not at all to a bit", "2" = "Quite a bit or extremely"),
  "gen_045" = c("1" = "Strong", "2" = "Weak"),
  "fmh_15" = c("1" = "Yes", "0" = "No"),
  "diabx" = c("1" = "Yes", "0" = "No"),
  "ckd" = c("1" = "Yes", "0" = "No"),
  "low_drink_score1" = c("1" = "Never drank", "2" = "Low-risk drinker", "3" = "Moderate drinker", "4" = "Heavy drinker"),
  "smoke" = c("0" = "Never smoker", "1" = "Former smoker", "2" = "Current smoker"),
  "mvpa150wk" = c("1" = "Physically active", "2" = "Physically inactive"),
  "gooddiet" = c("1" = "Eats fruits/veg ≥5 times per day", "2" = "Eats fruits/veg <5 times per day"),
  "nonhdltodd" = c("1" = "Yes", "2" = "No")
)

for (subgroup in subgroups) {
  if (all(!is.na(male_data[[subgroup]]))) {
    male_calibration_results[[subgroup]] <- calibration(
      male_predicted_probabilities,
      male_data$highbp14090_adj,
      group = male_data[[subgroup]]
    )

    cal_result <- male_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
male_calibration_results

# Initialize an empty list to store calibration results
female_calibration_results <- list()

for (subgroup in subgroups) {
  if (all(!is.na(female_data[[subgroup]]))) {
    female_calibration_results[[subgroup]] <- calibration(
      female_predicted_probabilities,
      female_data$highbp14090_adj,
      group = female_data[[subgroup]]
    )

    cal_result <- female_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
female_calibration_results
```

### Calibration across subgroups for reduced models

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for reduced models
male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
subgroups <- subgroups[subgroups != "clc_age"]

# Initialize an empty list to store calibration results
male_calibration_results <- list()

for (subgroup in subgroups) {
  if (all(!is.na(male_data[[subgroup]]))) {
    male_calibration_results[[subgroup]] <- calibration(
      male_predicted_probabilities,
      male_data$highbp14090_adj,
      group = male_data[[subgroup]]
    )

    cal_result <- male_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
male_calibration_results

# Initialize an empty list to store calibration results
female_calibration_results <- list()

for (subgroup in subgroups) {
  if (all(!is.na(female_data[[subgroup]]))) {
    female_calibration_results[[subgroup]] <- calibration(
      female_predicted_probabilities,
      female_data$highbp14090_adj,
      group = female_data[[subgroup]]
    )

    cal_result <- female_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
female_calibration_results
```

### Model parameters

```{r, warning = FALSE, message = FALSE}
# Get beta coefficients and their standard errors for full models
male_full_betas <- extract_beta_coefs(male_model)
female_full_betas <- extract_beta_coefs(female_model)

# Get beta coefficients and their standard errors for reduced models
male_reduced_betas <- extract_beta_coefs(male_reduced_model)
female_reduced_betas <- extract_beta_coefs(female_reduced_model)

# Export beta coefficient tables as csv files
write.csv(male_full_betas, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Male Full Model Betas.csv")
write.csv(female_full_betas, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Female Full Model Betas.csv")

write.csv(male_reduced_betas, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Male Reduced Model Betas.csv")
write.csv(female_reduced_betas, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Female Reduced Model Betas.csv")

# Get bootstrap beta coefficients and their standard errors for full models
n_bootstrap <- 1000
set.seed(123)

bootstrap_coefs_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data_c), replace = TRUE)
  bootstrap_coefs(male_data_c, boot_indices, male_model)
}, simplify = FALSE)

coef_matrix_male <- do.call(rbind, bootstrap_coefs_male)
rownames(coef_matrix_male) <- paste0("bootstrap_", 1:n_bootstrap)

write.csv(coef_matrix_male, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Bootstrap Betas/Male Full Model Bootstrap Betas.csv", row.names = TRUE)

bootstrap_coefs_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data_c), replace = TRUE)
  bootstrap_coefs(female_data_c, boot_indices, female_model)
}, simplify = FALSE)

coef_matrix_female <- do.call(rbind, bootstrap_coefs_female)
rownames(coef_matrix_female) <- paste0("bootstrap_", 1:n_bootstrap)

write.csv(coef_matrix_female, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Bootstrap Betas/Female Full Model Bootstrap Betas.csv", row.names = TRUE)

# Get bootstrap beta coefficients and their standard errors for rediced models
bootstrap_coefs_male_reduced <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data_c), replace = TRUE)
  bootstrap_coefs(male_data_c, boot_indices, male_reduced_model)
}, simplify = FALSE)

coef_matrix_male_reduced <- do.call(rbind, bootstrap_coefs_male_reduced)
rownames(coef_matrix_male_reduced) <- paste0("bootstrap_", 1:n_bootstrap)

write.csv(coef_matrix_male_reduced, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Bootstrap Betas/Male Reduced Model Bootstrap Betas.csv", row.names = TRUE)

bootstrap_coefs_female_reduced <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data_c), replace = TRUE)
  bootstrap_coefs(female_data_c, boot_indices, female_reduced_model)
}, simplify = FALSE)

coef_matrix_female_reduced <- do.call(rbind, bootstrap_coefs_female_reduced)
rownames(coef_matrix_female_reduced) <- paste0("bootstrap_", 1:n_bootstrap)

write.csv(coef_matrix_female_reduced, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Bootstrap Betas/female Reduced Model Bootstrap Betas.csv", row.names = TRUE)

# Re-apply survey weights to male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

# Print weighted descriptives for each continuous variable
cont_variables <- c("clc_age", "hwmdbmi", "minperweek", "totalfv", "slp_11")

male_summary <- summarize_weighted(cont_variables, weighted_male, male_data)
female_summary <- summarize_weighted(cont_variables, weighted_female, female_data)

write.csv(male_summary, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/Male Continuous Descriptives.csv")
write.csv(female_summary, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/Female Continuous Descriptives.csv")

# Print knot locations of transformed continuous variables
rcspline.eval(x = weighted_male$variables$clc_age, nk = 4, knots.only = TRUE)
rcspline.eval(x = weighted_male$variables$hwmdbmi, nk = 3, knots.only = TRUE)
rcspline.eval(x = weighted_male$variables$minperweek, nk = 3, knots.only = TRUE)

rcspline.eval(x = weighted_female$variables$clc_age, nk = 4, knots.only = TRUE)
rcspline.eval(x = weighted_female$variables$hwmdbmi, nk = 3, knots.only = TRUE)
rcspline.eval(x = weighted_female$variables$minperweek, nk = 3, knots.only = TRUE)

# Print weighted means for each categorical variable level
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")

for (var in cat_variables) {
  var_data <- weighted_male$variables[[var]]  # Extract the variable
  
  # Calculate weighted frequencies
  freq_table <- survey::svytable(as.formula(paste0("~", var)), design = weighted_male)
  
  # Weighted mean (proportion for each category)
  weighted_mean <- freq_table / sum(freq_table)
  
  # Get all category names and exclude the lowest-numbered one
  categories <- names(weighted_mean)
  # reference_category <- min(as.numeric(categories))  # Find the lowest category
  # filtered_categories <- setdiff(categories, reference_category)  # Exclude it
  
  cat("\nVariable:", var, "\n")  # Print the variable name
  
  # Loop through remaining categories and print their proportions
  for (category in categories) {
    cat("  Category:", category, " - Weighted Mean:", round(weighted_mean[category], 4), "\n")
  }
}

for (var in cat_variables) {
  var_data <- weighted_female$variables[[var]]  # Extract the variable
  
  # Calculate weighted frequencies
  freq_table <- survey::svytable(as.formula(paste0("~", var)), design = weighted_female)
  
  # Weighted mean (proportion for each category)
  weighted_mean <- freq_table / sum(freq_table)
  
  # Get all category names and exclude the lowest-numbered one
  categories <- names(weighted_mean)
  # reference_category <- min(as.numeric(categories))  # Find the lowest category
  # filtered_categories <- setdiff(categories, reference_category)  # Exclude it
  
  cat("\nVariable:", var, "\n")  # Print the variable name
  
  # Loop through remaining categories and print their proportions
  for (category in categories) {
    cat("  Category:", category, " - Weighted Mean:", round(weighted_mean[category], 4), "\n")
  }
}
```

### Shap plot (male reduced model)

```{r, warning = FALSE, message = FALSE}
# Reset male data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

# Fit final reduced male model with glm to avoid errors
male_final_reduced_model <- glm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, family = quasibinomial(), data = male_data, weights = wgt_full)

# Predictors and outcome only
male_data <- male_data %>% 
  dplyr::select(clc_age, fmh_15, diabx, hwmdbmi)

# Create observation as a data frame. Feel free to change predictor values.
observation <- data.frame(
  clc_age = 74,         # 74-year old male
  fmh_15 = 0,           # Family history of hypertension absent
  hwmdbmi = 35.3,       # BMI = 35.3; Obese
  diabx = 1             # Diabetes present
)

# Ensure observation has the same structure and var order as male_data
observation <- observation[, names(male_data), drop = FALSE]

for (var in names(male_data)) {
  if (is.factor(male_data[[var]])) {
    # Convert to factor and ensure levels match male_data
    observation[[var]] <- factor(observation[[var]], levels = levels(male_data[[var]]))
  } else {
    # Convert to numeric for consistency
    observation[[var]] <- as.numeric(observation[[var]])
  }
}

# Create explainer object for model
male_explainer <- iml::Predictor$new(
   model = male_final_reduced_model,                               # Pass the model
   data = male_data,                                               # Pass the data
   y = male_data[["highbp14090_adj"]],                             # Indicate outcome
   type = "response"                                               # Return predicted probabilities )
)

# Compute and plot SHAP values
set.seed(123)
male_shap_values <- iml::Shapley$new(male_explainer, x.interest = observation)

shap_df <- as.data.frame(male_shap_values$results) %>%
  mutate(
    std.err = sqrt(phi.var) / sqrt(100),  # Individual SE based on MC sampling
    feature = reorder(feature, phi)       # Reorder for plotting
  )

shap_df %>%
  mutate(feature = reorder(feature, phi)) %>%
  ggplot(aes(x = phi, y = feature)) +
  geom_bar(stat = "identity", fill = "grey30") +
  geom_errorbarh(aes(xmin = phi - std.err, xmax = phi + std.err), height = 0.2) +
  labs(
    x = "SHAP value",
    y = NULL,
    title = paste0("Actual prediction: ", round((100 * male_shap_values$y.hat.interest), 2),
                   "\nAverage prediction: ", round((100 * male_shap_values$y.hat.average), 2))
  ) +
  theme_minimal()

as.data.frame(shap_df) %>%
  arrange(desc(phi)) %>%
  select(feature.value, phi, std.err)
```

### Sensitivity analyses (missing data)

```{r, warning = FALSE, message = FALSE}
# Merge bootstrap weights to unimputed sample data, which is then recoded, segregated, and weighted
unimputed_cycles1to6_data <- dplyr::left_join(cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

unimputed_cycles1to6_data <- truncate_skewed(unimputed_cycles1to6_data)

unimputed_cycles1to6_data <- unimputed_cycles1to6_data %>%
  dplyr::mutate(across(everything(), ~ ifelse(. %in% c("NA(a)", "NA(b)", "NA(c)"), NA, .))) %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

unimputed_cycles1to6_data <- unimputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

unimputed_male_data <- dplyr::filter(unimputed_cycles1to6_data, clc_sex == 1)
unimputed_female_data <- dplyr::filter(unimputed_cycles1to6_data, clc_sex == 2)

unimputed_weighted_male <- unimputed_male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

unimputed_weighted_female <- unimputed_female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

# Fit full male and female models with unimputed data and see effect
unimputed_weighted_male$degf <- 68
unimputed_male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = unimputed_weighted_male, family = quasibinomial())

unimputed_weighted_female$degf <- 68
unimputed_female_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = unimputed_weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(unimputed_male_model)
female_predicted_probabilities <- generate_predicted_probabilities(unimputed_female_model)

calibration(male_predicted_probabilities, model.frame(unimputed_male_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(unimputed_female_model)$highbp14090_adj)

# Fit reduced male and female models with unimputed data and see effect
unimputed_weighted_male$degf <- 68
unimputed_male_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = unimputed_weighted_male, family = quasibinomial())

unimputed_weighted_female$degf <- 68
unimputed_female_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = unimputed_weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(unimputed_male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(unimputed_female_reduced_model)

calibration(male_predicted_probabilities, model.frame(unimputed_male_reduced_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(unimputed_female_reduced_model)$highbp14090_adj)
```

### Sensitivity analyses (outliers)

```{r, warning = FALSE, message = FALSE}
# Reobtain imputed data and centered objects but don't truncate anything
imputed_cycles1to6_data <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))
imputed_cycles1to6_data$clinicid <- cycles1to6_data$clinicid

names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw))

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

cont_variables <- c("clc_age",  "hwmdbmi", "minperweek", "totalfv", "slp_11")

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}

# Fit full male and female models with outliers and see effect
weighted_male$degf <- 68
untruncated_male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
untruncated_female_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(untruncated_male_model)
female_predicted_probabilities <- generate_predicted_probabilities(untruncated_female_model)

calibration(male_predicted_probabilities, model.frame(untruncated_male_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(untruncated_female_model)$highbp14090_adj)

# Fit reduced male and female models with outliers and see effect
weighted_male$degf <- 68
untruncated_male_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
untruncated_female_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(untruncated_male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(untruncated_female_reduced_model)

calibration(male_predicted_probabilities, model.frame(untruncated_male_reduced_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(untruncated_female_reduced_model)$highbp14090_adj)
```

### Sensitivity analyses (BMI and WHR together)

```{r, warning = FALSE, message = FALSE}
# Reobtain imputed, truncated data and centered objects
imputed_cycles1to6_data <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))
imputed_cycles1to6_data$clinicid <- cycles1to6_data$clinicid

names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw))

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

imputed_cycles1to6_data <- truncate_skewed(imputed_cycles1to6_data)

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}

# Fit full male and female models with WHR and its interactions re-included and see effect
weighted_male$degf <- 68
male_model_whr <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_model_whr <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), design = weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(male_model_whr)
female_predicted_probabilities <- generate_predicted_probabilities(female_model_whr)

calibration(male_predicted_probabilities, model.frame(male_model_whr)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_model_whr)$highbp14090_adj)
```

### Sensitivity analysis (linear interactions)

```{r, warning = FALSE, message = FALSE}
# Reset male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))
female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

# Fit full models with linear interactions and see effect
male_final_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + clc_age*gen_045 + clc_age*hwmdbmi + clc_age*minperweek + clc_age*smoke + clc_age*slp_11 + clc_age*diabx + clc_age*ckd, data = male_data, family = binomial(), weights = wgt_full)

female_final_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + clc_age*gen_045 + clc_age*hwmdbmi + clc_age*minperweek + clc_age*smoke + clc_age*slp_11 + clc_age*diabx + clc_age*ckd, data = female_data, family = binomial(), weights = wgt_full)

male_predicted_probabilities <- generate_predicted_probabilities(male_final_model_linint)
female_predicted_probabilities <- generate_predicted_probabilities(female_final_model_linint)

calibration(male_predicted_probabilities, model.frame(male_final_model_linint)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_final_model_linint)$highbp14090_adj)

# Fit reduced models with linear interactions and see effect
male_final_reduced_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + clc_age*hwmdbmi + clc_age*diabx, family = quasibinomial(), data = male_data, weights = wgt_full)

female_final_reduced_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + clc_age*hwmdbmi + clc_age*diabx, family = quasibinomial(), data = female_data, weights = wgt_full)

male_predicted_probabilities <- generate_predicted_probabilities(male_final_reduced_model_linint)
female_predicted_probabilities <- generate_predicted_probabilities(female_final_reduced_model_linint)

calibration(male_predicted_probabilities, model.frame(male_final_reduced_model_linint)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_final_reduced_model_linint)$highbp14090_adj)
```

### Sensitivity analyses (unadjusted BPs)

```{r, warning = FALSE, message = FALSE}
# Fit full male and female models with unadjusted BPs and see effect
weighted_male$degf <- 68
male_model_unadj <- survey::svyglm(highbp14090 ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_model_unadj <- survey::svyglm(highbp14090 ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female, family = quasibinomial())

male_predicted_probabilities_unadj_full <- generate_predicted_probabilities(male_model_unadj)
female_predicted_probabilities_unadj_full <- generate_predicted_probabilities(female_model_unadj)

calibration(male_predicted_probabilities_unadj_full, model.frame(male_model_unadj)$highbp14090)
calibration(female_predicted_probabilities_unadj_full, model.frame(female_model_unadj)$highbp14090)

# Fit reduced male and female models with unadjusted BPs and see effect
weighted_male$degf <- 68
male_reduced_model_unadj <- survey::svyglm(highbp14090 ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_reduced_model_unadj <- survey::svyglm(highbp14090 ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female, family = quasibinomial())

male_predicted_probabilities_unadj_reduced <- generate_predicted_probabilities(male_reduced_model_unadj)
female_predicted_probabilities_unadj_reduced <- generate_predicted_probabilities(female_reduced_model_unadj)

calibration(male_predicted_probabilities_unadj_reduced, model.frame(male_reduced_model_unadj)$highbp14090)
calibration(female_predicted_probabilities_unadj_reduced, model.frame(female_reduced_model_unadj)$highbp14090)

# Get predicted probabilities for models with adjusted BPs
male_predicted_probabilities_adj_full <- generate_predicted_probabilities(male_model)
female_predicted_probabilities_adj_full <- generate_predicted_probabilities(female_model)
male_predicted_probabilities_adj_reduced <- generate_predicted_probabilities(male_reduced_model)
female_predicted_probabilities_adj_reduced <- generate_predicted_probabilities(female_reduced_model)

# Plot cumulative frequency of predicted probabilities (unadjusted BPs vs. adjusted BPs)
# Full models
plot(sort(male_predicted_probabilities_unadj_full), seq_along(male_predicted_probabilities_unadj_full), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(male_predicted_probabilities_adj_full), seq_along(male_predicted_probabilities_adj_full), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Unadjusted BP", "Adjusted BP"), col = c("black", "blue"), lwd = 2)

plot(sort(female_predicted_probabilities_unadj_full), seq_along(female_predicted_probabilities_unadj_full), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(female_predicted_probabilities_adj_full), seq_along(female_predicted_probabilities_adj_full), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Unadjusted BP", "Adjusted BP"), col = c("black", "blue"), lwd = 2)

# Reduced models
plot(sort(male_predicted_probabilities_unadj_reduced), seq_along(male_predicted_probabilities_unadj_reduced), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(male_predicted_probabilities_adj_reduced), seq_along(male_predicted_probabilities_adj_reduced), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Unadjusted BP", "Adjusted BP"), col = c("black", "blue"), lwd = 2)

plot(sort(female_predicted_probabilities_unadj_reduced), seq_along(female_predicted_probabilities_unadj_reduced), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(female_predicted_probabilities_adj_reduced), seq_along(female_predicted_probabilities_adj_reduced), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Unadjusted BP", "Adjusted BP"), col = c("black", "blue"), lwd = 2)
```

### Sensitivity analyses (uncontrolled HTN only)

```{r, warning = FALSE, message = FALSE}
# Exclude those who have controlled HTN and recreate centered weighted objects
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::filter(control14090_adj != 1 | control14090 != 1)

male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}

# Fit full male and female models with uncontrolled HTN and see effect
weighted_male$degf <- 68
male_model_uncontrolled <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_model_uncontrolled <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female, family = quasibinomial())

male_predicted_probabilities_uncontrolled <- generate_predicted_probabilities(male_model_uncontrolled)
female_predicted_probabilities_uncontrolled <- generate_predicted_probabilities(female_model_uncontrolled)

calibration(male_predicted_probabilities_uncontrolled, model.frame(male_model_uncontrolled)$highbp14090_adj)
calibration(female_predicted_probabilities_uncontrolled, model.frame(female_model_uncontrolled)$highbp14090_adj)

# Fit reduced male and female models with uncontrolled HTN and see effect
weighted_male$degf <- 68
male_reduced_model_uncontrolled <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_reduced_model_uncontrolled <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female, family = quasibinomial())

male_predicted_probabilities_uncontrolled_reduced <- generate_predicted_probabilities(male_reduced_model_uncontrolled)
female_predicted_probabilities_uncontrolled_reduced <- generate_predicted_probabilities(female_reduced_model_uncontrolled)

calibration(male_predicted_probabilities_uncontrolled_reduced, model.frame(male_reduced_model_uncontrolled)$highbp14090_adj)
calibration(female_predicted_probabilities_uncontrolled_reduced, model.frame(female_reduced_model_uncontrolled)$highbp14090_adj)

# Get predicted probabilities for models using both types of HTN
male_predicted_probabilities_both_full <- generate_predicted_probabilities(male_model)
female_predicted_probabilities_both_full <- generate_predicted_probabilities(female_model)
male_predicted_probabilities_both_reduced <- generate_predicted_probabilities(male_reduced_model)
female_predicted_probabilities_both_reduced <- generate_predicted_probabilities(female_reduced_model)

# Plot cumulative frequency of predicted probabilities (uncontrolled HTN only vs. uncontrolled + controlled HTN)
# Full models
plot(sort(male_predicted_probabilities_uncontrolled), seq_along(male_predicted_probabilities_uncontrolled), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency", ylim = range(c(seq_along(male_predicted_probabilities_uncontrolled), seq_along(male_predicted_probabilities_both_full))))
lines(sort(male_predicted_probabilities_both_full), seq_along(male_predicted_probabilities_both_full), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Uncontrolled HTN", "Uncontrolled + Controlled HTN"), col = c("black", "blue"), lwd = 2)

plot(sort(female_predicted_probabilities_uncontrolled), seq_along(female_predicted_probabilities_uncontrolled), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency", ylim = range(c(seq_along(female_predicted_probabilities_uncontrolled), seq_along(female_predicted_probabilities_both_full))))
lines(sort(female_predicted_probabilities_both_full), seq_along(female_predicted_probabilities_both_full), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Uncontrolled HTN", "Uncontrolled + Controlled HTN"), col = c("black", "blue"), lwd = 2)

# Reduced models
plot(sort(male_predicted_probabilities_uncontrolled_reduced), seq_along(male_predicted_probabilities_uncontrolled_reduced), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency", ylim = range(c(seq_along(male_predicted_probabilities_uncontrolled_reduced), seq_along(male_predicted_probabilities_both_reduced))))
lines(sort(male_predicted_probabilities_both_reduced), seq_along(male_predicted_probabilities_both_reduced), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Uncontrolled HTN", "Uncontrolled + Controlled HTN"), col = c("black", "blue"), lwd = 2)

plot(sort(female_predicted_probabilities_uncontrolled_reduced), seq_along(female_predicted_probabilities_uncontrolled_reduced), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency", ylim = range(c(seq_along(female_predicted_probabilities_uncontrolled_reduced), seq_along(female_predicted_probabilities_both_reduced))))
lines(sort(female_predicted_probabilities_both_reduced), seq_along(female_predicted_probabilities_both_reduced), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("Uncontrolled HTN", "Uncontrolled + Controlled HTN"), col = c("black", "blue"), lwd = 2)
```

### Sensitivity analyses (new HTN)

```{r, warning = FALSE, message = FALSE}
# Fit full male and female models with new HTN and see effect
# Fit male and female models
weighted_male_c$degf <- 68
male_model_new <- survey::svyglm(highbp13080_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + married_2_C + married_3_C + edudr04_1_C + edudr04_2_C + working_2_C + gendmhi_1_C + gen_025_2_C + gen_045_2_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + low_drink_score1_2_C + low_drink_score1_3_C + low_drink_score1_4_C + minperweek_rcs_1_C + minperweek_rcs_2_C + smoke_1_C + smoke_2_C + slp_11_C + totalfv_C + diabx_1_C + ckd_1_C + clc_age_rcs_1_by_gen_045_2_C + clc_age_rcs_2_by_gen_045_2_C + clc_age_rcs_3_by_gen_045_2_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_minperweek_rcs_1_C + 
clc_age_rcs_2_by_minperweek_rcs_1_C + clc_age_rcs_3_by_minperweek_rcs_1_C + 
clc_age_rcs_1_by_minperweek_rcs_2_C + clc_age_rcs_2_by_minperweek_rcs_2_C + 
clc_age_rcs_3_by_minperweek_rcs_2_C + clc_age_rcs_1_by_smoke_1_C + 
clc_age_rcs_2_by_smoke_1_C + clc_age_rcs_3_by_smoke_1_C + clc_age_rcs_1_by_smoke_2_C + clc_age_rcs_2_by_smoke_2_C + clc_age_rcs_3_by_smoke_2_C + 
clc_age_rcs_1_by_slp_11_C + clc_age_rcs_2_by_slp_11_C + clc_age_rcs_3_by_slp_11_C +
clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C + clc_age_rcs_1_by_ckd_1_C + clc_age_rcs_2_by_ckd_1_C + clc_age_rcs_3_by_ckd_1_C, design = weighted_male_c, family = quasibinomial())

weighted_female_c$degf <- 68
female_model_new <- survey::svyglm(highbp13080_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + married_2_C + married_3_C + edudr04_1_C + edudr04_2_C + working_2_C + gendmhi_1_C + gen_025_2_C + gen_045_2_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + low_drink_score1_2_C + low_drink_score1_3_C + low_drink_score1_4_C + minperweek_rcs_1_C + minperweek_rcs_2_C + smoke_1_C + smoke_2_C + slp_11_C + totalfv_C + diabx_1_C + ckd_1_C + clc_age_rcs_1_by_gen_045_2_C + clc_age_rcs_2_by_gen_045_2_C + clc_age_rcs_3_by_gen_045_2_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_minperweek_rcs_1_C + 
clc_age_rcs_2_by_minperweek_rcs_1_C + clc_age_rcs_3_by_minperweek_rcs_1_C + 
clc_age_rcs_1_by_minperweek_rcs_2_C + clc_age_rcs_2_by_minperweek_rcs_2_C + 
clc_age_rcs_3_by_minperweek_rcs_2_C + clc_age_rcs_1_by_smoke_1_C + 
clc_age_rcs_2_by_smoke_1_C + clc_age_rcs_3_by_smoke_1_C + clc_age_rcs_1_by_smoke_2_C + clc_age_rcs_2_by_smoke_2_C + clc_age_rcs_3_by_smoke_2_C + 
clc_age_rcs_1_by_slp_11_C + clc_age_rcs_2_by_slp_11_C + clc_age_rcs_3_by_slp_11_C +
clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C + clc_age_rcs_1_by_ckd_1_C + clc_age_rcs_2_by_ckd_1_C + clc_age_rcs_3_by_ckd_1_C, design = weighted_female_c, family = quasibinomial())

male_predicted_probabilities_new_full <- generate_predicted_probabilities(male_model_new)
female_predicted_probabilities_new_full <- generate_predicted_probabilities(female_model_new)

calibration(male_predicted_probabilities_new_full, model.frame(male_model_new)$highbp13080_adj)
calibration(female_predicted_probabilities_new_full, model.frame(female_model_new)$highbp13080_adj)

# Fit reduced male and female models with new HTN and see effect
weighted_male_c$degf <- 68
male_reduced_model_new <- survey::svyglm(highbp13080_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + diabx_1_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C, design = weighted_male_c, family = quasibinomial())

weighted_female_c$degf <- 68
female_reduced_model_new <- survey::svyglm(highbp13080_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + diabx_1_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C, design = weighted_female_c, family = quasibinomial())

male_predicted_probabilities_new_reduced <- generate_predicted_probabilities(male_reduced_model_new)
female_predicted_probabilities_new_reduced <- generate_predicted_probabilities(female_reduced_model_new)

calibration(male_predicted_probabilities_new_reduced, model.frame(male_reduced_model_new)$highbp13080_adj)
calibration(female_predicted_probabilities_new_reduced, model.frame(female_reduced_model_new)$highbp13080_adj)

# Get predicted probabilities for models with old HTN
male_predicted_probabilities_old_full <- generate_predicted_probabilities(male_model)
female_predicted_probabilities_old_full <- generate_predicted_probabilities(female_model)
male_predicted_probabilities_old_reduced <- generate_predicted_probabilities(male_reduced_model)
female_predicted_probabilities_old_reduced <- generate_predicted_probabilities(female_reduced_model)

# Plot cumulative frequency of predicted probabilities (newusted BPs vs. oldusted BPs)
# Full models
plot(sort(male_predicted_probabilities_new_full), seq_along(male_predicted_probabilities_new_full), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(male_predicted_probabilities_old_full), seq_along(male_predicted_probabilities_old_full), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("130/80", "140/90"), col = c("black", "blue"), lwd = 2)

plot(sort(female_predicted_probabilities_new_full), seq_along(female_predicted_probabilities_new_full), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(female_predicted_probabilities_old_full), seq_along(female_predicted_probabilities_old_full), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("130/80", "140/90"), col = c("black", "blue"), lwd = 2)

# Reduced models
plot(sort(male_predicted_probabilities_new_reduced), seq_along(male_predicted_probabilities_new_reduced), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(male_predicted_probabilities_old_reduced), seq_along(male_predicted_probabilities_old_reduced), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("130/80", "140/90"), col = c("black", "blue"), lwd = 2)

plot(sort(female_predicted_probabilities_new_reduced), seq_along(female_predicted_probabilities_new_reduced), type = "s", col = "black", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
lines(sort(female_predicted_probabilities_old_reduced), seq_along(female_predicted_probabilities_old_reduced), type = "s", col = "blue", lwd = 2)
legend("bottomright", legend = c("130/80", "140/90"), col = c("black", "blue"), lwd = 2)
```

### Validation data with components separated and prediction values:

Comment out male knots and means, and uncomment female knots and means to switch.

```{r, warning = FALSE, message = FALSE}
set.seed(123)
male_validation_data <- data.frame(
  clc_age = sample(20:79, 10000, replace = TRUE),
  married = factor(sample(1:3, 10000, replace = TRUE)),
  edudr04 = factor(sample(0:2, 10000, replace = TRUE)),
  working = factor(sample(1:2, 10000, replace = TRUE)),
  gendmhi = factor(sample(0:1, 10000, replace = TRUE)),
  gen_025 = factor(sample(1:2, 10000, replace = TRUE)),
  gen_045 = factor(sample(1:2, 10000, replace = TRUE)),
  fmh_15 = factor(sample(0:1, 10000, replace = TRUE)),
  hwmdbmi = runif(10000, 13.8, 49),
  low_drink_score1 = factor(sample(1:4, 10000, replace = TRUE)),
  minperweek = runif(10000, 0, 795),
  smoke = factor(sample(0:2, 10000, replace = TRUE)),
  slp_11 = runif(10000, 2, 18),
  totalfv = runif(10000, 0, 10),
  diabx = factor(sample(0:1, 10000, replace = TRUE)),
  ckd = factor(sample(0:1, 10000, replace = TRUE))
)

# -------- dummy variables --------
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
male_validation_data <- step_dummy(male_validation_data, cat_variables)

# -------- rcs --------
# age
knots_age <- c(24, 40, 57, 74) # male
# knots_age <- c(25, 40, 57, 75) # female
# BMI
knots_bmi <- c(22.35, 27.24, 34.178) # male
# knots_bmi <- c(20.69, 26.23, 36.141) # female
# exercise
knots_exercise <- c(9, 103, 326) # male
# knots_exercise <- c(1, 89, 290) # female
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
male_validation_data <- step_rcs(male_validation_data, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
male_validation_data <- step_interaction(male_validation_data, interaction_list)

# Get weighted mean values from the dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

# male
means <- c(
  46.14509835, 10.41999141, 2.012829724, 0.085947731, 0.248462597,
  0.217177205, 0.125063569, 0.258671725, 0.066840869, 0.228373362,
  0.349876734, 0.524803077, 27.66777298, 2.529042313, 0.777985051,
  0.045626893, 0.072198781, 147.6496834, 53.84564875, 0.308696985,
  0.227724746, 7.015035776, 3.280091672, 0.104918358, 0.044784256,
  15.14081401, 2.855721362, 0.518839488, 1289.586153, 294.9641651,
  56.95945766, 121.6744825, 28.59310879, 5.458573727, 6383.426259,
  1151.285813, 200.1725572, 2295.79088, 396.7168969, 67.65261735,
  16.42423635, 4.962600721, 1.036863773, 9.689177061, 1.65996114,
  0.282951234, 323.9788677, 74.51391132, 14.59326186, 6.145555691,
  2.19318601, 0.472921201, 2.811431457, 1.26078209, 0.307342769
)

# female
# means <- c(
#   46.89545843, 10.12555934, 2.151608321, 0.147107554, 0.210100305,
#   0.193357648, 0.099653209, 0.353413901, 0.088527417, 0.257966189,
#   0.342661718, 0.573552958, 27.0963796, 2.687938152, 0.753166452,
#   0.03853446, 0.03202675, 126.2691998, 49.59317196, 0.272198263,
#   0.165152547, 7.176308826, 3.700420139, 0.073367263, 0.057604582,
#   15.29680233, 2.877391597, 0.572698397, 1285.110359, 282.7253824,
#   60.12236359, 131.3924734, 29.62929288, 6.184663944, 5569.647047,
#   972.9401839, 186.0587491, 2174.213295, 375.6339899, 70.87545919,
#   14.19872096, 3.733773656, 0.824769535, 7.276738258, 1.206667012,
#   0.221478809, 336.01649, 73.01912727, 15.59617795, 4.268397084,
#   1.361402486, 0.314536375, 3.693735889, 1.553035432, 0.402545106
# )

# centering vars in the dataset
names(means) <- vars_mean
vars_center <- names(means)
male_validation_data <- step_center(male_validation_data, vars_center, means)

# Add centered model predictions to dataset
male_validation_data$full_predicted <- predict(male_model, newdata = male_validation_data, type = "response")
male_validation_data$reduced_predicted <- predict(male_reduced_model, newdata = male_validation_data, type = "response")
write.csv(male_validation_data, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Validation Data/Male Validation Data.csv", row.names = TRUE)
```

### Vascular age

```{r, warning = FALSE, message = FALSE}
# Predict HTN for all respondents in development data
male_data_c$full_predicted <- predict(male_model, newdata = male_data_c, type = "response")
female_data_c$full_predicted <- predict(female_model, newdata = female_data_c, type = "response")
male_data_c$reduced_predicted <- predict(male_reduced_model, newdata = male_data_c, type = "response")
female_data_c$reduced_predicted <- predict(female_reduced_model, newdata = female_data_c, type = "response")

# For 1-year age and sex strata, calculate: mean prediction, SD, median, IQR.
male_summary_1yr <- male_data_c %>%
  group_by(clc_age) %>%
  summarise(
    mean_pred_full = mean(full_predicted),
    sd_pred_full = sd(full_predicted),
    median_pred_full = median(full_predicted),
    iqr_pred_full = IQR(full_predicted),
    mean_pred_reduced = mean(reduced_predicted),
    sd_pred_reduced = sd(reduced_predicted),
    median_pred_reduced = median(reduced_predicted),
    iqr_pred_reduced = IQR(reduced_predicted)
  )

female_summary_1yr <- female_data_c %>%
  group_by(clc_age) %>%
  summarise(
    mean_pred_full = mean(full_predicted),
    sd_pred_full = sd(full_predicted),
    median_pred_full = median(full_predicted),
    iqr_pred_full = IQR(full_predicted),
    mean_pred_reduced = mean(reduced_predicted),
    sd_pred_reduced = sd(reduced_predicted),
    median_pred_reduced = median(reduced_predicted),
    iqr_pred_reduced = IQR(reduced_predicted)
  )

write.csv(male_summary_1yr, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Vascular Age/Male Vascular Age - 1 yr.csv", row.names = TRUE)
write.csv(female_summary_1yr, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Vascular Age/Female Vascular Age - 1 yr.csv", row.names = TRUE)

# For 5-year age and sex strata, calculate mean prediction, SD, and then min, max and percentiles.
male_data_c$age_group_5yr <- cut(male_data_c$clc_age, breaks = seq(20, 80, by = 5), right = FALSE)
female_data_c$age_group_5yr <- cut(female_data_c$clc_age, breaks = seq(20, 80, by = 5), right = FALSE)

percentiles <- c(0.05, 0.10, 0.20, 0.25, 0.30, 0.40, 0.50, 0.60, 0.75, 0.80, 0.90, 0.95)

male_summary_5yr <- male_data_c %>%
  group_by(age_group_5yr) %>%
  summarise(
    mean_pred_full = mean(full_predicted),
    sd_pred_full = sd(full_predicted),
    min_pred_full = min(full_predicted),
    max_pred_full = max(full_predicted),
    p05_full = quantile(full_predicted, 0.05),
    p10_full = quantile(full_predicted, 0.10),
    p20_full = quantile(full_predicted, 0.20),
    p25_full = quantile(full_predicted, 0.25),
    p30_full = quantile(full_predicted, 0.30),
    p40_full = quantile(full_predicted, 0.40),
    p50_full = quantile(full_predicted, 0.50),
    p60_full = quantile(full_predicted, 0.60),
    p75_full = quantile(full_predicted, 0.75),
    p80_full = quantile(full_predicted, 0.80),
    p90_full = quantile(full_predicted, 0.90),
    p95_full = quantile(full_predicted, 0.95),
    mean_pred_reduced = mean(reduced_predicted),
    sd_pred_reduced = sd(reduced_predicted),
    min_pred_reduced = min(reduced_predicted),
    max_pred_reduced = max(reduced_predicted),
    p05_reduced = quantile(reduced_predicted, 0.05),
    p10_reduced = quantile(reduced_predicted, 0.10),
    p20_reduced = quantile(reduced_predicted, 0.20),
    p25_reduced = quantile(reduced_predicted, 0.25),
    p30_reduced = quantile(reduced_predicted, 0.30),
    p40_reduced = quantile(reduced_predicted, 0.40),
    p50_reduced = quantile(reduced_predicted, 0.50),
    p60_reduced = quantile(reduced_predicted, 0.60),
    p75_reduced = quantile(reduced_predicted, 0.75),
    p80_reduced = quantile(reduced_predicted, 0.80),
    p90_reduced = quantile(reduced_predicted, 0.90),
    p95_reduced = quantile(reduced_predicted, 0.95)
  )

female_summary_5yr <- female_data_c %>%
  group_by(age_group_5yr) %>%
  summarise(
    mean_pred_full = mean(full_predicted),
    sd_pred_full = sd(full_predicted),
    min_pred_full = min(full_predicted),
    max_pred_full = max(full_predicted),
    p05_full = quantile(full_predicted, 0.05),
    p10_full = quantile(full_predicted, 0.10),
    p20_full = quantile(full_predicted, 0.20),
    p25_full = quantile(full_predicted, 0.25),
    p30_full = quantile(full_predicted, 0.30),
    p40_full = quantile(full_predicted, 0.40),
    p50_full = quantile(full_predicted, 0.50),
    p60_full = quantile(full_predicted, 0.60),
    p75_full = quantile(full_predicted, 0.75),
    p80_full = quantile(full_predicted, 0.80),
    p90_full = quantile(full_predicted, 0.90),
    p95_full = quantile(full_predicted, 0.95),
    mean_pred_reduced = mean(reduced_predicted),
    sd_pred_reduced = sd(reduced_predicted),
    min_pred_reduced = min(reduced_predicted),
    max_pred_reduced = max(reduced_predicted),
    p05_reduced = quantile(reduced_predicted, 0.05),
    p10_reduced = quantile(reduced_predicted, 0.10),
    p20_reduced = quantile(reduced_predicted, 0.20),
    p25_reduced = quantile(reduced_predicted, 0.25),
    p30_reduced = quantile(reduced_predicted, 0.30),
    p40_reduced = quantile(reduced_predicted, 0.40),
    p50_reduced = quantile(reduced_predicted, 0.50),
    p60_reduced = quantile(reduced_predicted, 0.60),
    p75_reduced = quantile(reduced_predicted, 0.75),
    p80_reduced = quantile(reduced_predicted, 0.80),
    p90_reduced = quantile(reduced_predicted, 0.90),
    p95_reduced = quantile(reduced_predicted, 0.95)
  )

write.csv(male_summary_5yr, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Vascular Age/Male Vascular Age - 5 yrs.csv", row.names = TRUE)
write.csv(female_summary_5yr, file = "P:/10619/Dropbox/htnport/output/New Modelling Output/Model Presentation Output/Parameters/svyglm/Vascular Age/Female Vascular Age - 5 yrs.csv", row.names = TRUE)
```