---
title: "HTNPoRT Paper - Analysis Summary"
format: html
editor: visual
---

### Load packages, functions, and metadeta

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Set working directory at RDC
setwd("P:/10619/Dropbox/htnport")

# Load packages, functions, and metadata
.libPaths("P:/10619/Rpackages")
library(haven)
library(dplyr)
library(survey)
library(srvyr)
library(gtsummary)
library(e1071)
library(rms)
library(ggplot2)
library(iml)
library(ggeffects)
library(scales)

source("R/descriptive-functions.R")
source("R/model-functions.R")
source("R/calibration.R")
source("R/impute-variables.R")

my_variables <- read.csv("P:/10619/Dropbox/htnport/worksheets/variables.csv")
```

### Table 1 - Population characteristics of predictors pre-specified in full model

```{r, warning = FALSE, message = FALSE}
# Load recoded cycles 1-6 data
load("P:/10619/Dropbox/htnport/data/poodina2.rda")

# Ensure derived categorical variables present in all six cycles can be properly tabulated
cycles1to6_data$ckd <- recode_na_b(cycles1to6_data$ckd)
cycles1to6_data$diabx <- recode_na_b(cycles1to6_data$diabx)
cycles1to6_data$low_drink_score1 <- recode_na_b(cycles1to6_data$low_drink_score1)
cycles1to6_data$working <- recode_na_b(cycles1to6_data$working)
cycles1to6_data$clc_sex <- droplevels(cycles1to6_data$clc_sex)

# Rename variables for table
cycles1to6_data <- cycles1to6_data %>%
  dplyr::rename(
    'Age' = clc_age,
    `Marital status` = married,
    `Highest education level` = edudr04,
    `Working status` = working,
    `Hypertension family history` = fmh_15,
    `Minutes of exercise per week` = minperweek,
    `Daily fruit and vegetable consumption` = totalfv,
    `Body mass index` = hwmdbmi,
    `Chronic kidney disease` = ckd,
    'Diabetes' = diabx,
    `Alcohol consumption level` = low_drink_score1,
    `Smoking status` = smoke,
    `Hours of sleep per day` = slp_11,
    `Self-rated mental health` = gendmhi,
    'Stress' = gen_025,
    `Sense of belonging` = gen_045
  )

# Apply weights to data
weighted_data <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = cycles1to6_data %>% dplyr::filter(!is.na(clc_sex))
)

# Generate table itself
gtsummary::tbl_svysummary(
  data = weighted_data, 
  by = clc_sex,
  include = c(
    'Age',
    `Marital status`,
    `Highest education level`,
    `Working status`,
    `Hypertension family history`,
    `Minutes of exercise per week`,
    `Daily fruit and vegetable consumption`,
    `Body mass index`,
    `Chronic kidney disease`,
    'Diabetes',
    `Alcohol consumption level`,
    `Smoking status`,
    `Hours of sleep per day`,
    `Self-rated mental health`,
    'Stress',
    `Sense of belonging`
  ),
  statistic = list(
    all_continuous() ~ "{median} ({p25}, {p75})",
    all_categorical() ~ "{n_unweighted} ({p}%)"
  ),
  missing = "no",
) %>%
  # Rename columns
  gtsummary::modify_header(label = "**Characteristic**") %>%
  gtsummary::modify_spanning_header(
    all_stat_cols() ~ "**Sex**"
  ) %>%
  gtsummary::modify_header(
    stat_1 = "**Male**",
    stat_2 = "**Female**"
  ) %>%
  # Rename variable names and category labels
  gtsummary::modify_table_body(
    ~ .x %>%
      dplyr::mutate(
        label = dplyr::case_when(
          label == "NA(a)" ~ "Not applicable",
          label == "NA(b)" ~ "Missing",
          label == "NA(c)" ~ "Not asked",
          variable == "Marital status" & label == "1" ~ "Married or common-law",
          variable == "Marital status" & label == "2" ~ "Widowed, separated, or divorced",
          variable == "Marital status" & label == "3" ~ "Single",
          variable == "Highest education level" & label == "1" ~ "No high school",
          variable == "Highest education level" & label == "2" ~ "Secondary",
          variable == "Highest education level" & label == "3" ~ "Post-secondary",
          variable == "Working status" & label == "1" ~ "Has a job",
          variable == "Working status" & label == "2" ~ "Does not have a job",
          variable == "Hypertension family history" & label == "1" ~ "Yes",
          variable == "Hypertension family history" & label == "2" ~ "No",
          variable == "Chronic kidney disease" & label == "1" ~ "Yes",
          variable == "Chronic kidney disease" & label == "2" ~ "No",
          variable == "Diabetes" & label == "1" ~ "Yes",
          variable == "Diabetes" & label == "2" ~ "No",
          variable == "Alcohol consumption level" & label == "1" ~ "Never drank",
          variable == "Alcohol consumption level" & label == "2" ~ "Low-risk drinker",
          variable == "Alcohol consumption level" & label == "3" ~ "Moderate drinker",
          variable == "Alcohol consumption level" & label == "4" ~ "Heavy drinker",
          variable == "Smoking status" & label == "1" ~ "Current smoker",
          variable == "Smoking status" & label == "2" ~ "Former smoker",
          variable == "Smoking status" & label == "3" ~ "Never smoker",
          variable == "Self-rated mental health" & label == "1" ~ "Poor or fair",
          variable == "Self-rated mental health" & label == "2" ~ "Good, very good, or excellent",
          variable == "Stress" & label == "1" ~ "Not at all to a bit",
          variable == "Stress" & label == "2" ~ "Quite a bit or extremely",
          variable == "Sense of belonging" & label == "1" ~ "Strong",
          variable == "Sense of belonging" & label == "2" ~ "Weak",
          TRUE ~ label
        )
      )
  )

# Revert the names in the data frame
original_names <- c(
  "Hypertension" = "highbp14090_adj",
  "Age" = "clc_age",
  "Marital status" = "married",
  "Highest education level" = "edudr04",
  "Working status" = "working",
  "Hypertension family history" = "fmh_15",
  "Minutes of exercise per week" = "minperweek",
  "Daily fruit and vegetable consumption" = "totalfv",
  "Body mass index" = "hwmdbmi",
  "Chronic kidney disease" = "ckd",
  "Diabetes" = "diabx",
  "Alcohol consumption level" = "low_drink_score1",
  "Smoking status" = "smoke",
  "Hours of sleep per day" = "slp_11",
  "Self-rated mental health" = "gendmhi",
  "Stress" = "gen_025",
  "Sense of belonging" = "gen_045"
)

names(cycles1to6_data) <- dplyr::recode(names(cycles1to6_data), !!!original_names)
```

### Prepare imputed dataset for modelling

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Load recoded, imputed cycles 1-6 data
load("P:/10619/Dropbox/htnport/data/pood2.rda")

# Truncate skewed continuous variables if necessary
imputed_cycles1to6_data <- truncate_skewed(imputed_cycles1to6_data)

# Recode 2s as 0s in binary predictors and factorize all categorical predictors
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

# Factor categorical predictors
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

# Separate male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

# Apply survey weights to male and female data
male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

# Center continious variables
cont_variables <- c("clc_age", "hwmdbmi", "minperweek", "totalfv", "slp_11")

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

# Center categorical variables
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}
```

### Fit full and reduced male and female models

```{r, warning = FALSE, message = FALSE}
# Fit full male and female models
weighted_male$degf <- 68
male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female, family = quasibinomial())

# Fit reduced male and female models (from stepdown function which takes too long to run)
weighted_male$degf <- 68
male_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female, family = quasibinomial())
```

### Full model assessment for original sample

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for full models
male_predicted_probabilities <- generate_predicted_probabilities(male_model)
female_predicted_probabilities <- generate_predicted_probabilities(female_model)

# Calibration plots with performance metrics
calibration(male_predicted_probabilities, male_data$highbp14090_adj)
calibration(female_predicted_probabilities, female_data$highbp14090_adj)

# Calibration in-the-whole and across percentiles
compare_probs(male_data, male_predicted_probabilities)
compare_probs(female_data, female_predicted_probabilities)

# Plot cumulative frequency of predicted probabilities
plot(sort(male_predicted_probabilities), seq_along(male_predicted_probabilities), type = "s", col = "blue", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
plot(sort(female_predicted_probabilities), seq_along(female_predicted_probabilities), type = "s", col = "red", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
```

### Reduced model assessment for original sample

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for reduced models
male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model)

# Calibration plots with performance metrics
calibration(male_predicted_probabilities, male_data$highbp14090_adj)
calibration(female_predicted_probabilities, female_data$highbp14090_adj)

# Calibration in-the-whole and across percentiles
compare_probs(male_data, male_predicted_probabilities)
compare_probs(female_data, female_predicted_probabilities)

# Plot cumulative frequency of predicted probabilities
plot(sort(male_predicted_probabilities), seq_along(male_predicted_probabilities), type = "s", col = "blue", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
plot(sort(female_predicted_probabilities), seq_along(female_predicted_probabilities), type = "s", col = "red", lwd = 2, xlab = "Predicted probability", ylab = "Cumulative frequency")
```

### Full model assessment for bootstrap samples - BOOTSTRAP VALIDATION 1/2

```{r, warning = FALSE, message = FALSE}
# Perform bootstrapping for both male and female full models
n_bootstrap <- 1000  # Number of bootstrap resamples

# For male full model
bootstrap_results_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data), replace = TRUE)
  bootstrap_function(male_data, boot_indices, male_model)
}, simplify = FALSE)

# For female full model
bootstrap_results_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data), replace = TRUE)
  bootstrap_function(female_data, boot_indices, female_model)
}, simplify = FALSE)

# Aggregate and summarize results for male
nagelkerke_r2_male <- sapply(bootstrap_results_male, function(x) x$nagelkerke_r2)
brier_score_male <- sapply(bootstrap_results_male, function(x) x$brier_score)
auc_male <- sapply(bootstrap_results_male, function(x) x$auc_value)
auc_male_ci_lower <- sapply(bootstrap_results_male, function(x) x$auc_ci_lower)
auc_male_ci_upper <- sapply(bootstrap_results_male, function(x) x$auc_ci_upper)
ratio_90_10_male <- sapply(bootstrap_results_male, function(x) x$ratio_90_10)
ratio_95_5_male <- sapply(bootstrap_results_male, function(x) x$ratio_95_5)
relative_difference_overall_male <- sapply(bootstrap_results_male, function(x) x$relative_difference_overall)
calibration_slope_male <- sapply(bootstrap_results_male, function(x) x$calibration_slope)

# Aggregate and summarize results for female
nagelkerke_r2_female <- sapply(bootstrap_results_female, function(x) x$nagelkerke_r2)
brier_score_female <- sapply(bootstrap_results_female, function(x) x$brier_score)
auc_female <- sapply(bootstrap_results_female, function(x) x$auc_value)
auc_female_ci_lower <- sapply(bootstrap_results_female, function(x) x$auc_ci_lower)
auc_female_ci_upper <- sapply(bootstrap_results_female, function(x) x$auc_ci_upper)
ratio_90_10_female <- sapply(bootstrap_results_female, function(x) x$ratio_90_10)
ratio_95_5_female <- sapply(bootstrap_results_female, function(x) x$ratio_95_5)
relative_difference_overall_female <- sapply(bootstrap_results_female, function(x) x$relative_difference_overall)
calibration_slope_female <- sapply(bootstrap_results_female, function(x) x$calibration_slope)

# Combine into a data frame
results_summary <- data.frame(
  Metric = c("Mean Nagelkerke R²", "Mean Brier Score", "Mean AUC", "Mean AUC 95% CI Lower", "Mean AUC 95% CI Upper", "Mean 90:10 Predicted Ratio", "Mean 95:5 Predicted Ratio", "Mean Observed v. Predicted", "Mean Calibration Slope"),
  Male = c(mean(nagelkerke_r2_male), mean(brier_score_male), mean(auc_male),
           mean(auc_male_ci_lower), mean(auc_male_ci_upper),
           mean(ratio_90_10_male), mean(ratio_95_5_male), mean(relative_difference_overall_male), mean(calibration_slope_male)),
  Female = c(mean(nagelkerke_r2_female), mean(brier_score_female), mean(auc_female),
             mean(auc_female_ci_lower), mean(auc_female_ci_upper),
             mean(ratio_90_10_female), mean(ratio_95_5_female), mean(relative_difference_overall_female), mean(calibration_slope_female))
)

# Print the summary data frame
print(results_summary)
```

### Reduced model assessment for bootstrap samples - BOOTSTRAP VALIDATION 2/2

```{r, warning = FALSE, message = FALSE}
# Perform bootstrapping for both male and female reduced models
n_bootstrap <- 1000  # Number of bootstrap resamples

# For male reduced model
bootstrap_results_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data), replace = TRUE)
  bootstrap_function(male_data, boot_indices, male_reduced_model)
}, simplify = FALSE)

# For female reduced model
bootstrap_results_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data), replace = TRUE)
  bootstrap_function(female_data, boot_indices, female_reduced_model)
}, simplify = FALSE)

# Aggregate and summarize results for male
nagelkerke_r2_male <- sapply(bootstrap_results_male, function(x) x$nagelkerke_r2)
brier_score_male <- sapply(bootstrap_results_male, function(x) x$brier_score)
auc_male <- sapply(bootstrap_results_male, function(x) x$auc_value)
auc_male_ci_lower <- sapply(bootstrap_results_male, function(x) x$auc_ci_lower)
auc_male_ci_upper <- sapply(bootstrap_results_male, function(x) x$auc_ci_upper)
ratio_90_10_male <- sapply(bootstrap_results_male, function(x) x$ratio_90_10)
ratio_95_5_male <- sapply(bootstrap_results_male, function(x) x$ratio_95_5)
relative_difference_overall_male <- sapply(bootstrap_results_male, function(x) x$relative_difference_overall)
calibration_slope_male <- sapply(bootstrap_results_male, function(x) x$calibration_slope)

# Aggregate and summarize results for female
nagelkerke_r2_female <- sapply(bootstrap_results_female, function(x) x$nagelkerke_r2)
brier_score_female <- sapply(bootstrap_results_female, function(x) x$brier_score)
auc_female <- sapply(bootstrap_results_female, function(x) x$auc_value)
auc_female_ci_lower <- sapply(bootstrap_results_female, function(x) x$auc_ci_lower)
auc_female_ci_upper <- sapply(bootstrap_results_female, function(x) x$auc_ci_upper)
ratio_90_10_female <- sapply(bootstrap_results_female, function(x) x$ratio_90_10)
ratio_95_5_female <- sapply(bootstrap_results_female, function(x) x$ratio_95_5)
relative_difference_overall_female <- sapply(bootstrap_results_female, function(x) x$relative_difference_overall)
calibration_slope_female <- sapply(bootstrap_results_female, function(x) x$calibration_slope)

# Combine into a data frame
results_summary <- data.frame(
  Metric = c("Mean Nagelkerke R²", "Mean Brier Score", "Mean AUC", "Mean AUC 95% CI Lower", "Mean AUC 95% CI Upper", "Mean 90:10 Predicted Ratio", "Mean 95:5 Predicted Ratio", "Mean Observed v. Predicted", "Mean Calibration Slope"),
  Male = c(mean(nagelkerke_r2_male), mean(brier_score_male), mean(auc_male),
           mean(auc_male_ci_lower), mean(auc_male_ci_upper),
           mean(ratio_90_10_male), mean(ratio_95_5_male), mean(relative_difference_overall_male), mean(calibration_slope_male)),
  Female = c(mean(nagelkerke_r2_female), mean(brier_score_female), mean(auc_female),
             mean(auc_female_ci_lower), mean(auc_female_ci_upper),
             mean(ratio_90_10_female), mean(ratio_95_5_female), mean(relative_difference_overall_female), mean(calibration_slope_female))
)

# Print the summary data frame
print(results_summary)
```

### Calibration across subgroups for full male model

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for full male model
male_predicted_probabilities <- generate_predicted_probabilities(male_model)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
subgroups <- subgroups[subgroups != "clc_age"]

# Initialize an empty list to store calibration results
male_calibration_results <- list()

# Define x-axis labels
subgroup_labels <- list(
  "adj_hh_inc" = "Adjusted household income ($)",
  "agegroup4" = "Age group",
  "alcdwky" = "Weekly alcohol consumption (drinks/week)",
  "ckd" = "Chronic kidney disease",
  "diabx" = "Diabetes",
  "edudr04" = "Highest education level",
  "fmh_15" = "Hypertension family history",
  "gendhdi" = "Self-rated health",
  "gendmhi" = "Self-rated mental health",
  "gen_025" = "Self-perceived stress",
  "gen_045" = "Sense of belonging",
  "gfr" = "Glomerular filtration rate (mL/min/1.73 m²)",
  "gooddiet" = "Diet level",
  "hwm_13kg" = "Weight (kg)",
  "hwm_14cx" = "Waist circumference (cm)",
  "hwmdbmi" = "Body mass index (kg/m²)",
  "img_03" = "Immigrant",
  "lab_bpb" = "Blood lead (µmol/L)",
  "lab_hba1" = "HbA1c",
  "low_drink_score1" = "Alcohol consumption level",
  "married" = "Marital status",
  "minperweek" = "Physical activity minutes (min/week)",
  "mvpa150wk" = "Physical activity level",
  "nonhdltodd" = "High cholesterol",
  "pgdcgt" = "Ethnicity",
  "slp_11" = "Sleep duration (hrs/night)",
  "smoke" = "Smoking status",
  "totalfv" = "Daily fruit and vegetable consumption (times/day)",
  "whr" = "Waist-to-height ratio (%)",
  "working" = "Working status"
)

# Define level labels for categorical variables
level_labels <- list(
  "agegroup4" = c("1" = "20-39 years", "2" = "40-59 years", "3" = "60-69 years", "4" = "70-79 years"),
  "married" = c("1" = "Married or common-law", "2" = "Widowed, separated, or divorced", "3" = "Single and never married"),
  "edudr04" = c("0" = "Post-secondary school", "1" = "Secondary school", "2" = "Less than secondary school"),
  "pgdcgt" = c("1" = "White", "2" = "Not white"),
  "img_03" = c("1" = "Yes", "2" = "No"),
  "working" = c("1" = "Has a job", "2" = "Does not have a job"),
  "gendhdi" = c("1" = "Poor or fair", "2" = "Good, very good, or excellent"),
  "gendmhi" = c("1" = "Poor or fair", "0" = "Good, very good, or excellent"),
  "gen_025" = c("1" = "Not at all to a bit", "2" = "Quite a bit or extremely"),
  "gen_045" = c("1" = "Strong", "2" = "Weak"),
  "fmh_15" = c("1" = "Yes", "0" = "No"),
  "diabx" = c("1" = "Yes", "0" = "No"),
  "ckd" = c("1" = "Yes", "0" = "No"),
  "low_drink_score1" = c("1" = "Never drank", "2" = "Low-risk drinker", "3" = "Moderate drinker", "4" = "Heavy drinker"),
  "smoke" = c("0" = "Never smoker", "1" = "Former smoker", "2" = "Current smoker"),
  "mvpa150wk" = c("1" = "Physically active", "2" = "Physically inactive"),
  "gooddiet" = c("1" = "Eats fruits/veg ≥5 times per day", "2" = "Eats fruits/veg <5 times per day"),
  "nonhdltodd" = c("1" = "Yes", "2" = "No")
)

for (subgroup in subgroups) {
  if (all(!is.na(male_data[[subgroup]]))) {
    male_calibration_results[[subgroup]] <- calibration(
      male_predicted_probabilities,
      male_data$highbp14090_adj,
      group = male_data[[subgroup]]
    )

    cal_result <- male_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
male_calibration_results
```

### Calibration across subgroups for full female model

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for full female model
female_predicted_probabilities <- generate_predicted_probabilities(female_model)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
subgroups <- subgroups[subgroups != "clc_age"]

# Initialize an empty list to store calibration results
female_calibration_results <- list()

# Loop through each subgroup in the female dataset
for (subgroup in subgroups) {
  if (all(!is.na(female_data[[subgroup]]))) {
    female_calibration_results[[subgroup]] <- calibration(
      female_predicted_probabilities,
      female_data$highbp14090_adj,
      group = female_data[[subgroup]]
    )

    cal_result <- female_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
female_calibration_results
```

### Calibration across subgroups for reduced male model

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for reduced male model
male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
subgroups <- subgroups[subgroups != "clc_age"]

# Initialize an empty list to store calibration results
male_calibration_results <- list()

# Loop through each subgroup
for (subgroup in subgroups) {
  if (all(!is.na(male_data[[subgroup]]))) {
    male_calibration_results[[subgroup]] <- calibration(
      male_predicted_probabilities,
      male_data$highbp14090_adj,
      group = male_data[[subgroup]]
    )

    cal_result <- male_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
male_calibration_results
```

### Calibration across subgroups for reduced female model

```{r, warning = FALSE, message = FALSE}
# Generate predicted probabilities for reduced female model
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
subgroups <- subgroups[subgroups != "clc_age"]

# Initialize an empty list to store calibration results
female_calibration_results <- list()

# Loop through each subgroup in the female dataset
for (subgroup in subgroups) {
  if (all(!is.na(female_data[[subgroup]]))) {
    female_calibration_results[[subgroup]] <- calibration(
      female_predicted_probabilities,
      female_data$highbp14090_adj,
      group = female_data[[subgroup]]
    )

    cal_result <- female_calibration_results[[subgroup]]
    cal_result <- as.data.frame(cal_result[["stats"]])
    
    if (!is.null(cal_result) && "n" %in% names(cal_result) && "Pavg" %in% names(cal_result) && "Obs" %in% names(cal_result)) {
      cal_df <- data.frame(
        Subgroup = factor(rownames(cal_result), levels = rownames(cal_result)),
        n = cal_result$n,
        Pavg = cal_result$Pavg,
        Obs = cal_result$Obs
      )
      cal_df <- cal_df[1:(nrow(cal_df) - 1), ]

      # Set x-axis label dynamically
      x_label <- ifelse(subgroup %in% names(subgroup_labels), subgroup_labels[[subgroup]], subgroup)

      # Assign level labels for bars if available
      if (subgroup %in% names(level_labels)) {
        cal_df$Subgroup <- factor(cal_df$Subgroup, levels = names(level_labels[[subgroup]]), labels = level_labels[[subgroup]])
      }

      # Identify symbols for bars
      cal_df$asterisk <- ifelse(abs(cal_df$Obs - cal_df$Pavg) / cal_df$Obs > 0.20, "*", "")
      cal_df$X_mark <- ifelse(cal_df$Obs < 0.05, "X", "")

      # Merge symbols if both conditions are met
      cal_df$symbol <- paste0(cal_df$asterisk, cal_df$X_mark)

      # Plot with symbols for significant differences and low observations
      print(ggplot(cal_df, aes(x = Subgroup)) +
        geom_bar(aes(y = Obs, fill = "Observed"), stat = "identity", width = 0.6, alpha = 0.7) +
        geom_point(aes(y = Pavg, color = "Predicted"), size = 4) +
        geom_text(aes(y = Obs + 0.05, label = symbol), color = "black", size = 6, vjust = -0.5) + # Add symbols
        scale_fill_manual(name = "", values = c("Observed" = "steelblue")) +
        scale_color_manual(name = "", values = c("Predicted" = "red")) +
        labs(y = "Estimate", x = x_label) + ylim(0,1) +
        theme_minimal())
    } else {
      warning(paste("Skipping subgroup:", subgroup, "due to missing required columns in calibration output."))
    }
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values in data."))
  }
}

# Inspect the results for each subgroup
female_calibration_results
```

### Partial effect plots

```{r, warning = FALSE, message = FALSE}
# Set data distributions
male_dd <- datadist(male_data)
options(datadist = "male_dd")

female_dd <- datadist(female_data)
options(datadist = "female_dd")

# Fit final full models with lrm to make partial effect plots work
male_final_model <- rms::lrm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, data = male_data, weights = wgt_full, tol = 1e-13)

female_final_model <- rms::lrm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, data = female_data, weights = wgt_full, tol = 1e-13)

# Generate partial effect plots
ggplot(Predict(male_final_model))
ggplot(Predict(female_final_model))
```

### Beta coefficients for full and reduced models

```{r, warning = FALSE, message = FALSE}
# Get beta coefficients and their standard errors for full models
extract_beta_coefs(male_model)
extract_beta_coefs(female_model)

# Get beta coefficients and their standard errors for reduced models
extract_beta_coefs(male_reduced_model)
extract_beta_coefs(female_reduced_model)
```

### Shap plot (male full model)

```{r, warning = FALSE, message = FALSE}
# Reset male data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

# Fit final full male model with glm to avoid errors
male_final_model <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, family = quasibinomial(), data = male_data, weights = wgt_full)

# Predictors and outcome only
male_data <- male_data %>% 
  dplyr::select(recodeflow:::select_vars_by_role(c("Predictor"), my_variables)) %>%
  dplyr::select(-whr)

# Create observation as a data frame
observation <- data.frame(
  clc_age = 24,         # 24-year old male
  married = 3,          # Single
  edudr04 = 0,          # Post-secondary graduate
  working = 2,          # Not working
  gendmhi = 0,          # Good, very good, or excellent mental health
  gen_025 = 1,          # Not at all to a bit stressed
  gen_045 = 1,          # Strong sense of belonging
  fmh_15 = 1,           # Family history of hypertension present
  hwmdbmi = 19.6,       # BMI = 19.6; Healthy
  low_drink_score1 = 1, # Never drinker
  minperweek = 30,      # Exercises 30 min per week; does not meet criteria
  smoke = 0,            # Never smoked  
  slp_11 = 7,           # Sleeps 7 hours per night
  totalfv = 5,          # Eats fruits and veggies 5 times per day; meets criteria
  diabx = 0,            # Diabetes absent
  ckd = 0               # Chronic kidney disease absent  
)

# Ensure observation has the same structure and var order as male_data
observation <- observation[, names(male_data), drop = FALSE]

for (var in names(male_data)) {
  if (is.factor(male_data[[var]])) {
    # Convert to factor and ensure levels match male_data
    observation[[var]] <- factor(observation[[var]], levels = levels(male_data[[var]]))
  } else {
    # Convert to numeric for consistency
    observation[[var]] <- as.numeric(observation[[var]])
  }
}

# Create explainer object for model
male_explainer <- iml::Predictor$new(
   model = male_final_model,                                       # Pass the model
   data = male_data,                                               # Pass the data
   y = male_data[["highbp14090_adj"]],                             # Indicate outcome
   type = "response"                                               # Return predicted probabilities )
)

# Compute and plot SHAP values
set.seed(456)
male_shap_values <- iml::Shapley$new(male_explainer, x.interest = observation)

shap_df <- as.data.frame(male_shap_values$results) %>%
  mutate(
    std.err = sqrt(phi.var),                         # Compute standard error
    feature = reorder(feature, phi)                  # Reorder for plotting
  )

shap_df %>%
  mutate(feature = reorder(feature, phi)) %>%
  ggplot(aes(x = phi, y = feature)) +
  geom_bar(stat = "identity", fill = "grey30") +
  geom_errorbarh(aes(xmin = phi - std.err, xmax = phi + std.err), height = 0.2) +
  labs(
    x = "SHAP value",
    y = NULL,
    title = paste0("Actual prediction: ", round(male_shap_values$y.hat.interest, 2),
                   "\nAverage prediction: ", round(male_shap_values$y.hat.average, 2))
  ) +
  theme_minimal()

as.data.frame(shap_df) %>%
  arrange(desc(phi)) %>%
  select(feature.value, phi, std.err)
```

### Shap plot (male reduced model)

```{r, warning = FALSE, message = FALSE}
# Reset male data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

# Fit final reduced male model with glm to avoid errors
male_final_reduced_model <- glm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, family = quasibinomial(), data = male_data, weights = wgt_full)

# Predictors and outcome only
male_data <- male_data %>% 
  dplyr::select(clc_age, fmh_15, diabx, hwmdbmi)

# Create observation as a data frame
observation <- data.frame(
  clc_age = 24,         # 24-year old male
  fmh_15 = 1,           # Family history of hypertension present
  hwmdbmi = 19.6,       # BMI = 19.6; Healthy
  diabx = 0             # Diabetes absent
)

# Ensure observation has the same structure and var order as male_data
observation <- observation[, names(male_data), drop = FALSE]

for (var in names(male_data)) {
  if (is.factor(male_data[[var]])) {
    # Convert to factor and ensure levels match male_data
    observation[[var]] <- factor(observation[[var]], levels = levels(male_data[[var]]))
  } else {
    # Convert to numeric for consistency
    observation[[var]] <- as.numeric(observation[[var]])
  }
}

# Create explainer object for model
male_explainer <- iml::Predictor$new(
   model = male_final_reduced_model,                               # Pass the model
   data = male_data,                                               # Pass the data
   y = male_data[["highbp14090_adj"]],                             # Indicate outcome
   type = "response"                                               # Return predicted probabilities )
)

# Compute and plot SHAP values
set.seed(456)
male_shap_values <- iml::Shapley$new(male_explainer, x.interest = observation)

shap_df <- as.data.frame(male_shap_values$results) %>%
  mutate(
    std.err = sqrt(phi.var),                         # Compute standard error
    feature = reorder(feature, phi)                  # Reorder for plotting
  )

shap_df %>%
  mutate(feature = reorder(feature, phi)) %>%
  ggplot(aes(x = phi, y = feature)) +
  geom_bar(stat = "identity", fill = "grey30") +
  geom_errorbarh(aes(xmin = phi - std.err, xmax = phi + std.err), height = 0.2) +
  labs(
    x = "SHAP value",
    y = NULL,
    title = paste0("Actual prediction: ", round(male_shap_values$y.hat.interest, 2),
                   "\nAverage prediction: ", round(male_shap_values$y.hat.average, 2))
  ) +
  theme_minimal()

as.data.frame(shap_df) %>%
  arrange(desc(phi)) %>%
  select(feature.value, phi, std.err)
```

### Shap-adjusted ORs and CIs (full models only)

```{r, warning = FALSE, message = FALSE}
# Reset male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))
female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

# Fit final full models with glm to avoid errors
male_final_model <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, data = male_data, family = binomial(), weights = wgt_full)

female_final_model <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, data = female_data, family = binomial(), weights = wgt_full)

# Male model
# Predictors only
male_data <- male_data %>% 
  dplyr::select(recodeflow:::select_vars_by_role(c("Predictor"), my_variables)) %>%
  dplyr::select(-whr)

# Create explainer object for model
male_explainer <- iml::Predictor$new(
   model = male_final_model,                                       # Pass the model
   data = male_data,                                               # Pass the data
   y = male_data[["highbp14090_adj"]]                              # Indicate outcome
)

# Initialize a list to store SHAP values
set.seed(123)
male_shap_list <- list()

# Generate Shap values for each row in male_data
for (i in 1:nrow(male_data)) {
    # Ensure observation remains a data frame
    observation <- male_data[i, , drop = FALSE]  
    
    # Generate SHAP values
    male_shap_values <- iml::Shapley$new(male_explainer, x.interest = observation)
    
    # Store results in the list
    male_shap_list[[i]] <- male_shap_values$results
}

# Convert list into a data frame for easier manipulation
all_male_shap_values <- do.call(rbind, male_shap_list)

# Loop through all predictors and print their S-OR and CI
predictors <- recodeflow:::select_vars_by_role(c("Predictor"), my_variables)
predictors <- predictors[predictors != "whr"]

for (pred in predictors) {
  print(calculate_shap_or_ci(all_male_shap_values, pred))
}

# Female model
# Predictors only
female_data <- female_data %>% 
  dplyr::select(recodeflow:::select_vars_by_role(c("Predictor"), my_variables)) %>%
  dplyr::select(-whr)

# Create explainer object for model
female_explainer <- iml::Predictor$new(
   model = female_final_model,                                      # Pass the model
   data = female_data,                                              # Pass the data
   y = female_data[["highbp14090_adj"]]                             # Indicate outcome
)

# Initialize a list to store SHAP values
set.seed(123)
female_shap_list <- list()

# Generate Shap values for each row in female_data
for (i in 1:nrow(female_data)) {
    # Ensure observation remains a data frame
    observation <- female_data[i, , drop = FALSE]  
    
    # Generate SHAP values
    female_shap_values <- iml::Shapley$new(female_explainer, x.interest = observation)
    
    # Store results in the list
    female_shap_list[[i]] <- female_shap_values$results
}

# Convert list into a data frame for easier manipulation
all_female_shap_values <- do.call(rbind, female_shap_list)

# Loop through all predictors and print their S-OR and CI
predictors <- recodeflow:::select_vars_by_role(c("Predictor"), my_variables)
predictors <- predictors[predictors != "whr"]

for (pred in predictors) {
  print(calculate_shap_or_ci(all_female_shap_values, pred))
}
```

### OR plots for non-linear predictors and interactions (full models only)

```{r, warning = FALSE, message = FALSE}
# Define title labels for all plots
title_labels <- list(
  "ckd" = "chronic kidney disease",
  "clc_age" = "age",
  "diabx" = "diabetes",
  "gen_045" = "sense of belonging",
  "hwmdbmi" = "body mass index",
  "minperweek" = "physical activity minutes",
  "slp_11" = "sleep duration",
  "smoke" = "smoking status"
)

# Define x-axis labels for RCS variable plots
var_labels <- list(
  "clc_age" = "Age (years)",
  "hwmdbmi" = "Body mass index (kg/m²)",
  "minperweek" = "Physical activity minutes (min/week)"
)

# Define legend title labels for age interaction plots
legend_labels <- list(
  "ckd" = "Chronic kidney disease",
  "diabx" = "Diabetes",
  "gen_045" = "Sense of belonging",
  "hwmdbmi" = "Body mass index (kg/m²)",
  "minperweek" = "Physical activity minutes (min/week)",
  "slp_11" = "Sleep duration (hrs/night)",
  "smoke" = "Smoking status"
)

# Define legend level labels for age x categorical variable plots
level_labels <- list(
  "ckd" = c("1" = "Yes", "0" = "No"),
  "diabx" = c("1" = "Yes", "0" = "No"),
  "gen_045" = c("1" = "Strong", "2" = "Weak"),
  "smoke" = c("0" = "Never smoker", "1" = "Former smoker", "2" = "Current smoker")
)

# RCS variable plots
rcs_variables <- c("clc_age", "hwmdbmi", "minperweek")

for (var in rcs_variables) {
  
  title_label <- ifelse(var %in% names(title_labels), title_labels[[var]], var)
  x_label <- ifelse(var %in% names(var_labels), var_labels[[var]], var)

  # Male
  preds_male <- ggpredict(male_final_model, terms = var)
  ref_row_m <- preds_male[which.min(preds_male$x), ]

  preds_male <- preds_male %>%
    mutate(
      ref_odds = ref_row_m$predicted / (1 - ref_row_m$predicted),
      odds = predicted / (1 - predicted),
      or = odds / ref_odds,
      or_low = (conf.low / (1 - conf.low)) / ref_odds,
      or_high = (conf.high / (1 - conf.high)) / ref_odds
    )

  # Female
  preds_female <- ggpredict(female_final_model, terms = var)
  ref_row_f <- preds_female[which.min(preds_female$x), ]

  preds_female <- preds_female %>%
    mutate(
      ref_odds = ref_row_f$predicted / (1 - ref_row_f$predicted),
      odds = predicted / (1 - predicted),
      or = odds / ref_odds,
      or_low = (conf.low / (1 - conf.low)) / ref_odds,
      or_high = (conf.high / (1 - conf.high)) / ref_odds
    )

  # Male plot
  print(ggplot(preds_male, aes(x = x, y = or)) +
    geom_line(color = "black", size = 1.2) +
    geom_ribbon(aes(ymin = or_low, ymax = or_high), fill = "grey", alpha = 0.3) +
    geom_hline(yintercept = 1, linetype = "dotted") +
    scale_y_log10() +
    labs(title = paste0("Odds ratio by ", title_label, " in men"),
         x = x_label, y = "Adjusted odds ratio") +
    theme_minimal())

  # Female plot
  print(ggplot(preds_female, aes(x = x, y = or)) +
    geom_line(color = "black", size = 1.2) +
    geom_ribbon(aes(ymin = or_low, ymax = or_high), fill = "grey", alpha = 0.3) +
    geom_hline(yintercept = 1, linetype = "dotted") +
    scale_y_log10() +
    labs(title = paste0("Odds ratio by ", title_label, " in women"),
         x = x_label, y = "Adjusted odds ratio") +
    theme_minimal())
}

# Age x categorical variable plots
age_cat_int_variables <- c("gen_045", "smoke", "diabx", "ckd")

for (var in age_cat_int_variables) {
  print(plot_age_int_or(
    model = male_final_model,
    var = var,
    var_type = "categorical",
    sex_label = "men",
    title_labels = title_labels,
    legend_labels = legend_labels,
    level_labels = level_labels
  ))
  
  print(plot_age_int_or(
    model = female_final_model,
    var = var,
    var_type = "categorical",
    sex_label = "women",
    title_labels = title_labels,
    legend_labels = legend_labels,
    level_labels = level_labels
  ))
}

# Age x continuous variable plots
age_cont_int_variables <- c("hwmdbmi", "minperweek", "slp_11")

for (var in age_cont_int_variables) {
  print(plot_age_int_or(
    model = male_final_model,
    var = var,
    var_type = "continuous",
    design = weighted_male,
    sex_label = "men",
    title_labels = title_labels,
    legend_labels = legend_labels
  ))

  print(plot_age_int_or(
    model = female_final_model,
    var = var,
    var_type = "continuous",
    design = weighted_female,
    sex_label = "women",
    title_labels = title_labels,
    legend_labels = legend_labels
  ))
}
```

### Sensitivity analyses (missing data)

```{r, warning = FALSE, message = FALSE}
# Impute data, except family history
predictors <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)
predictors <- predictors[predictors != "fmh_15"]

imputation_predictors <- recodeflow:::select_vars_by_role("imputation-predictor", my_variables)
imputation_predictors <- imputation_predictors[imputation_predictors != "fmh_15"]

imputed_cycles1to6_data_nofmh <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = predictors, predictors = imputation_predictors)
imputed_cycles1to6_data_nofmh$clinicid <- cycles1to6_data$clinicid

# Merge bootstrap weights to imputed sample data, which is then recoded, segregated, and weighted
cycles1to6_bsw <- read_stata("data/cycles1to6_bsw.dta")
names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw))

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data_nofmh <- dplyr::left_join(imputed_cycles1to6_data_nofmh, cycles1to6_bsw, by = c("clinicid"))

imputed_cycles1to6_data_nofmh <- truncate_skewed(imputed_cycles1to6_data_nofmh)

imputed_cycles1to6_data_nofmh <- imputed_cycles1to6_data_nofmh %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                fmh_15 = case_when(
                  fmh_15 == 2 ~ 0,
                  fmh_15 == 1 ~ 1,
                  fmh_15 == "NA(c)" ~ NA
                ),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

imputed_cycles1to6_data_nofmh <- imputed_cycles1to6_data_nofmh %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

male_data_nofmh <- dplyr::filter(imputed_cycles1to6_data_nofmh, clc_sex == 1)
female_data_nofmh <- dplyr::filter(imputed_cycles1to6_data_nofmh, clc_sex == 2)

male_replicate_weights <- male_data_nofmh %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

female_replicate_weights <- female_data_nofmh %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male_nofmh <- male_data_nofmh %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_female_nofmh <- female_data_nofmh %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

# Fit full male and female models with unimputed family history and see effect
weighted_male_nofmh$degf <- 68
male_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male_nofmh, family = quasibinomial())

weighted_female_nofmh$degf <- 68
female_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female_nofmh, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(male_model_nofmh)
female_predicted_probabilities <- generate_predicted_probabilities(female_model_nofmh)

calibration(male_predicted_probabilities, model.frame(male_model_nofmh)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_model_nofmh)$highbp14090_adj)

# Fit reduced male and female models with unimputed family history and see effect
weighted_male_nofmh$degf <- 68
male_reduced_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male_nofmh, family = quasibinomial())

weighted_female_nofmh$degf <- 68
female_reduced_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female_nofmh, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model_nofmh)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model_nofmh)

calibration(male_predicted_probabilities, model.frame(male_reduced_model_nofmh)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_reduced_model_nofmh)$highbp14090_adj)

# Make missing family history its own category before segregating and weighting data
imputed_cycles1to6_data_nofmh <- imputed_cycles1to6_data_nofmh %>%
  dplyr::mutate(
    fmh_15 = dplyr::case_when(
      is.na(fmh_15) ~ "Missing",
      TRUE ~ as.character(fmh_15)
    ),
    fmh_15 = factor(fmh_15, levels = c("0", "1", "Missing"))  # Reorder levels if needed
  )

male_data_nofmh <- dplyr::filter(imputed_cycles1to6_data_nofmh, clc_sex == 1)
female_data_nofmh <- dplyr::filter(imputed_cycles1to6_data_nofmh, clc_sex == 2)

weighted_male_nofmh <- male_data_nofmh %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_female_nofmh <- female_data_nofmh %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

# Fit full models with new family history predictor and see effect
weighted_male_nofmh$degf <- 68
male_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male_nofmh, family = quasibinomial())

weighted_female_nofmh$degf <- 68
female_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female_nofmh, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(male_model_nofmh)
female_predicted_probabilities <- generate_predicted_probabilities(female_model_nofmh)

calibration(male_predicted_probabilities, model.frame(male_model_nofmh)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_model_nofmh)$highbp14090_adj)

# Fit reduced models with new family history predictor and see effect
weighted_male_nofmh$degf <- 68
male_reduced_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male_nofmh, family = quasibinomial())

weighted_female_nofmh$degf <- 68
female_reduced_model_nofmh <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female_nofmh, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model_nofmh)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model_nofmh)

calibration(male_predicted_probabilities, model.frame(male_reduced_model_nofmh)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_reduced_model_nofmh)$highbp14090_adj)

# Merge bootstrap weights to unimputed sample data, which is then recoded, segregated, and weighted
unimputed_cycles1to6_data <- dplyr::left_join(cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

unimputed_cycles1to6_data <- truncate_skewed(unimputed_cycles1to6_data)

unimputed_cycles1to6_data <- unimputed_cycles1to6_data %>%
  dplyr::mutate(across(everything(), ~ ifelse(. %in% c("NA(a)", "NA(b)", "NA(c)"), NA, .))) %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

unimputed_cycles1to6_data <- unimputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

unimputed_male_data <- dplyr::filter(unimputed_cycles1to6_data, clc_sex == 1)
unimputed_female_data <- dplyr::filter(unimputed_cycles1to6_data, clc_sex == 2)

unimputed_weighted_male <- unimputed_male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

unimputed_weighted_female <- unimputed_female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

# Fit full male and female models with unimputed data and see effect
unimputed_weighted_male$degf <- 68
unimputed_male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = unimputed_weighted_male, family = quasibinomial())

unimputed_weighted_female$degf <- 68
unimputed_female_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = unimputed_weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(unimputed_male_model)
female_predicted_probabilities <- generate_predicted_probabilities(unimputed_female_model)

calibration(male_predicted_probabilities, model.frame(unimputed_male_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(unimputed_female_model)$highbp14090_adj)

# Fit reduced male and female models with unimputed data and see effect
unimputed_weighted_male$degf <- 68
unimputed_male_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = unimputed_weighted_male, family = quasibinomial())

unimputed_weighted_female$degf <- 68
unimputed_female_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = unimputed_weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(unimputed_male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(unimputed_female_reduced_model)

calibration(male_predicted_probabilities, model.frame(unimputed_male_reduced_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(unimputed_female_reduced_model)$highbp14090_adj)
```

### Sensitivity analyses (outliers)

```{r, warning = FALSE, message = FALSE}
# Reobtain imputed data and centered objects but don't truncate anything
imputed_cycles1to6_data <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))
imputed_cycles1to6_data$clinicid <- cycles1to6_data$clinicid

names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw))

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

cont_variables <- c("clc_age", "minperweek", "totalfv", "slp_11")

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}

# Fit full male and female models with outliers and see effect
weighted_male$degf <- 68
untruncated_male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
untruncated_female_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(untruncated_male_model)
female_predicted_probabilities <- generate_predicted_probabilities(untruncated_female_model)

calibration(male_predicted_probabilities, model.frame(untruncated_male_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(untruncated_female_model)$highbp14090_adj)

# Fit reduced male and female models with outliers and see effect
weighted_male$degf <- 68
untruncated_male_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
untruncated_female_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(untruncated_male_reduced_model)
female_predicted_probabilities <- generate_predicted_probabilities(untruncated_female_reduced_model)

calibration(male_predicted_probabilities, model.frame(untruncated_male_reduced_model)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(untruncated_female_reduced_model)$highbp14090_adj)
```

### Sensitivity analyses (BMI and WHR together)

```{r, warning = FALSE, message = FALSE}
# Reobtain imputed, truncated data and centered objects
imputed_cycles1to6_data <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))
imputed_cycles1to6_data$clinicid <- cycles1to6_data$clinicid

names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw))

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

imputed_cycles1to6_data <- truncate_skewed(imputed_cycles1to6_data)

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}

# Fit full male and female models with WHR and its interactions re-included and see effect
weighted_male$degf <- 68
male_model_whr <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), design = weighted_male, family = quasibinomial())

weighted_female$degf <- 68
female_model_whr <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), design = weighted_female, family = quasibinomial())

male_predicted_probabilities <- generate_predicted_probabilities(male_model_whr)
female_predicted_probabilities <- generate_predicted_probabilities(female_model_whr)

calibration(male_predicted_probabilities, model.frame(male_model_whr)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_model_whr)$highbp14090_adj)
```

### Sensitivity analysis (linear interactions)

```{r, warning = FALSE, message = FALSE}
# Reset male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))
female_data <- female_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

# Fit full models with linear interactions and see effect
male_final_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + clc_age*gen_045 + clc_age*hwmdbmi + clc_age*minperweek + clc_age*smoke + clc_age*slp_11 + clc_age*diabx + clc_age*ckd, data = male_data, family = binomial(), weights = wgt_full)

female_final_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + clc_age*gen_045 + clc_age*hwmdbmi + clc_age*minperweek + clc_age*smoke + clc_age*slp_11 + clc_age*diabx + clc_age*ckd, data = female_data, family = binomial(), weights = wgt_full)

male_predicted_probabilities <- generate_predicted_probabilities(male_final_model_linint)
female_predicted_probabilities <- generate_predicted_probabilities(female_final_model_linint)

calibration(male_predicted_probabilities, model.frame(male_final_model_linint)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_final_model_linint)$highbp14090_adj)

# Fit reduced models with linear interactions and see effect
male_final_reduced_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + clc_age*hwmdbmi + clc_age*diabx, family = quasibinomial(), data = male_data, weights = wgt_full)

female_final_reduced_model_linint <- glm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + clc_age*hwmdbmi + clc_age*diabx, family = quasibinomial(), data = female_data, weights = wgt_full)

male_predicted_probabilities <- generate_predicted_probabilities(male_final_reduced_model_linint)
female_predicted_probabilities <- generate_predicted_probabilities(female_final_reduced_model_linint)

calibration(male_predicted_probabilities, model.frame(male_final_reduced_model_linint)$highbp14090_adj)
calibration(female_predicted_probabilities, model.frame(female_final_reduced_model_linint)$highbp14090_adj)

# See effect on S-ORs and CIs for new full male model
male_data <- male_data %>% 
  dplyr::select(recodeflow:::select_vars_by_role(c("Predictor"), my_variables)) %>%
  dplyr::select(-whr)

male_explainer <- iml::Predictor$new(
   model = male_final_model_linint,                                # Pass the model
   data = male_data,                                               # Pass the data
   y = male_data[["highbp14090_adj"]]                              # Indicate outcome
)

set.seed(123)
male_shap_list <- list()

for (i in 1:nrow(male_data)) {
    observation <- male_data[i, , drop = FALSE]
    male_shap_values <- iml::Shapley$new(male_explainer, x.interest = observation)
    male_shap_list[[i]] <- male_shap_values$results
}

all_male_shap_values_linint <- do.call(rbind, male_shap_list)

predictors <- recodeflow:::select_vars_by_role(c("Predictor"), my_variables)
predictors <- predictors[predictors != "whr"]

for (pred in predictors) {
  print(calculate_shap_or_ci(all_male_shap_values_linint, pred))
}

# See effect on S-ORs and CIs for new full female model
female_data <- female_data %>% 
  dplyr::select(recodeflow:::select_vars_by_role(c("Predictor"), my_variables)) %>%
  dplyr::select(-whr)

female_explainer <- iml::Predictor$new(
   model = female_final_model_linint,                               # Pass the model
   data = female_data,                                              # Pass the data
   y = female_data[["highbp14090_adj"]]                             # Indicate outcome
)

set.seed(123)
female_shap_list <- list()

for (i in 1:nrow(female_data)) {
    observation <- female_data[i, , drop = FALSE]
    female_shap_values <- iml::Shapley$new(female_explainer, x.interest = observation)
    female_shap_list[[i]] <- female_shap_values$results
}

all_female_shap_values_linint <- do.call(rbind, female_shap_list)

predictors <- recodeflow:::select_vars_by_role(c("Predictor"), my_variables)
predictors <- predictors[predictors != "whr"]

for (pred in predictors) {
  print(calculate_shap_or_ci(all_female_shap_values_linint, pred))
}

# See effect on age interaction OR plots
for (var in age_cat_int_variables) {
  print(plot_age_int_or(
    model = male_final_model_linint,
    var = var,
    var_type = "categorical",
    sex_label = "men",
    title_labels = title_labels,
    legend_labels = legend_labels,
    level_labels = level_labels
  ))
  
  print(plot_age_int_or(
    model = female_final_model_linint,
    var = var,
    var_type = "categorical",
    sex_label = "women",
    title_labels = title_labels,
    legend_labels = legend_labels,
    level_labels = level_labels
  ))
}

for (var in age_cont_int_variables) {
  print(plot_age_int_or(
    model = male_final_model_linint,
    var = var,
    var_type = "continuous",
    design = weighted_male,
    sex_label = "men",
    title_labels = title_labels,
    legend_labels = legend_labels
  ))

  print(plot_age_int_or(
    model = female_final_model_linint,
    var = var,
    var_type = "continuous",
    design = weighted_female,
    sex_label = "women",
    title_labels = title_labels,
    legend_labels = legend_labels
  ))
}
```
