---
title: "Centering HTNPoRT Models"
author: "Rafidul Islam"
date: 2025-08-24
format: 
  html:
    toc: true
    html-math-method: katex
    css: styles.css
editor: visual
---

## Load packages and functions

```{r}
#| warning: false
#| message: false
#| output: false

.libPaths("P:/10619/Rpackages")
library(dplyr)
library(rms)

source("R/descriptive-functions.R")
source("R/centering-utils.R") 
# functions in "centering-utils.R"
# get_rcs: implement the formula of rcs components
# step_dummy: dummy variables
# step_rcs: rcs
# step_interaction: interaction terms
# step_center: centering
# get_mean: get mean values from the original dataset
# root.search: Root searching, not in use in this .qmd file
```

## Prepare imputed dataset

```{r}
# Synthetic dataset for test use outside RDC
# set.seed(123)
# imputed_cycles1to6_data <- data.frame(
#   highbp14090_adj = sample(1:2, 1000, replace = TRUE), # Binary hypertension outcome
#   highbp14090 = sample(1:2, 1000, replace = TRUE), # Binary unadjusted hypertension outcome
#   control14090_adj = sample(1:2, 1000, replace = TRUE), # Binary controlled hypertension outcome
#   control14090 = sample(1:2, 1000, replace = TRUE), # Binary controlled and unadjusted hypertension outcome
#   ccc_51 = sample(1:2, 1000, replace = TRUE), # Binary self-reported diabetes
#   ckd = sample(1:2, 1000, replace = TRUE), # Binary chronic kidney disease
#   edudr04 = sample(1:3, 1000, replace = TRUE), # Categorical education
#   fmh_15 = sample(1:2, 1000, replace = TRUE), # Binary family history
#   gendmhi = sample(1:2, 1000, replace = TRUE), # Categorical self-rated mental health
#   gen_025 = sample(1:2, 1000, replace = TRUE), # Binary self-perceived stress
#   gen_045 = sample(1:2, 1000, replace = TRUE), # Binary sense of belonging
#   low_drink_score1 = sample(1:4, 1000, replace = TRUE), # Categorical alcohol consumption level
#   married = sample(1:3, 1000, replace = TRUE), # Categorical marital status
#   smoke = sample(1:3, 1000, replace = TRUE), # Categorical smoking status
#   working = sample(1:2, 1000, replace = TRUE), # Binary working status
#   clc_sex = sample(1:2, 1000, replace = TRUE), # Binary sex
#   wgt_full = runif(1000, 0, 1), # Numeric weights
#   clc_age = sample(20:79, 1000, replace = TRUE), # Integer age
#   hwmdbmi = runif(1000, 9.47, 56.77), # Numeric body mass index
#   minperweek = runif(1000, 0, 2004), # Numeric physical activity minutes
#   totalfv = runif(1000, 0, 20), # Numeric fruit and vegetable consumption
#   whr = runif(1000, 25, 100), # Numeric waist-to-height ratio
#   slp_11 = runif(1000, 2, 18), # Numeric sleep duration
#   diabx = sample(1:2, 1000, replace = TRUE), # Binary overall diabetes
#   cycle = sample(1:6, 1000, replace = TRUE), # Cycle variable ranging from 1 to 6
#   anymed2 = sample(0:1, 1000, replace = TRUE), # Binary HTN medication (derived)
#   ccc_32 = sample(1:2, 1000, replace = TRUE), # Binary HTN medication (self-reported)
#   cardiov = sample(1:2, 1000, replace = TRUE), # Binary CVD
#   adj_hh_inc = runif(1000, 20000, 150000), # Numeric income
#   agegroup4 = sample(1:4, 1000, replace = TRUE), # Categorical age group
#   alcdwky = sample(0:84, 1000, replace = TRUE), # Integer alcohol consumption per week
#   bmigroup = sample(1:4, 1000, replace = TRUE), # Categorical BMI group
#   gendhdi = sample(0:4, 1000, replace = TRUE), # Categorical self-rated health
#   gfr = runif(1000, 6, 240), # Numeric glomerular filtration rate
#   hwm_13kg = runif(1000, 42.0, 176.5), # Numeric weight in kg
#   hwm_14cx = runif(1000, 61.4, 162.5), # Numeric waist circumference in cm
#   img_03 = sample(1:2, 1000, replace = TRUE), # Binary immigration variable
#   lab_bpb = runif(1000, 0.009, 1.2), # Numeric blood lead measurement
#   lab_hba1 = runif(1000, 0.042, 0.130), # Numeric HbA1c
#   mvpa150wk = sample(1:2, 1000, replace = TRUE), # Binary moderate-vigorous activity
#   nonhdltodd = sample(1:2, 1000, replace = TRUE), # Binary non-HDL cholesterol
#   gooddiet = sample(1:2, 1000, replace = TRUE), # Binary poor diet indicator
#   pgdcgt = sample(1:13, 1000, replace = TRUE), # Categorical ethnicity
#   bsw1 = runif(1000, 0, 1), # Numeric bootstrap weights
#   bsw2 = runif(1000, 0, 1) # Numeric bootstrap weights
# )

# Truncate skewed continuous variables if necessary
imputed_cycles1to6_data <- truncate_skewed(imputed_cycles1to6_data)

# Recode 2s as 0s in binary predictors and factorize all categorical predictors
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(
    highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
    highbp14090 = ifelse(highbp14090 == 2, 0, highbp14090),
    control14090_adj = ifelse(control14090_adj == 2, 0, control14090_adj),
    ckd = ifelse(ckd == 2, 0, ckd),
    diabx = ifelse(diabx == 2, 0, diabx),
    fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
    gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
    edudr04 = case_when(
      edudr04 == 1 ~ 2,
      edudr04 == 2 ~ 1,
      edudr04 == 3 ~ 0
    ),
    smoke = case_when(
      smoke == 1 ~ 2,
      smoke == 2 ~ 1,
      smoke == 3 ~ 0
    )
  )

cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

# Separate male data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)
```

## Center male models

Do ctrl+F to change from male to male.

```{r}
# -------- dummy variables --------
male_data <- step_dummy(male_data, cat_variables)

# -------- rcs --------
# age
k_age <- 4
rcs.fit <- rcs(male_data$clc_age, k_age)
knots_age <- attributes(rcs.fit)$parms # knot locations
# BMI
k_bmi <- 3
rcs.fit <- rcs(male_data$hwmdbmi, k_bmi)
knots_bmi <- attributes(rcs.fit)$parms # knot locations
# exercise
k_exercise <- 3
rcs.fit <- rcs(male_data$minperweek, k_exercise)
knots_exercise <- attributes(rcs.fit)$parms # knot locations
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
male_data <- step_rcs(male_data, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
male_data <- step_interaction(male_data, interaction_list)

# Apply survey weights to original data
male_data <- male_data %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

# Get weighted mean values from the ORIGINAL dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

means <- get_mean(weighted_male, vars_mean)

# centering vars in the ORIGINAL dataset
vars_center <- names(means)
male_data_c <- step_center(male_data, vars_center, means)

# Obtain weighted and centered full and reduced models
male_data_c <- male_data_c %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj)) %>%
  dplyr::mutate(wgt_full = wgt_full / mean(wgt_full))

male_replicate_weights <- male_data_c %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male_c <- male_data_c %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68
male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 +  rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())

weighted_male$degf <- 68
male_reduced_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + fmh_15 + rcs(hwmdbmi, 3) + diabx + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*diabx, design = weighted_male, family = quasibinomial())

weighted_male_c$degf <- 68
male_model_c <- survey::svyglm(highbp14090_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + married_2_C + married_3_C + edudr04_1_C + edudr04_2_C + working_2_C + gendmhi_1_C + gen_025_2_C + gen_045_2_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + low_drink_score1_2_C + low_drink_score1_3_C + low_drink_score1_4_C + minperweek_rcs_1_C + minperweek_rcs_2_C + smoke_1_C + smoke_2_C + slp_11_C + totalfv_C + diabx_1_C + ckd_1_C + clc_age_rcs_1_by_gen_045_2_C + clc_age_rcs_2_by_gen_045_2_C + clc_age_rcs_3_by_gen_045_2_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_minperweek_rcs_1_C + 
clc_age_rcs_2_by_minperweek_rcs_1_C + clc_age_rcs_3_by_minperweek_rcs_1_C + 
clc_age_rcs_1_by_minperweek_rcs_2_C + clc_age_rcs_2_by_minperweek_rcs_2_C + 
clc_age_rcs_3_by_minperweek_rcs_2_C + clc_age_rcs_1_by_smoke_1_C + 
clc_age_rcs_2_by_smoke_1_C + clc_age_rcs_3_by_smoke_1_C + clc_age_rcs_1_by_smoke_2_C + clc_age_rcs_2_by_smoke_2_C + clc_age_rcs_3_by_smoke_2_C + 
clc_age_rcs_1_by_slp_11_C + clc_age_rcs_2_by_slp_11_C + clc_age_rcs_3_by_slp_11_C +
clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C + clc_age_rcs_1_by_ckd_1_C + clc_age_rcs_2_by_ckd_1_C + clc_age_rcs_3_by_ckd_1_C, design = weighted_male_c, family = quasibinomial())

weighted_male_c$degf <- 68
male_reduced_model_c <- survey::svyglm(highbp14090_adj ~ clc_age_rcs_1_C + clc_age_rcs_2_C + clc_age_rcs_3_C + fmh_15_1_C + hwmdbmi_rcs_1_C + hwmdbmi_rcs_2_C + diabx_1_C + clc_age_rcs_1_by_hwmdbmi_rcs_1_C + clc_age_rcs_2_by_hwmdbmi_rcs_1_C + clc_age_rcs_3_by_hwmdbmi_rcs_1_C +  clc_age_rcs_1_by_hwmdbmi_rcs_2_C + clc_age_rcs_2_by_hwmdbmi_rcs_2_C + clc_age_rcs_3_by_hwmdbmi_rcs_2_C + clc_age_rcs_1_by_diabx_1_C + clc_age_rcs_2_by_diabx_1_C + 
clc_age_rcs_3_by_diabx_1_C, design = weighted_male_c, family = quasibinomial())

cbind(coef(male_model), coef(male_model_c))
predict(male_model, type = "response") - predict(male_model_c, type = "response")

cbind(coef(male_reduced_model), coef(male_reduced_model_c))
predict(male_reduced_model, type = "response") - predict(male_reduced_model_c, type = "response")
```

## Export model parameters

Do ctrl+F to change from male to male.

### Beta coefficients and their standard errors of centered models:

```{r}
male_centered_betas <- extract_beta_coefs(male_model_c)
male_reduced_centered_betas <- extract_beta_coefs(male_reduced_model_c)

write.csv(male_centered_betas, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Male Full Model Betas.csv")
write.csv(male_reduced_centered_betas, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Male Reduced Model Betas.csv")
```

### Beta coefficients and their standard errors of centered bootstrap models:

```{r}
bootstrap_coefs <- function(data, indices, model) {
  # Create bootstrap sample
  boot_data <- data[indices, ]
  
  # Recreate survey design
  boot_design <- survey::svydesign(ids = ~1, weights = ~wgt_full, data = boot_data)
  
  # Refit model
  boot_model <- update(model, data = boot_data, design = boot_design)
  
  # Return coefficients
  return(coef(boot_model))
}

n_bootstrap <- 1000
set.seed(123)

bootstrap_coefs_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data_c), replace = TRUE)
  bootstrap_coefs(male_data_c, boot_indices, male_model_c)
}, simplify = FALSE)

coef_matrix_male <- do.call(rbind, bootstrap_coefs_male)
rownames(coef_matrix_male) <- paste0("bootstrap_", 1:n_bootstrap)

write.csv(coef_matrix_male, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Bootstrap Betas/Male Full Model Bootstrap Betas.csv", row.names = TRUE)

bootstrap_coefs_male_reduced <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data_c), replace = TRUE)
  bootstrap_coefs(male_data_c, boot_indices, male_reduced_model_c)
}, simplify = FALSE)

coef_matrix_male_reduced <- do.call(rbind, bootstrap_coefs_male_reduced)
rownames(coef_matrix_male_reduced) <- paste0("bootstrap_", 1:n_bootstrap)

write.csv(coef_matrix_male_reduced, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Bootstrap Betas/Male Reduced Model Bootstrap Betas.csv", row.names = TRUE)
```

### Validation data with components separated and prediction values:

Comment out male knots and means, and uncomment female knots and means to switch.

```{r}
set.seed(123)
male_validation_data <- data.frame(
  clc_age = sample(20:79, 10000, replace = TRUE),
  married = factor(sample(1:3, 10000, replace = TRUE)),
  edudr04 = factor(sample(0:2, 10000, replace = TRUE)),
  working = factor(sample(1:2, 10000, replace = TRUE)),
  gendmhi = factor(sample(0:1, 10000, replace = TRUE)),
  gen_025 = factor(sample(1:2, 10000, replace = TRUE)),
  gen_045 = factor(sample(1:2, 10000, replace = TRUE)),
  fmh_15 = factor(sample(0:1, 10000, replace = TRUE)),
  hwmdbmi = runif(10000, 13.8, 49),
  low_drink_score1 = factor(sample(1:4, 10000, replace = TRUE)),
  minperweek = runif(10000, 0, 795),
  smoke = factor(sample(0:2, 10000, replace = TRUE)),
  slp_11 = runif(10000, 2, 18),
  totalfv = runif(10000, 0, 10),
  diabx = factor(sample(0:1, 10000, replace = TRUE)),
  ckd = factor(sample(0:1, 10000, replace = TRUE))
)

# -------- dummy variables --------
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
male_validation_data <- step_dummy(male_validation_data, cat_variables)

# -------- rcs --------
# age
knots_age <- c(24, 40, 57, 74) # male
# knots_age <- c(25, 40, 57, 75) # female
# BMI
knots_bmi <- c(22.35, 27.24, 34.178) # male
# knots_bmi <- c(20.69, 26.23, 36.141) # female
# exercise
knots_exercise <- c(9, 103, 326) # male
# knots_exercise <- c(1, 89, 290) # female
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
male_validation_data <- step_rcs(male_validation_data, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
male_validation_data <- step_interaction(male_validation_data, interaction_list)

# Get weighted mean values from the dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

# male
means <- c(
  46.14509835, 10.41999141, 2.012829724, 0.085947731, 0.248462597,
  0.217177205, 0.125063569, 0.258671725, 0.066840869, 0.228373362,
  0.349876734, 0.524803077, 27.66777298, 2.529042313, 0.777985051,
  0.045626893, 0.072198781, 147.6496834, 53.84564875, 0.308696985,
  0.227724746, 7.015035776, 3.280091672, 0.104918358, 0.044784256,
  15.14081401, 2.855721362, 0.518839488, 1289.586153, 294.9641651,
  56.95945766, 121.6744825, 28.59310879, 5.458573727, 6383.426259,
  1151.285813, 200.1725572, 2295.79088, 396.7168969, 67.65261735,
  16.42423635, 4.962600721, 1.036863773, 9.689177061, 1.65996114,
  0.282951234, 323.9788677, 74.51391132, 14.59326186, 6.145555691,
  2.19318601, 0.472921201, 2.811431457, 1.26078209, 0.307342769
)

# female
# means <- c(
#   46.89545843, 10.12555934, 2.151608321, 0.147107554, 0.210100305,
#   0.193357648, 0.099653209, 0.353413901, 0.088527417, 0.257966189,
#   0.342661718, 0.573552958, 27.0963796, 2.687938152, 0.753166452,
#   0.03853446, 0.03202675, 126.2691998, 49.59317196, 0.272198263,
#   0.165152547, 7.176308826, 3.700420139, 0.073367263, 0.057604582,
#   15.29680233, 2.877391597, 0.572698397, 1285.110359, 282.7253824,
#   60.12236359, 131.3924734, 29.62929288, 6.184663944, 5569.647047,
#   972.9401839, 186.0587491, 2174.213295, 375.6339899, 70.87545919,
#   14.19872096, 3.733773656, 0.824769535, 7.276738258, 1.206667012,
#   0.221478809, 336.01649, 73.01912727, 15.59617795, 4.268397084,
#   1.361402486, 0.314536375, 3.693735889, 1.553035432, 0.402545106
# )

# centering vars in the dataset
names(means) <- vars_mean
vars_center <- names(means)
male_validation_data <- step_center(male_validation_data, vars_center, means)

# Add centered model predictions to dataset
male_validation_data$full_predicted <- predict(male_model_c, newdata = male_validation_data, type = "response")
male_validation_data$reduced_predicted <- predict(male_reduced_model_c, newdata = male_validation_data, type = "response")
write.csv(male_validation_data, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Validation Data/Male Validation Data.csv", row.names = TRUE)
```

### Vascular age

```{r}
# Male dataset
male_vasc_age <- data.frame(
  clc_age = 20:79,
  married = factor(1, levels = 1:3),
  edudr04 = factor(0, levels = 0:2),
  working = factor(1, levels = 1:2),
  gendmhi = factor(0, levels = 0:1),
  gen_025 = factor(1, levels = 1:2),
  gen_045 = factor(1, levels = 1:2),
  fmh_15 = factor(0, levels = 0:1),
  hwmdbmi = 27.66777,
  low_drink_score1 = factor(1, levels = 1:4),
  minperweek = 147.6497,
  smoke = factor(0, levels = 0:2),
  slp_11 = 7.015036,
  totalfv = 3.280092,
  diabx = factor(0, levels = 0:1),
  ckd = factor(0, levels = 0:1)
)

# -------- dummy variables --------
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
male_vasc_age <- step_dummy(male_vasc_age, cat_variables)

# -------- rcs --------
# age
knots_age <- c(24, 40, 57, 74)
# BMI
knots_bmi <- c(22.35, 27.24, 34.178)
# exercise
knots_exercise <- c(9, 103, 326)
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
male_vasc_age <- step_rcs(male_vasc_age, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
male_vasc_age <- step_interaction(male_vasc_age, interaction_list)

# Get weighted mean values from the dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

means <- c(
  46.14509835, 10.41999141, 2.012829724, 0.085947731, 0.248462597,
  0.217177205, 0.125063569, 0.258671725, 0.066840869, 0.228373362,
  0.349876734, 0.524803077, 27.66777298, 2.529042313, 0.777985051,
  0.045626893, 0.072198781, 147.6496834, 53.84564875, 0.308696985,
  0.227724746, 7.015035776, 3.280091672, 0.104918358, 0.044784256,
  15.14081401, 2.855721362, 0.518839488, 1289.586153, 294.9641651,
  56.95945766, 121.6744825, 28.59310879, 5.458573727, 6383.426259,
  1151.285813, 200.1725572, 2295.79088, 396.7168969, 67.65261735,
  16.42423635, 4.962600721, 1.036863773, 9.689177061, 1.65996114,
  0.282951234, 323.9788677, 74.51391132, 14.59326186, 6.145555691,
  2.19318601, 0.472921201, 2.811431457, 1.26078209, 0.307342769
)

# centering vars in the dataset
names(means) <- vars_mean
vars_center <- names(means)
male_vasc_age <- step_center(male_vasc_age, vars_center, means)

# Add centered model predictions (aka vascular ages) to dataset
male_vasc_age$vasc_age_full <- predict(male_model_c, newdata = male_vasc_age, type = "response")
male_vasc_age$vasc_age_reduced <- predict(male_reduced_model_c, newdata = male_vasc_age, type = "response")
male_vasc_age <- male_vasc_age[, c("clc_age", "vasc_age_full", "vasc_age_reduced")]
write.csv(male_vasc_age, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Vascular Age/Male Vascular Age", row.names = TRUE)

# Female dataset
female_vasc_age <- data.frame(
  clc_age = 20:79,
  married = factor(1, levels = 1:3),
  edudr04 = factor(0, levels = 0:2),
  working = factor(1, levels = 1:2),
  gendmhi = factor(0, levels = 0:1),
  gen_025 = factor(1, levels = 1:2),
  gen_045 = factor(1, levels = 1:2),
  fmh_15 = factor(0, levels = 0:1),
  hwmdbmi = 27.09638,
  low_drink_score1 = factor(1, levels = 1:4),
  minperweek = 126.2692,
  smoke = factor(0, levels = 0:2),
  slp_11 = 7.176309,
  totalfv = 3.70042,
  diabx = factor(0, levels = 0:1),
  ckd = factor(0, levels = 0:1)
)

# -------- dummy variables --------
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
female_vasc_age <- step_dummy(female_vasc_age, cat_variables)

# -------- rcs --------
knots_age <- c(25, 40, 57, 75)
knots_bmi <- c(20.69, 26.23, 36.141)
knots_exercise <- c(1, 89, 290)
# unpack rcs
vars_rcs <- c("clc_age", "hwmdbmi", "minperweek")
knots_list <- list(knots_age, knots_bmi, knots_exercise)
knots_list <- setNames(knots_list, vars_rcs)
female_vasc_age <- step_rcs(female_vasc_age, vars_rcs, knots_list)

# -------- interaction terms --------
interaction_list <- list(
  c("clc_age", "gen_045"),
  c("clc_age", "hwmdbmi"),
  c("clc_age", "minperweek"),
  c("clc_age", "smoke"),
  c("clc_age", "slp_11"),
  c("clc_age", "diabx"),
  c("clc_age", "ckd")
)
female_vasc_age <- step_interaction(female_vasc_age, interaction_list)

# Get weighted mean values from the dataset
vars_mean <- c("clc_age_rcs_1", "clc_age_rcs_2", "clc_age_rcs_3", "married_2", "married_3", "edudr04_1", "edudr04_2", "working_2", "gendmhi_1", "gen_025_2", "gen_045_2", "fmh_15_1", "hwmdbmi_rcs_1", "hwmdbmi_rcs_2", "low_drink_score1_2", "low_drink_score1_3", "low_drink_score1_4", "minperweek_rcs_1", "minperweek_rcs_2",
"smoke_1", "smoke_2", "slp_11", "totalfv", "diabx_1", "ckd_1", "clc_age_rcs_1_by_gen_045_2", "clc_age_rcs_2_by_gen_045_2", "clc_age_rcs_3_by_gen_045_2", "clc_age_rcs_1_by_hwmdbmi_rcs_1", "clc_age_rcs_2_by_hwmdbmi_rcs_1", "clc_age_rcs_3_by_hwmdbmi_rcs_1", "clc_age_rcs_1_by_hwmdbmi_rcs_2", "clc_age_rcs_2_by_hwmdbmi_rcs_2", "clc_age_rcs_3_by_hwmdbmi_rcs_2", "clc_age_rcs_1_by_minperweek_rcs_1", "clc_age_rcs_2_by_minperweek_rcs_1", "clc_age_rcs_3_by_minperweek_rcs_1",
"clc_age_rcs_1_by_minperweek_rcs_2", "clc_age_rcs_2_by_minperweek_rcs_2", "clc_age_rcs_3_by_minperweek_rcs_2", "clc_age_rcs_1_by_smoke_1", "clc_age_rcs_2_by_smoke_1", "clc_age_rcs_3_by_smoke_1", "clc_age_rcs_1_by_smoke_2", "clc_age_rcs_2_by_smoke_2", "clc_age_rcs_3_by_smoke_2", "clc_age_rcs_1_by_slp_11", "clc_age_rcs_2_by_slp_11", "clc_age_rcs_3_by_slp_11", "clc_age_rcs_1_by_diabx_1", "clc_age_rcs_2_by_diabx_1", "clc_age_rcs_3_by_diabx_1", "clc_age_rcs_1_by_ckd_1", "clc_age_rcs_2_by_ckd_1", "clc_age_rcs_3_by_ckd_1")

means <- c(
  46.89545843, 10.12555934, 2.151608321, 0.147107554, 0.210100305,
  0.193357648, 0.099653209, 0.353413901, 0.088527417, 0.257966189,
  0.342661718, 0.573552958, 27.0963796, 2.687938152, 0.753166452,
  0.03853446, 0.03202675, 126.2691998, 49.59317196, 0.272198263,
  0.165152547, 7.176308826, 3.700420139, 0.073367263, 0.057604582,
  15.29680233, 2.877391597, 0.572698397, 1285.110359, 282.7253824,
  60.12236359, 131.3924734, 29.62929288, 6.184663944, 5569.647047,
  972.9401839, 186.0587491, 2174.213295, 375.6339899, 70.87545919,
  14.19872096, 3.733773656, 0.824769535, 7.276738258, 1.206667012,
  0.221478809, 336.01649, 73.01912727, 15.59617795, 4.268397084,
  1.361402486, 0.314536375, 3.693735889, 1.553035432, 0.402545106
)

# centering vars in the dataset
names(means) <- vars_mean
vars_center <- names(means)
female_vasc_age <- step_center(female_vasc_age, vars_center, means)

# Add centered model predictions (aka vascular ages) to dataset
female_vasc_age$vasc_age_full <- predict(female_model_c, newdata = female_vasc_age, type = "response")
female_vasc_age$vasc_age_reduced <- predict(female_reduced_model_c, newdata = female_vasc_age, type = "response")
female_vasc_age <- female_vasc_age[, c("clc_age", "vasc_age_full", "vasc_age_reduced")]
write.csv(female_vasc_age, file = "P:/10619/Dropbox/htnport/vignettes/New Modelling Output/Model Presentation Output/Parameters/svyglm/Vascular Age/Female Vascular Age", row.names = TRUE)
```

