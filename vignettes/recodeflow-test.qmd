---
title: "Recodeflow test"
format: html
---

Loading required packages and functions
```{r}
library(readr)
library(here)
library(huiport)
library(dplyr)
library(recodeflow)
library(haven)

# Ensure to set working directory to your local directory of repo, then uncomment these
# source("R/blood-pressure.R")
# source("R/kidney.R")
# source("R/get-descriptive-data.R")
# source("R/create-descriptive-table.R")
```


1.  Create CHMS synthetic data with missing values. Name of synthetic data has to be name of exact database in order for use in recodeflow. Using only age and sex to keep it simple.

```{r}
# Create synthetic data with missing values
n <- 100  # Number of observations
set.seed(123)  # Set seed for reproducibility

# Generate random ages between 18 and 75, with some missing values [996-999]
ages <- sample(c(18:75, 996:999), n, replace = TRUE)

# Generate random sexes (1 for male, 2 for female, with some missing values [6-9])
sexes <- sample(c(1:2, 6:9), n, replace = TRUE)

# Generate random systolic blood pressures between 80 and 215, with some missing values [996-999]
systolic_bps <- sample(c(80:215, 996:999), n, replace = TRUE)

# Generate random diastolic blood pressures between 50 and 150, with some missing values [996-999]
diastolic_bps <- sample(c(50:150, 996:999), n, replace = TRUE)

# Create a data frame named cycle6
cycle6 <- data.frame(CLC_AGE = ages, CLC_SEX = sexes, bpmdpbps = systolic_bps, bpmdpbpd = diastolic_bps)

# Print the first few rows of the cycle6 data
print(head(cycle6))
write_csv(cycle6, here::here("data", "cycle6.csv"))
names(cycle6) <- tolower(names(cycle6)) # Putting all headers to lowercase to ensure easy recoding (cycle6 only)
```

2.  Load variables and variable-details from worksheets folder.

```{r}
my_variables <- read.csv(here("worksheets", "variables.csv"))
my_variable_details <- read.csv(here("worksheets", "variable-details.csv"))
```

3.  Test recodeflow on fake CHMS data. Refer to console outputs to see results. What do you think?

```{r}
# Recoding basic variables
cycle6_ages <- recodeflow::rec_with_table(cycle6, "clc_age", variable_details = my_variable_details, log = TRUE)
cycle6_sexes <- recodeflow::rec_with_table(cycle6, "clc_sex", variable_details = my_variable_details, log = TRUE)

head(cycle6_ages)
head(cycle6_sexes)

# Recoding a transformed variable (cont to cat)
cycle6_categorical_ages <- recodeflow::rec_with_table(cycle6, "agegroup4", variable_details = my_variable_details, log = TRUE)
head(cycle6_categorical_ages)

# Recoding a derived variable
cycle6_adjusted_SBPs <- recodeflow::rec_with_table(cycle6, c("bpmdpbps", "sbp_adj"), variable_details = my_variable_details, log = TRUE)
head(cycle6_adjusted_SBPs)
```

4.  Generate a Table 1 for synthetic data.

```{r}
transformed_cycle6 <- recodeflow::rec_with_table(cycle6, variables = c("clc_age", "clc_sex", "bpmdpbps", "bpmdpbpd", "sbp_adj"), variable_details = my_variable_details, notes = FALSE) # It can transform multiple variables at once too!

table1_data <- get_descriptive_data(
  transformed_cycle6,
  my_variables,
  my_variable_details,
  # All the variables whose descriptive statistics we want
  c("clc_age", "clc_sex", "bpmdpbps", "bpmdpbpd", "sbp_adj"),
  # Sets the stratifier
  list("all" = list("clc_sex"))
)

create_descriptive_table( 
  table1_data,
  my_variables,
  my_variable_details,
  c("clc_age", "clc_sex", "bpmdpbps", "bpmdpbpd", "sbp_adj"), 
  column_stratifier = c("clc_sex")
)

```

5. Missing values and derived variables

```{r}
# 2 observations have missing data (one with missing ethnicity, and one with missing creatine - both needed to compute GFR later)
cycle5 <- data.frame(
  clc_sex = c(1, 2, 2),
  clc_age = c(60, 50, 40),
  pgdcgt = c(1, 96, 2),
  lab_bcre = c(50, 50, 9996)
)

my_variables <- read.csv(here("worksheets", "variables.csv"))
my_variable_details <- read.csv(here("worksheets", "variable-details.csv"))

# Recoding variables needed to compute GFR which will be used to determine CKD status
logan <- rec_with_table(cycle5, c("lab_bcre", "pgdcgt", "clc_sex", "clc_age", "gfr", "ckd"), variable_details = my_variable_details)
head(logan)

# Temporary fix -> convert factored NAs into "NA(b)"
recode_na_b <- function(column) {
  # Convert the column to character if it's a factor
  if (is.factor(column)) {
    column <- as.character(column)
  }
  # Replace NAs with "NA(b)"
  column[is.na(column)] <- "NA(b)"
  return(column)
}

logan$ckd <- recode_na_b(logan$ckd)

# Stratified table
table1_data <- get_descriptive_data(
  logan,
  my_variables,
  my_variable_details,
  # All the variables whose descriptive statistics we want
  c("lab_bcre", "pgdcgt", "clc_sex", "clc_age", "gfr", "ckd"),
  # Sets the stratifier
  list("all" = list("clc_sex"))
)

create_descriptive_table( 
  table1_data,
  my_variables,
  my_variable_details,
  c("lab_bcre", "pgdcgt", "clc_sex", "clc_age", "gfr", "ckd"), 
  column_stratifier = c("clc_sex")
)

# Unstratified table
table2_data <- get_descriptive_data(
  logan,
  my_variables,
  my_variable_details,
  # All the variables whose descriptive statistics we want
  c("lab_bcre", "pgdcgt", "clc_sex", "clc_age", "gfr", "ckd"),
  # Sets the stratifier
  list("all" = list())
)

create_unstratified_descriptive_table( 
  table2_data,
  my_variables,
  my_variable_details
)
```

6. Not asked missing category

```{r}
my_variables <- read.csv(here("worksheets", "variables.csv"))
my_variable_details <- read.csv(here("worksheets", "variable-details.csv"))

cycle4 <- data.frame(slp_11 = c(8, 99.7, tagged_na("c")), fmh_15 = c(1, 6, tagged_na("c")), clc_sex = c(1, 1, 2))

hello <- rec_with_table(cycle4, c("slp_11", "fmh_15", "clc_sex"), variable_details = my_variable_details)

table_data <- get_descriptive_data(
  hello,
  my_variables,
  my_variable_details,
  # All the variables whose descriptive statistics we want
  c("slp_11", "fmh_15"),
  # Sets the stratifier
  list("all" = list("clc_sex"))
)

create_descriptive_table( 
  table_data,
  my_variables,
  my_variable_details,
  c("slp_11", "fmh_15"),
  column_stratifier = c("clc_sex")
)
```