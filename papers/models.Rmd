---
title: "HTNPoRT Paper - Modelling"
author: "Rafidul Islam"
date: "27/11/2024"
output: pdf_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../dist/models") })
---

## 1. Load packages, functions, and metadeta

```{r, echo = false}
# Set working directory at RDC
setwd("P:/10619/Dropbox/htnport")

# Load packages and functions
.libPaths("P:/10619/Rpackages")
library(haven)
library(dplyr)
library(recodeflow)
library(survey)
library(srvyr)
library(e1071)
library(rms)
# library(iml)

source("R/descriptive-functions.R")
source("R/model-functions.R")
source("R/calibration.R")

# Load metadata
my_variables <- read.csv("P:/10619/Dropbox/htnport/worksheets/variables.csv")
my_variable_details <- read.csv("P:/10619/Dropbox/htnport/worksheets/variable-details.csv")
```

## 2. Load medication data and recode medication variables

```{r, echo = false}
# Load medication data
cycle1_meds <- read_sas("data/cycle1/cycle1-meds.sas7bdat")
names(cycle1_meds) <- tolower(names(cycle1_meds)) 
cycle2_meds <- read_sas("data/cycle2/cycle2-meds.sas7bdat")
cycle3_meds <- read_stata("data/cycle3/cycle3-meds.dta")
cycle4_meds <- read_stata("data/cycle4/cycle4-meds.dta")
names(cycle4_meds) <- tolower(names(cycle4_meds)) 
cycle5_meds <- read_stata("data/cycle5/cycle5-meds.dta")
cycle6_meds <- read_stata("data/cycle6/cycle6-meds.dta")
names(cycle6_meds) <- tolower(names(cycle6_meds)) 

# Recode medication variables from medication data
cycle1_medication_data <- recodeflow::rec_with_table(cycle1_meds, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
cycle2_medication_data <- recodeflow::rec_with_table(cycle2_meds, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
cycle3_medication_data <- recodeflow::rec_with_table(cycle3_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle4_medication_data <- recodeflow::rec_with_table(cycle4_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle5_medication_data <- recodeflow::rec_with_table(cycle5_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle6_medication_data <- recodeflow::rec_with_table(cycle6_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
```

## 3. Load overall data, flatten/merge medication data to overall data, and recode all variables from each cycle

```{r, echo = false}
# Load overall cycle data
cycle1 <- read_stata("data/cycle1/cycle1.dta")
cycle2 <- read_stata("data/cycle2/cycle2.dta")
cycle3 <- read_stata("data/cycle3/cycle3.dta")
cycle4 <- read_stata("data/cycle4/cycle4.dta")
cycle5 <- read_stata("data/cycle5/cycle5.dta")
cycle6 <- read_stata("data/cycle6/cycle6.dta")
names(cycle6) <- tolower(names(cycle6)) 

# Assign cycle variable to each cycle for imputation purposes
cycle1$cycle <- 1
cycle2$cycle <- 2
cycle3$cycle <- 3
cycle4$cycle <- 4
cycle5$cycle <- 5
cycle6$cycle <- 6

# Derive outcome medication criterion in medication data, and merge that data to overall cycle data
cycle1_medication_data$anymed2 <- as.numeric(as.character(cycle1_medication_data$anymed))
cycle2_medication_data$anymed2 <- as.numeric(as.character(cycle2_medication_data$anymed))

cycle1_medication_data$diab_drug2 <- as.numeric(as.character(cycle1_medication_data$diab_drug))
cycle2_medication_data$diab_drug2 <- as.numeric(as.character(cycle2_medication_data$diab_drug))

cycle1_medication_data <- dplyr::select(cycle1_medication_data, clinicid, anymed2, diab_drug2)
cycle2_medication_data <- dplyr::select(cycle2_medication_data, clinicid, anymed2, diab_drug2)

cycle1 <- merge(cycle1, cycle1_medication_data, by = "clinicid")
cycle2 <- merge(cycle2, cycle2_medication_data, by = "clinicid")
cycle3 <- process_long_medication_data(cycle3, cycle3_medication_data)
cycle4 <- process_long_medication_data(cycle4, cycle4_medication_data)
cycle5 <- process_long_medication_data(cycle5, cycle5_medication_data)
cycle6 <- process_long_medication_data(cycle6, cycle6_medication_data)

# Recode variables from each cycle
cycle1_data <- recodeflow::rec_with_table(cycle1, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle2_data <- recodeflow::rec_with_table(cycle2, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle3_data <- recodeflow::rec_with_table(cycle3, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle4_data <- recodeflow::rec_with_table(cycle4, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle5_data <- recodeflow::rec_with_table(cycle5, recodeflow:::select_vars_by_role(c("Recode"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle6_data <- recodeflow::rec_with_table(cycle6, recodeflow:::select_vars_by_role(c("Recode"), my_variables), variable_details = my_variable_details, log = TRUE)
```

## 4. Combine cycles to obtain sample, and merge extra exercise data and bootstrap weights to the sample data

```{r, echo = false}
# Combine cycles to obtain sample
cycles1to6_data <- cchsflow::merge_rec_data(cycle1_data, cycle2_data, cycle3_data, cycle4_data, cycle5_data, cycle6_data)
cycles1to6_data <- dplyr::filter(cycles1to6_data, insample == 1)

# Load and merge extra accelerometer data to sample data
tracey <- read_sas("data/From Tracy/CHMS_AM_validdays_1to3.sas7bdat")
tracey$clinicid <-tracey$CLINICID
tracey$mvpa_min <- tracey$avg_mvpa
tracey$minperweek <- minperday_to_minperweek(tracey$mvpa_min)
tracey <- subset(tracey, select = -c(CLINICID, avg_mvpa, adultPAG))

cycles1to6_data <- dplyr::left_join(cycles1to6_data, tracey, by = c("clinicid"))
cycles1to6_data <- cycles1to6_data %>%
  dplyr::mutate(mvpa_min = coalesce(mvpa_min.x, mvpa_min.y),
         minperweek = coalesce(minperweek.x, minperweek.y)) %>%
  dplyr::mutate(mvpa_min = ifelse(is.na(mvpa_min), haven::tagged_na("b"), mvpa_min),
         minperweek = ifelse(is.na(minperweek), haven::tagged_na("b"), minperweek)) %>%
  dplyr::select(c(clinicid, wgt_full, clc_sex, recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables)))
```

## 5. Reobtain imputed data and bootstrap weights, segregrate such data by sex, weight all data, and center variables.

```{r, echo = false}
# Impute data
set.seed(123)
imputed_cycles1to6_data <- impute_variables(cycles1to6_data, outcomes = recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))

# Load bootstrap weights for all cycles and merge them to imputed sample data
cycles1to6_bsw <- read_stata("data/cycles1to6_bsw.dta")
names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw)) 

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

# Synthetic dataset for test use outside RDC
# imputed_cycles1to6_data <- data.frame(
#   highbp14090_adj = sample(1:2, 9627, replace = TRUE), # Binary outcome
#   ccc_51 = sample(1:2, 9627, replace = TRUE), # Binary
#   ckd = sample(1:2, 9627, replace = TRUE), # Binary
#   edudr04 = sample(1:3, 9627, replace = TRUE), # 3 categories
#   fmh_15 = sample(1:2, 9627, replace = TRUE), # Binary
#   gendmhi = sample(1:2, 9627, replace = TRUE), # 3 categories
#   gen_025 = sample(1:2, 9627, replace = TRUE), # Binary
#   gen_045 = sample(1:2, 9627, replace = TRUE), # Binary
#   low_drink_score1 = sample(1:4, 9627, replace = TRUE), # 4 categories
#   married = sample(1:3, 9627, replace = TRUE), # 3 categories
#   smoke = sample(1:3, 9627, replace = TRUE), # Binary
#   working = sample(1:2, 9627, replace = TRUE), # Binary
#   clc_sex = sample(1:2, 9627, replace = TRUE), # Binary
#   wgt_full = runif(9627, 0, 1), # Continuous weights
#   clc_age = runif(9627, 18, 90), # Continuous
#   hwmdbmi = runif(9627, 18, 40), # Continuous
#   minperweek = runif(9627, 0, 2000), # Continuous
#   totalfv = runif(9627, 0, 10), # Continuous
#   whr = runif(9627, 0.5, 1.5), # Continuous
#   slp_11 = runif(9627, 4, 12), # Continuous
#   diabx = sample(1:2, 9627, replace = TRUE), # Binary
#   cycle = sample(1:6, 9627, replace = TRUE), # Cycle variable ranging from 1 to 6
#   anymed2 = sample(0:1, 9627, replace = TRUE), # Binary
#   ccc_32 = sample(1:2, 9627, replace = TRUE), # Binary
#   cardiov = sample(1:2, 9627, replace = TRUE), # Binary
#   adj_hh_inc = runif(9627, 20000, 150000), # Numeric income
#   agegroup4 = sample(c("2039", "4059", "6069", "7079"), 9627, replace = TRUE), # Categorical age group
#   alcdwky = sample(0:84, 9627, replace = TRUE), # Integer alcohol consumption per week
#   bmigroup = sample(1:4, 9627, replace = TRUE), # Categorical BMI group
#   gendhdi = sample(0:4, 9627, replace = TRUE), # Categorical health-disease index
#   gfr = runif(9627, 30, 120), # Numeric glomerular filtration rate
#   hwm_13kg = runif(9627, 40, 150), # Numeric weight in kg
#   hwm_14cx = runif(9627, 60, 200), # Numeric chest circumference in cm
#   img_03 = sample(1:2, 9627, replace = TRUE), # Binary image analysis variable
#   lab_bpb = runif(9627, 60, 160), # Numeric blood pressure measurement
#   lab_hba1 = runif(9627, 4, 14), # Numeric HbA1c
#   mvpa150wk = sample(1:2, 9627, replace = TRUE), # Binary moderate-vigorous activity
#   nonhdltodd = sample(1:2, 9627, replace = TRUE), # Binary non-HDL cholesterol
#   gooddiet = sample(1:2, 9627, replace = TRUE), # Binary poor diet indicator
#   pgdcgt = sample(1:13, 9627, replace = TRUE), # Categorical food group codes
#   bsw1 = runif(9627, 0, 1), # Continuous bootstrap weights
#   bsw2 = runif(9627, 0, 1) # Continuous bootstrap weights
# )

# Truncate skewed continuous variables if necessary
imputed_cycles1to6_data <- truncate_skewed(imputed_cycles1to6_data)

# Recode 2s as 0s in binary predictors and factorize all categorical predictors
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(highbp14090_adj = ifelse(highbp14090_adj == 2, 0, highbp14090_adj),
                ckd = ifelse(ckd == 2, 0, ckd),
                diabx = ifelse(diabx == 2, 0, diabx),
                fmh_15 = ifelse(fmh_15 == 2, 0, fmh_15),
                gendmhi = ifelse(gendmhi == 2, 0, gendmhi),
                edudr04 = case_when(
                  edudr04 == 1 ~ 2,
                  edudr04 == 2 ~ 1,
                  edudr04 == 3 ~ 0
                ),
                smoke = case_when(
                  smoke == 1 ~ 2,
                  smoke == 2 ~ 1,
                  smoke == 3 ~ 0
                ))

cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::mutate(across(all_of(cat_variables), as.factor))

# Separate male and female data
male_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 1)
female_data <- dplyr::filter(imputed_cycles1to6_data, clc_sex == 2)

# Apply survey weights to male and female data
male_replicate_weights <- male_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_male <- male_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(male_replicate_weights),
    type = "bootstrap"
  )

weighted_male$degf <- 68

female_replicate_weights <- female_data %>%
  dplyr::select(dplyr::starts_with("bsw")) %>%
  names()

weighted_female <- female_data %>%
  srvyr::as_survey_rep(
    weights = wgt_full,
    repweights = all_of(female_replicate_weights),
    type = "bootstrap"
  )

weighted_female$degf <- 68

# Center continious variables
cont_variables <- c("clc_age", "hwmdbmi", "minperweek", "totalfv", "whr", "slp_11")

for (var in cont_variables) {
  weighted_male$variables[[var]] <- center_cont_variable(var, weighted_male)
}
for (var in cont_variables) {
  weighted_female$variables[[var]] <- center_cont_variable(var, weighted_female)
}

# Center categorical variables
cat_variables <- c("ckd", "diabx", "edudr04", "fmh_15", "gendmhi", "gen_025", "gen_045", "low_drink_score1", "married", "smoke", "working")

for (var in cat_variables) {
  weighted_male$variables[[var]] <- center_cat_variable(var, weighted_male)
}
for (var in cat_variables) {
  weighted_female$variables[[var]] <- center_cat_variable(var, weighted_female)
}
```

## 6. Fit male and female models using weighted male and female data.

```{r}
# Fit male and female models
male_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), design = weighted_male, family = quasibinomial())

female_model <- survey::svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), design = weighted_female, family = quasibinomial())
```

## 7. Multicollinearity and linearity assessments

```{r}
# Multicollinearity assessment
simple_weighted_male <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = male_data
)

simple_weighted_female <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = female_data
)

calculate_simplified_vif(design = simple_weighted_male)
calculate_simplified_vif(design = simple_weighted_female)

# Refit male and female models without whr if high collinearity detected
# male_model <- svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 +  rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_male, family = quasibinomial())
# 
# female_model <- svyglm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd, design = weighted_female, family = quasibinomial())

# Linearity assessment for slp_11 and totalfv
plot(male_data$slp_11, male_model$fitted.values, xlab = "Hours slept per night", ylab = "Male model fitted values") 
plot(male_data$totalfv, male_model$fitted.values, xlab = "Times per day produce consumed", ylab = "Male model fitted values") 

plot(female_data$slp_11, female_model$fitted.values, xlab = "Hours slept per night", ylab = "Female model fitted values") 
plot(female_data$totalfv, female_model$fitted.values, xlab = "Times per day produce consumed", ylab = "Female model fitted values")
```

## 8. Fit male and female models using unweighted male and female data, and compare to weighted models

```{r}
# Fit unweighted models
male_model_unweighted <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), data = male_data, family = binomial())

female_model_unweighted <- glm(highbp14090_adj ~ rcs(clc_age, 4) + married + edudr04 + working + gendmhi + gen_025 + gen_045 + fmh_15 + rcs(hwmdbmi, 3) + rcs(whr, 3) + low_drink_score1 + rcs(minperweek, 3) + smoke + slp_11 + totalfv + diabx + ckd + rcs(clc_age, 4)*gen_045 + rcs(clc_age, 4)*rcs(hwmdbmi, 3) + rcs(clc_age, 4)*rcs(whr, 3) + rcs(clc_age, 4)*rcs(minperweek, 3) + rcs(clc_age, 4)*smoke + rcs(clc_age, 4)*slp_11 + rcs(clc_age, 4)*diabx + rcs(clc_age, 4)*ckd + rcs(hwmdbmi, 3)*rcs(whr, 3), data = female_data, family = binomial())

# Get ORs for male weighted and unweighted models
male_or_weighted <- get_or_table(male_model)
male_or_unweighted <- get_or_table(male_model_unweighted)

# Get ORs for female weighted and unweighted models
female_or_weighted <- get_or_table(female_model)
female_or_unweighted <- get_or_table(female_model_unweighted)

male_compare <- compare_ors(male_or_weighted, male_or_unweighted)
female_compare <- compare_ors(female_or_weighted, female_or_unweighted)

# View the comparison tables
print("Male Model ORs Comparison:")
print(male_compare)

print("Female Model ORs Comparison:")
print(female_compare)
```

## 9. Model specification

```{r}
# Apply stepdown function to male and female models
male_reduced_model <- stepdown(male_model, male_data)
female_reduced_model <- stepdown(female_model, female_data)

# Perform likelihood ratio tests to determine if reduced models are better fit (ie. p > 0.05)
lrt_svyglm(male_model, male_reduced_model, weighted_male)
lrt_svyglm(female_model, female_reduced_model, weighted_female)

# Develop null models for likelihood ratio tests below
male_null_model <- survey::svyglm(highbp14090_adj ~ 1, design = weighted_male, family = quasibinomial())
female_null_model <- survey::svyglm(highbp14090_adj ~ 1, design = weighted_female, family = quasibinomial())

# Perform likelihood ratio tests to determine overall significance of full models (ie. p < 0.05)
lrt_svyglm(male_model, male_null_model, weighted_male)
lrt_svyglm(female_model, female_null_model, weighted_female)

# Perform likelihood ratio tests to determine overall significance of reduced models (ie. p < 0.05)
lrt_svyglm(male_reduced_model, male_null_model, weighted_male)
lrt_svyglm(female_reduced_model, female_null_model, weighted_female)
```

## 10. Full model assessment for original sample

```{r}
# Generate predicted probabilities for full models
male_predicted_probabilities <- generate_predicted_probabilities(male_model, male_data)
female_predicted_probabilities <- generate_predicted_probabilities(female_model, female_data)

# Calibration plots with performance metrics
calibration(male_predicted_probabilities, male_data$highbp14090_adj)
calibration(female_predicted_probabilities, female_data$highbp14090_adj)

# Calibration in-the-whole and across percentiles
compare_probs(male_data, male_predicted_probabilities)
compare_probs(female_data, female_predicted_probabilities)
```

## 11. Reduced model assessment for original sample

```{r}
# Generate predicted probabilities for reduced models
male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model, male_data)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model, female_data)

# Calibration plots with performance metrics
calibration(male_predicted_probabilities, male_data$highbp14090_adj)
calibration(female_predicted_probabilities, female_data$highbp14090_adj)

# Calibration in-the-whole and across percentiles
compare_probs(male_data, male_predicted_probabilities)
compare_probs(female_data, female_predicted_probabilities)
```

## 12. Full model assessment for bootstrap samples - BOOTSTRAP VALIDATION 1/2

```{r}
# Perform bootstrapping for both male and female full models
set.seed(123)
n_bootstrap <- 10  # Number of bootstrap resamples

# For male full model
bootstrap_results_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data), replace = TRUE)
  bootstrap_function(male_data, boot_indices, male_model)
}, simplify = FALSE)

# For female full model
bootstrap_results_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data), replace = TRUE)
  bootstrap_function(female_data, boot_indices, female_model)
}, simplify = FALSE)

# Aggregate and summarize results for male
nagelkerke_r2_male <- sapply(bootstrap_results_male, function(x) x$nagelkerke_r2)
brier_score_male <- sapply(bootstrap_results_male, function(x) x$brier_score)
auc_male <- sapply(bootstrap_results_male, function(x) x$auc_value)
auc_male_ci_lower <- sapply(bootstrap_results_male, function(x) x$auc_ci_lower)
auc_male_ci_upper <- sapply(bootstrap_results_male, function(x) x$auc_ci_upper)
relative_difference_overall_male <- sapply(bootstrap_results_male, function(x) x$relative_difference_overall)
ratio_90_10_male <- sapply(bootstrap_results_male, function(x) x$ratio_90_10)
ratio_95_5_male <- sapply(bootstrap_results_male, function(x) x$ratio_95_5)
calibration_slope_male <- sapply(bootstrap_results_male, function(x) x$calibration_slope)

# Aggregate and summarize results for female
nagelkerke_r2_female <- sapply(bootstrap_results_female, function(x) x$nagelkerke_r2)
brier_score_female <- sapply(bootstrap_results_female, function(x) x$brier_score)
auc_female <- sapply(bootstrap_results_female, function(x) x$auc_value)
auc_female_ci_lower <- sapply(bootstrap_results_female, function(x) x$auc_ci_lower)
auc_female_ci_upper <- sapply(bootstrap_results_female, function(x) x$auc_ci_upper)
relative_difference_overall_female <- sapply(bootstrap_results_female, function(x) x$relative_difference_overall)
ratio_90_10_female <- sapply(bootstrap_results_female, function(x) x$ratio_90_10)
ratio_95_5_female <- sapply(bootstrap_results_female, function(x) x$ratio_95_5)
calibration_slope_female <- sapply(bootstrap_results_female, function(x) x$calibration_slope)

# Combine into a data frame
results_summary <- data.frame(
  Metric = c("Mean Nagelkerke R²", "Mean Brier Score", "Mean AUC", "Mean AUC 95% CI Lower", 
            "Mean AUC 95% CI Upper", "Mean Observed v. Predicted (Overall)", "Mean Observed v. Predicted (90:10)",
             "Mean Observed v. Predicted (95:5)", "Mean Calibration Slope"),
  Male = c(mean(nagelkerke_r2_male), mean(brier_score_male), mean(auc_male), 
           mean(auc_male_ci_lower), mean(auc_male_ci_upper),
           mean(relative_difference_overall_male), mean(ratio_90_10_male),
           mean(ratio_95_5_male), mean(calibration_slope_male)),
  Female = c(mean(nagelkerke_r2_female), mean(brier_score_female), mean(auc_female),
             mean(auc_female_ci_lower), mean(auc_female_ci_upper),
             mean(relative_difference_overall_female), mean(ratio_90_10_female),
             mean(ratio_95_5_female), mean(calibration_slope_female))
)

# Print the summary data frame
print(results_summary)
```

## 13. Reduced model assessment for bootstrap samples - BOOTSTRAP VALIDATION 2/2

```{r}
# Perform bootstrapping for both male and female reduced models
set.seed(123)
n_bootstrap <- 10  # Number of bootstrap resamples

# For male reduced model
bootstrap_results_male <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(male_data), replace = TRUE)
  bootstrap_function(male_data, boot_indices, male_reduced_model)
}, simplify = FALSE)

# For female reduced model
bootstrap_results_female <- replicate(n_bootstrap, {
  boot_indices <- sample(1:nrow(female_data), replace = TRUE)
  bootstrap_function(female_data, boot_indices, female_reduced_model)
}, simplify = FALSE)

# Aggregate and summarize results for male
nagelkerke_r2_male <- sapply(bootstrap_results_male, function(x) x$nagelkerke_r2)
brier_score_male <- sapply(bootstrap_results_male, function(x) x$brier_score)
auc_male <- sapply(bootstrap_results_male, function(x) x$auc_value)
auc_male_ci_lower <- sapply(bootstrap_results_male, function(x) x$auc_ci_lower)
auc_male_ci_upper <- sapply(bootstrap_results_male, function(x) x$auc_ci_upper)
relative_difference_overall_male <- sapply(bootstrap_results_male, function(x) x$relative_difference_overall)
ratio_90_10_male <- sapply(bootstrap_results_male, function(x) x$ratio_90_10)
ratio_95_5_male <- sapply(bootstrap_results_male, function(x) x$ratio_95_5)
calibration_slope_male <- sapply(bootstrap_results_male, function(x) x$calibration_slope)

# Aggregate and summarize results for female
nagelkerke_r2_female <- sapply(bootstrap_results_female, function(x) x$nagelkerke_r2)
brier_score_female <- sapply(bootstrap_results_female, function(x) x$brier_score)
auc_female <- sapply(bootstrap_results_female, function(x) x$auc_value)
auc_female_ci_lower <- sapply(bootstrap_results_female, function(x) x$auc_ci_lower)
auc_female_ci_upper <- sapply(bootstrap_results_female, function(x) x$auc_ci_upper)
relative_difference_overall_female <- sapply(bootstrap_results_female, function(x) x$relative_difference_overall)
ratio_90_10_female <- sapply(bootstrap_results_female, function(x) x$ratio_90_10)
ratio_95_5_female <- sapply(bootstrap_results_female, function(x) x$ratio_95_5)
calibration_slope_female <- sapply(bootstrap_results_female, function(x) x$calibration_slope)

# Combine into a data frame
results_summary <- data.frame(
  Metric = c("Mean Nagelkerke R²", "Mean Brier Score", "Mean AUC", "Mean AUC 95% CI Lower", 
            "Mean AUC 95% CI Upper", "Mean Observed v. Predicted (Overall)", "Mean Observed v. Predicted (90:10)",
             "Mean Observed v. Predicted (95:5)", "Mean Calibration Slope"),
  Male = c(mean(nagelkerke_r2_male), mean(brier_score_male), mean(auc_male), 
           mean(auc_male_ci_lower), mean(auc_male_ci_upper),
           mean(relative_difference_overall_male), mean(ratio_90_10_male),
           mean(ratio_95_5_male), mean(calibration_slope_male)),
  Female = c(mean(nagelkerke_r2_female), mean(brier_score_female), mean(auc_female),
             mean(auc_female_ci_lower), mean(auc_female_ci_upper),
             mean(relative_difference_overall_female), mean(ratio_90_10_female),
             mean(ratio_95_5_female), mean(calibration_slope_female))
)

# Print the summary data frame
print(results_summary)
```

## 14. Calibration across subgroups for full models

```{r}
# Generate predicted probabilities for full model
male_predicted_probabilities <- generate_predicted_probabilities(male_model, male_data)
female_predicted_probabilities <- generate_predicted_probabilities(female_model, female_data)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)

# Initialize an empty list to store calibration results
male_calibration_results <- list()

# Loop through each subgroup
for (subgroup in subgroups) {
  # Ensure the group variable is not missing or invalid
  if (all(!is.na(male_data[[subgroup]]))) {
    # Perform calibration and store the result
    male_calibration_results[[subgroup]] <- calibration(
      male_predicted_probabilities,
      male_data$highbp14090_adj,
      group = male_data[[subgroup]]
    )
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values."))
  }
}

# Inspect the results for each subgroup
male_calibration_results

# Initialize an empty list to store calibration results
female_calibration_results <- list()

# Loop through each subgroup in the female dataset
for (subgroup in subgroups) {
  # Ensure the group variable is not missing or invalid
  if (all(!is.na(female_data[[subgroup]]))) {
    # Perform calibration and store the result
    female_calibration_results[[subgroup]] <- calibration(
      female_predicted_probabilities,
      female_data$highbp14090_adj,
      group = female_data[[subgroup]]
    )
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values."))
  }
}

# Inspect the results for each subgroup
female_calibration_results
```

## 15. Calibration across subgroups for reduced models

```{r}
# Generate predicted probabilities for full model
male_predicted_probabilities <- generate_predicted_probabilities(male_reduced_model, male_data)
female_predicted_probabilities <- generate_predicted_probabilities(female_reduced_model, female_data)

# Obtain calibration subgroups
subgroups <- recodeflow:::select_vars_by_role(c("Predictor", "cali-subgroup"), my_variables)

# Initialize an empty list to store calibration results
male_calibration_results <- list()

# Loop through each subgroup
for (subgroup in subgroups) {
  # Ensure the group variable is not missing or invalid
  if (all(!is.na(male_data[[subgroup]]))) {
    # Perform calibration and store the result
    male_calibration_results[[subgroup]] <- calibration(
      male_predicted_probabilities,
      male_data$highbp14090_adj,
      group = male_data[[subgroup]]
    )
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values."))
  }
}

# Inspect the results for each subgroup
male_calibration_results

# Initialize an empty list to store calibration results
female_calibration_results <- list()

# Loop through each subgroup in the female dataset
for (subgroup in subgroups) {
  # Ensure the group variable is not missing or invalid
  if (all(!is.na(female_data[[subgroup]]))) {
    # Perform calibration and store the result
    female_calibration_results[[subgroup]] <- calibration(
      female_predicted_probabilities,
      female_data$highbp14090_adj,
      group = female_data[[subgroup]]
    )
  } else {
    warning(paste("Skipping subgroup:", subgroup, "due to missing values."))
  }
}

# Inspect the results for each subgroup
female_calibration_results
```

## 16. Model presentation (ignore for now)

```{r}
# Create the Predictor object with 'response' to get probabilities
# male_explainer <- iml::Predictor$new(
#   model = male_reduced_model,                                     # Pass the model
#   data = male_data,                                               # Pass the data
#   y = male_data[["highbp14090_adj"]],                             # Indicate outcome
#   type = "response"                                               # Return predicted probabilities
# )
# 
# # Initialize an empty list to store SHAP values for each observation
# male_shap_values_list <- list()
# 
# # Loop through each row in the male data
# for (i in 1:nrow(male_data)) {
#   observation <- as.data.frame(male_data[i, ])                    # Extract each observation as a data frame
#   
#   # Compute SHAP values for the observation
#   male_shap_values <- iml::Shapley$new(male_explainer, x.interest = observation)
#   
#   # Extract the computed SHAP values and store them in the list
#   male_shap_values_list[[i]] <- male_shap_values$results
# }
# 
# # Convert the list to a data frame for easier manipulation
# male_shap_values_all <- do.call(rbind, male_shap_values_list)
# 
# # Repeat all for female model and data
# female_explainer <- iml::Predictor$new(
#   model = female_reduced_model,                                     # Pass the model
#   data = female_data,                                               # Pass the data
#   y = female_data[["highbp14090_adj"]],                             # Indicate outcome
#   type = "response"                                                 # Return predicted probabilities
# )
# 
# female_shap_values_list <- list()
# 
# for (i in 1:nrow(female_data)) {
#   observation <- as.data.frame(female_data[i, ])                    # Extract each observation as a data frame
#   
#   female_shap_values <- iml::Shapley$new(female_explainer, x.interest = observation)
#   
#   female_shap_values_list[[i]] <- female_shap_values$results
# }
# 
# female_shap_values_all <- do.call(rbind, female_shap_values_list)
# 
# # # Filter for ckd == 1 and ckd == 0 separately
# shap_ckd_1 <- shap_values_all %>%
#   filter(feature.value == "ckd=1")
# 
# shap_ckd_0 <- shap_values_all %>%
#   filter(feature.value == "ckd=0")
# 
# # Calculate S-OR for ckd
# ckd_sor <- exp(mean(shap_ckd_1$phi) - mean(shap_ckd_0$phi))
# 
# # Calculate the standard error for the difference in means
# se_diff <- sqrt(mean(shap_ckd_1$phi.var) / nrow(shap_ckd_1) + mean(shap_ckd_0$phi.var) / nrow(shap_ckd_0))
# 
# # Calculate the difference in means (log-odds difference)
# log_odds_diff <- mean(shap_ckd_1$phi) - mean(shap_ckd_0$phi)
# 
# # Compute the 95% confidence interval for ckd S-OR
# lower_bound_or <- exp(log_odds_diff - 1.96 * se_diff)
# upper_bound_or <- exp(log_odds_diff + 1.96 * se_diff)
```
