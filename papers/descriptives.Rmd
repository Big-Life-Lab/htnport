---
title: "HTNPoRT Paper - Descriptive Analysis"
author: "Rafidul Islam"
output: pdf_document
---

### Load packages, functions, and metadata

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Set working directory at RDC
setwd("P:/10619/Dropbox/htnport")

# Load packages and functions
.libPaths("P:/10619/Rpackages")
library(haven)
library(dplyr)
library(recodeflow)
library(survey)
library(srvyr)
library(gtsummary)
library(flextable)

source("R/alcohol.R")
source("R/blood-pressure.R")
source("R/cholesterol-and-obesity.R")
source("R/diabetes.R")
source("R/diet.R")
source("R/exercise.R")
source("R/family-history.R")
source("R/income.R")
source("R/kidney.R")
source("R/medications.R")
source("R/sample.R")

source("R/descriptive-functions.R")
source("R/get-descriptive-data.R")
source("R/create-descriptive-table.R")
source("R/impute-variables.R")

# Load metadata
config <- config::get()
my_variables <- read.csv(config$variables)
my_variable_details <- read.csv(config$variable_details)
```

### Load medication data and recode medication variables

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Load medication data
cycle1_meds <- read_sas(config$data$`cycle1-meds`)
names(cycle1_meds) <- tolower(names(cycle1_meds)) 
cycle2_meds <- read_sas(config$data$`cycle2-meds`)
cycle3_meds <- read_stata(config$data$`cycle3-meds`)
cycle4_meds <- read_stata(config$data$`cycle4-meds`)
names(cycle4_meds) <- tolower(names(cycle4_meds)) 
cycle5_meds <- read_stata(config$data$`cycle5-meds`)
cycle6_meds <- read_stata(config$data$`cycle6-meds`)
names(cycle6_meds) <- tolower(names(cycle6_meds))

# Recode medication variables from medication data
cycle1_medication_data <- recodeflow::rec_with_table(cycle1_meds, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
cycle2_medication_data <- recodeflow::rec_with_table(cycle2_meds, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
cycle3_medication_data <- recodeflow::rec_with_table(cycle3_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle4_medication_data <- recodeflow::rec_with_table(cycle4_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle5_medication_data <- recodeflow::rec_with_table(cycle5_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
cycle6_medication_data <- recodeflow::rec_with_table(cycle6_meds, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)
```

### Load overall data, flatten/merge medication data to overall data, and recode all variables from each cycle

```{r, include = FALSE, warning = FALSE, message = FALSE}
# Load overall cycle data
cycle1 <- read_stata(config$data$cycle1)
cycle2 <- read_stata(config$data$cycle2)
cycle3 <- read_stata(config$data$cycle3)
cycle4 <- read_stata(config$data$cycle4)
cycle5 <- read_stata(config$data$cycle5)
cycle6 <- read_stata(config$data$cycle6)
names(cycle6) <- tolower(names(cycle6)) 

# Assign cycle variable to each cycle for imputation purposes
cycle1$cycle <- 1
cycle2$cycle <- 2
cycle3$cycle <- 3
cycle4$cycle <- 4
cycle5$cycle <- 5
cycle6$cycle <- 6

# Derive outcome medication criterion in medication data, and merge that data to overall cycle data
cycle1_medication_data$anymed2 <- as.numeric(as.character(cycle1_medication_data$anymed))
cycle2_medication_data$anymed2 <- as.numeric(as.character(cycle2_medication_data$anymed))

cycle1_medication_data$diab_drug2 <- as.numeric(as.character(cycle1_medication_data$diab_drug))
cycle2_medication_data$diab_drug2 <- as.numeric(as.character(cycle2_medication_data$diab_drug))

cycle1_medication_data <- dplyr::select(cycle1_medication_data, clinicid, anymed2, diab_drug2)
cycle2_medication_data <- dplyr::select(cycle2_medication_data, clinicid, anymed2, diab_drug2)

cycle1 <- merge(cycle1, cycle1_medication_data, by = "clinicid")
cycle2 <- merge(cycle2, cycle2_medication_data, by = "clinicid")
cycle3 <- process_long_medication_data(cycle3, cycle3_medication_data)
cycle4 <- process_long_medication_data(cycle4, cycle4_medication_data)
cycle5 <- process_long_medication_data(cycle5, cycle5_medication_data)
cycle6 <- process_long_medication_data(cycle6, cycle6_medication_data)

# Recode variables from each cycle
cycle1_data <- recodeflow::rec_with_table(cycle1, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle2_data <- recodeflow::rec_with_table(cycle2, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle3_data <- recodeflow::rec_with_table(cycle3, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle4_data <- recodeflow::rec_with_table(cycle4, recodeflow:::select_vars_by_role(c("Recode", "Fam"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle5_data <- recodeflow::rec_with_table(cycle5, recodeflow:::select_vars_by_role(c("Recode"), my_variables), variable_details = my_variable_details, log = TRUE)
cycle6_data <- recodeflow::rec_with_table(cycle6, recodeflow:::select_vars_by_role(c("Recode"), my_variables), variable_details = my_variable_details, log = TRUE)
```

### Table 1a - Unweighted unimputed data

```{r, warning = FALSE, message = FALSE}
# Combine cycles to obtain sample
cycles1to6_data <- dplyr::bind_rows(cycle1_data, cycle2_data, cycle3_data, cycle4_data, cycle5_data, cycle6_data)
cycles1to6_data <- dplyr::filter(cycles1to6_data, insample == 1)

# Load and merge extra accelerometer data to sample data
tracey <- read_sas(config$data$tracey)
tracey$clinicid <-tracey$CLINICID
tracey$mvpa_min <- tracey$avg_mvpa
tracey$minperweek <- tracey$mvpa_min * 7
tracey <- subset(tracey, select = -c(CLINICID, avg_mvpa, adultPAG))

cycles1to6_data <- dplyr::left_join(cycles1to6_data, tracey, by = c("clinicid"))
cycles1to6_data <- cycles1to6_data %>%
  dplyr::mutate(mvpa_min = coalesce(mvpa_min.x, mvpa_min.y),
         minperweek = coalesce(minperweek.x, minperweek.y)) %>%
  dplyr::mutate(mvpa_min = ifelse(is.na(mvpa_min), haven::tagged_na("b"), mvpa_min),
         minperweek = ifelse(is.na(minperweek), haven::tagged_na("b"), minperweek)) %>%
  dplyr::select(c(clinicid, wgt_full, clc_sex, recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables)))

# Generate unimputed and unweighted Table 1
table1a_data <- get_descriptive_data(
  cycles1to6_data,
  my_variables,
  my_variable_details,
  # All the variables whose descriptive statistics we want
  recodeflow:::select_vars_by_role(
    c("Table 1"),
    my_variables
  ),
  # Sets the stratifier
  list("all" = list("clc_sex"))
)

create_descriptive_table(
  table1a_data,
  my_variables,
  my_variable_details,
  recodeflow:::select_vars_by_role(
    c("Table 1"),
    my_variables
  ),
  column_stratifier = c("clc_sex"),
  subjects_order = c("Age", "Sex", "Marital status", "Education", "Occupation", "Family history", "Exercise", "Diet", "Weight", "Chronic disease", "Alcohol", "Smoking", "Sleep", "General")
)
```

### Table 1b - Weighted imputed data

```{r, warning = FALSE, message = FALSE}
# Combine cycles to reobtain sample
cycles1to6_data <- dplyr::bind_rows(cycle1_data, cycle2_data, cycle3_data, cycle4_data, cycle5_data, cycle6_data)
cycles1to6_data <- dplyr::filter(cycles1to6_data, insample == 1)

# Reload and remerge extra accelerometer data to sample data
tracey <- read_sas(config$data$tracey)
tracey$clinicid <-tracey$CLINICID
tracey$mvpa_min <- tracey$avg_mvpa
tracey$minperweek <- tracey$mvpa_min * 7
tracey <- subset(tracey, select = -c(CLINICID, avg_mvpa, adultPAG))

cycles1to6_data <- dplyr::left_join(cycles1to6_data, tracey, by = c("clinicid"))
cycles1to6_data <- cycles1to6_data %>%
  dplyr::mutate(mvpa_min = coalesce(mvpa_min.x, mvpa_min.y),
         minperweek = coalesce(minperweek.x, minperweek.y)) %>%
  dplyr::mutate(mvpa_min = ifelse(is.na(mvpa_min), haven::tagged_na("b"), mvpa_min),
         minperweek = ifelse(is.na(minperweek), haven::tagged_na("b"), minperweek)) %>%
  dplyr::select(c(clinicid, wgt_full, clc_sex, highbp14090, control14090, control14090_adj, recodeflow:::select_vars_by_role(c("imputation-predictor, cali-subgroup"), my_variables)))

# Impute data
imputed_cycles1to6_data <- impute_variables(dplyr::select(cycles1to6_data, -clinicid), outcomes = recodeflow:::select_vars_by_role(c("Predictor, cali-subgroup"), my_variables), predictors = recodeflow:::select_vars_by_role(c("imputation-predictor"), my_variables))
imputed_cycles1to6_data$clinicid <- cycles1to6_data$clinicid

# Load bootstrap weights for all cycles and merge them to imputed sample data
cycles1to6_bsw <- read_stata(config$data$cycles1to6_bsw)
names(cycles1to6_bsw) <- tolower(names(cycles1to6_bsw)) 

cycles1to6_bsw <- cycles1to6_bsw %>%
  dplyr::select(c(clinicid, starts_with("bsw")))

imputed_cycles1to6_data <- dplyr::left_join(imputed_cycles1to6_data, cycles1to6_bsw, by = c("clinicid"))

# Rename variables for table
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::rename(
    'Age' = clc_age,
    `Marital status` = married,
    `Highest education level` = edudr04,
    `Working status` = working,
    `Hypertension family history` = fmh_15,
    `Minutes of exercise per week` = minperweek,
    `Daily fruit and vegetable consumption` = totalfv,
    `Body mass index` = hwmdbmi,
    `Chronic kidney disease` = ckd,
    'Diabetes' = diabx,
    `Alcohol consumption level` = low_drink_score1,
    `Smoking status` = smoke,
    `Hours of sleep per day` = slp_11,
    `Self-rated mental health` = gendmhi,
    'Stress' = gen_025,
    `Sense of belonging` = gen_045
  )

# Apply weights to data
weighted_imputed_data <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = imputed_cycles1to6_data 
)

# Generate table itself
gtsummary::tbl_svysummary(
  data = weighted_imputed_data, 
  by = clc_sex,
  include = c(
    'Age',
    `Marital status`,
    `Highest education level`,
    `Working status`,
    `Hypertension family history`,
    `Minutes of exercise per week`,
    `Daily fruit and vegetable consumption`,
    `Body mass index`,
    `Chronic kidney disease`,
    'Diabetes',
    `Alcohol consumption level`,
    `Smoking status`,
    `Hours of sleep per day`,
    `Self-rated mental health`,
    'Stress',
    `Sense of belonging`
  ),
  statistic = list(
    all_continuous() ~ "{median} ({p25}, {p75})",
    all_categorical() ~ "{n_unweighted} ({p}%)"
  ),
  missing = "no"
) %>%
  # Rename columns
  gtsummary::modify_header(label = "**Characteristic**") %>%
  gtsummary::modify_spanning_header(
    all_stat_cols() ~ "**Sex**"
  ) %>%
  gtsummary::modify_header(
    stat_1 = "**Male**",
    stat_2 = "**Female**"
  ) %>%
  # Rename variable names and category labels
  gtsummary::modify_table_body(
    ~ .x %>%
      dplyr::mutate(
        label = dplyr::case_when(
          variable == "Marital status" & label == "1" ~ "Married or common-law",
          variable == "Marital status" & label == "2" ~ "Widowed, separated, or divorced",
          variable == "Marital status" & label == "3" ~ "Single",
          variable == "Highest education level" & label == "1" ~ "No high school",
          variable == "Highest education level" & label == "2" ~ "Secondary",
          variable == "Highest education level" & label == "3" ~ "Post-secondary",
          variable == "Working status" & label == "1" ~ "Has a job",
          variable == "Working status" & label == "2" ~ "Does not have a job",
          variable == "Hypertension family history" & label == "1" ~ "Yes",
          variable == "Hypertension family history" & label == "2" ~ "No",
          variable == "Chronic kidney disease" & label == "1" ~ "Yes",
          variable == "Chronic kidney disease" & label == "2" ~ "No",
          variable == "Diabetes" & label == "1" ~ "Yes",
          variable == "Diabetes" & label == "2" ~ "No",
          variable == "Alcohol consumption level" & label == "1" ~ "Never drank",
          variable == "Alcohol consumption level" & label == "2" ~ "Low-risk drinker",
          variable == "Alcohol consumption level" & label == "3" ~ "Moderate drinker",
          variable == "Alcohol consumption level" & label == "4" ~ "Heavy drinker",
          variable == "Smoking status" & label == "1" ~ "Current smoker",
          variable == "Smoking status" & label == "2" ~ "Former smoker",
          variable == "Smoking status" & label == "3" ~ "Never smoker",
          variable == "Self-rated mental health" & label == "1" ~ "Poor or fair",
          variable == "Self-rated mental health" & label == "2" ~ "Good, very good, or excellent",
          variable == "Stress" & label == "1" ~ "Not at all to a bit",
          variable == "Stress" & label == "2" ~ "Quite a bit or extremely",
          variable == "Sense of belonging" & label == "1" ~ "Strong",
          variable == "Sense of belonging" & label == "2" ~ "Weak",
          TRUE ~ label
        )
      )
  )

# Synthetic dataset for test use outside RDC
# set.seed(123)
# imputed_cycles1to6_data <- data.frame(
# highbp14090_adj = sample(1:2, 1000, replace = TRUE), # Binary hypertension outcome
# highbp14090 = sample(1:2, 1000, replace = TRUE), # Binary unadjusted hypertension outcome
# control14090_adj = sample(1:2, 1000, replace = TRUE), # Binary controlled hypertension outcome
# control14090 = sample(1:2, 1000, replace = TRUE), # Binary controlled and unadjusted hypertension outcome
# highbp13080_adj = sample(1:2, 1000, replace = TRUE), # Binary 130/80 hypertension outcome
# ccc_51 = sample(1:2, 1000, replace = TRUE), # Binary self-reported diabetes
# ckd = sample(1:2, 1000, replace = TRUE), # Binary chronic kidney disease
# edudr04 = sample(1:3, 1000, replace = TRUE), # Categorical education
# fmh_15 = sample(1:2, 1000, replace = TRUE), # Binary family history
# gendmhi = sample(1:2, 1000, replace = TRUE), # Categorical self-rated mental health
# gen_025 = sample(1:2, 1000, replace = TRUE), # Binary self-perceived stress
# gen_045 = sample(1:2, 1000, replace = TRUE), # Binary sense of belonging
# low_drink_score1 = sample(1:4, 1000, replace = TRUE), # Categorical alcohol consumption level
# married = sample(1:3, 1000, replace = TRUE), # Categorical marital status
# smoke = sample(1:3, 1000, replace = TRUE), # Categorical smoking status
# working = sample(1:2, 1000, replace = TRUE), # Binary working status
# clc_sex = sample(1:2, 1000, replace = TRUE), # Binary sex
# wgt_full = runif(1000, 0, 1), # Numeric weights
# clc_age = sample(20:79, 1000, replace = TRUE), # Integer age
# hwmdbmi = runif(1000, 9.47, 56.77), # Numeric body mass index
# minperweek = runif(1000, 0, 2004), # Numeric physical activity minutes
# totalfv = runif(1000, 0, 20), # Numeric fruit and vegetable consumption
# whr = runif(1000, 25, 100), # Numeric waist-to-height ratio
# slp_11 = runif(1000, 2, 18), # Numeric sleep duration
# diabx = sample(1:2, 1000, replace = TRUE), # Binary overall diabetes
# cycle = sample(1:6, 1000, replace = TRUE), # Cycle variable ranging from 1 to 6
# anymed2 = sample(0:1, 1000, replace = TRUE), # Binary HTN medication (derived)
# ccc_32 = sample(1:2, 1000, replace = TRUE), # Binary HTN medication (self-reported)
# cardiov = sample(1:2, 1000, replace = TRUE), # Binary CVD
# bsw1 = runif(1000, 0, 1), # Numeric bootstrap weights
# bsw2 = runif(1000, 0, 1) # Numeric bootstrap weights
# )
```

### Table 2a - Weighted outcome x sex distribution

```{r, warning = FALSE, message = FALSE}
# Rename hypertension variable for table
imputed_cycles1to6_data <- imputed_cycles1to6_data %>%
  dplyr::rename(
    'Hypertension (Adjusted BPs)' = highbp14090_adj,
    'Hypertension (Adjusted BPs - 130/80)' = highbp13080_adj,
    'Hypertension (Unadjusted BPs)' = highbp14090,
    'Controlled Hypertension (Adjusted BPs)' = control14090_adj,
    'Controlled Hypertension (Unadjusted BPs)' = control14090,
  )

# Apply weights to data
weighted_imputed_data <- survey::svydesign(
  id = ~1,
  weights = ~wgt_full,
  data = dplyr::select(imputed_cycles1to6_data, c('Hypertension (Adjusted BPs)', 'Hypertension (Adjusted BPs - 130/80)', 'Hypertension (Unadjusted BPs)', 'Controlled Hypertension (Adjusted BPs)', 'Controlled Hypertension (Unadjusted BPs)', clc_sex, wgt_full))
)

# Generate table itself
gtsummary::tbl_svysummary(
  data = weighted_imputed_data, 
  by = clc_sex,
  include = -wgt_full,
  statistic = list(
    all_categorical() ~ "{n_unweighted} ({p}%)"
  ),
  missing = "no"
) %>%
  # Rename columns
  gtsummary::modify_header(label = "**Characteristic**") %>%
  gtsummary::modify_spanning_header(
    all_stat_cols() ~ "**Sex**"
  ) %>%
  gtsummary::modify_header(
    stat_1 = "**Male**",
    stat_2 = "**Female**"
  ) %>%
  # Rename variable names and category labels
  gtsummary::modify_table_body(
    ~ .x %>%
      dplyr::mutate(
        label = dplyr::case_when(
          variable == "Hypertension (Adjusted BPs)" & label == "1" ~ "Yes",
          variable == "Hypertension (Adjusted BPs)" & label == "2" ~ "No",
          variable == "Hypertension (Adjusted BPs - 130/80)" & label == "1" ~ "Yes",
          variable == "Hypertension (Adjusted BPs - 130/80)" & label == "2" ~ "No",
          variable == "Hypertension (Unadjusted BPs)" & label == "1" ~ "Yes",
          variable == "Hypertension (Unadjusted BPs)" & label == "2" ~ "No",
          variable == "Controlled Hypertension (Adjusted BPs)" & label == "1" ~ "Yes",
          variable == "Controlled Hypertension (Adjusted BPs)" & label == "2" ~ "No",
          variable == "Controlled Hypertension (Unadjusted BPs)" & label == "1" ~ "Yes",
          variable == "Controlled Hypertension (Unadjusted BPs)" & label == "2" ~ "No",
          TRUE ~ label
        )
      )
  )

# Revert the names in the data frame
original_names <- c(
  "Hypertension (Adjusted BPs)" = "highbp14090_adj",
  "Hypertension (Adjusted BPs - 130/80)" = "highbp13080_adj",
  'Hypertension (Unadjusted BPs)' = "highbp14090",
  'Controlled Hypertension (Adjusted BPs)' = "control14090_adj",
  'Controlled Hypertension (Unadjusted BPs)' = "control14090",
  "Age" = "clc_age",
  "Marital status" = "married",
  "Highest education level" = "edudr04",
  "Working status" = "working",
  "Hypertension family history" = "fmh_15",
  "Minutes of exercise per week" = "minperweek",
  "Daily fruit and vegetable consumption" = "totalfv",
  "Body mass index" = "hwmdbmi",
  "Chronic kidney disease" = "ckd",
  "Diabetes" = "diabx",
  "Alcohol consumption level" = "low_drink_score1",
  "Smoking status" = "smoke",
  "Hours of sleep per day" = "slp_11",
  "Self-rated mental health" = "gendmhi",
  "Stress" = "gen_025",
  "Sense of belonging" = "gen_045"
)

names(imputed_cycles1to6_data) <- dplyr::recode(names(imputed_cycles1to6_data), !!!original_names)
```

### Density plots for continuous variables

```{r, warning = FALSE, message = FALSE}
# Unimputed data
create_weighted_density_plots(
  data = cycles1to6_data,
  grouping_var = "clc_sex",
  weight_var = "wgt_full",
  vars_to_plot = c("clc_age", "minperweek", "totalfv", "hwmdbmi", "slp_11"),
  group_labels = c("Male", "Female"),
  group_colors = c("blue", "red"),
  plot_titles = c(
    "Age Distribution",
    "Exercise Distribution",
    "Fruit and Vegetable Consumption Distribution",
    "Body Mass Index Distribution",
    "Sleep Duration Distribution"
  ),
  x_labels = c(
    "Age (years)",
    "Average minutes of exercise per week",
    "Times per day produce consumed",
    "Body mass index (kg/m2)",
    "Hours slept per night"
  )
)

# Imputed data
create_weighted_density_plots(
  data = imputed_cycles1to6_data, 
  grouping_var = "clc_sex", 
  weight_var = "wgt_full", 
  vars_to_plot = c("clc_age", "minperweek", "totalfv", "hwmdbmi", "slp_11"), 
  group_labels = c("Male", "Female"), 
  group_colors = c("blue", "red"), 
  plot_titles = c(
    "Age Distribution",
    "Exercise Distribution",
    "Fruit and Vegetable Consumption Distribution",
    "Body Mass Index Distribution",
    "Sleep Duration Distribution"
  ),
  x_labels = c(
    "Age (years)",
    "Average minutes of exercise per week",
    "Times per day produce consumed",
    "Body mass index (kg/m2)",
    "Hours slept per night"
  )
)
```