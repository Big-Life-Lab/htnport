---
title: "Recoding CHMS medication variables"
format: html
---

```{r}
library(readr)
library(here)
library(dplyr)
library(recodeflow)

my_variables <- read.csv(here("worksheets", "variables.csv"))
my_variable_details <- read.csv(here("worksheets", "variable-details.csv"))

source(here("R", "medications.R"), local = knitr::knit_global())
source(here("R", "diabetes.R"), local = knitr::knit_global())
source(here("R", "kidney.R"), local = knitr::knit_global())
source(here("R", "blood-pressure.R"), local = knitr::knit_global())
```

1. Create synthetic data for cycle 1 and cycle 3.
```{r}
# wide cycle1 data
cycle1 <- data.frame(
  clinicid = c(1, 2, 3, 4),
  clc_age = c(20, 30, 40, 50),
  clc_sex = c(1, 2, 1, 2),
  sdcdcgt = c(1, 1, 1, 2),
  lab_hba1 = c(0.07, 0.06, 0.05, 0.04),
  lab_bcre = c(20, 30, 40, 50),
  bpmdpbps = c(140, 130, 120, 110),
  bpmdpbpd = c(95, 85, 75, 65),
  ccc_51 = c(1, 2, 2, 2),
  ccc_61 = c(2, 2, 2, 2),
  ccc_63 = c(2, 2, 2, 2),
  ccc_81 = c(1, 2, 2, 1),
  ccc_32 = c(2, 1, 1, 1),
  atc_101a = c("C07AA05", "C09AA06", "C08CA01", "A10BC02"),
  atc_102a = c("A01AB05", "C09AA02", "C07AB02", "C03AA03"),
  atc_103a = c("C02CC07", "C08CA06", "C07AB07", "C07AB03"),
  atc_104a = c("C03CA01", "C03CA01", "C09AA04", "C08CA02"),
  atc_105a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_106a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_107a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_108a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_109a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_110a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_111a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_112a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_113a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_114a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_115a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_201a = c("C03BA08", "C07AA07", "C07AA12", "M01AG02"),
  atc_202a = c("C07AA05", "C09AA06", "C08CA01", "A10BC02"),
  atc_203a = c("C03BA08", "C07AA07", "C07AA12", "M01AG02"),
  atc_204a = c("C03BC02", "C08CA01", "C07AA05", "C07AA06"),
  atc_205a = c("C02KX01", "C02AA05", "C07AG02", "C07AA06"),
  atc_206a = c("A01AB05", "C09AA02", "C07AB02", "C03AA03"),
  atc_207a = c("C02CC07", "C08CA06", "C07AB07", "C07AB03"),
  atc_208a = c("C03CA01", "C03CA01", "C09AA04", "C08CA02"),
  atc_209a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_210a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_211a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_212a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_213a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_214a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_215a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_131a = c("C07AA05", "C09AA06", "C08CA01", "A10BC02"),
  atc_132a = c("C03BA08", "C07AA07", "C07AA12", "M01AG02"),
  atc_133a = c("C03BC02", "C08CA01", "C07AA05", "C07AA06"),
  atc_134a = c("C02KX01", "C02AA05", "C07AG02", "C07AA06"),
  atc_135a = c("A01AB05", "C09AA02", "C07AB02", "C03AA03"),
  atc_231a = c("C02CC07", "C08CA06", "C07AB07", "C07AB03"),
  atc_232a = c("C03CA01", "C03CA01", "C09AA04", "C08CA02"),
  atc_233a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_234a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  atc_235a = c("C09AA04", "C07AB02", "C08CA02", "A10BD05"),
  mhr_101b = c(2, 3, 1, 3),
  mhr_102b = c(1, 4, 3, 2),
  mhr_103b = c(3, 2, 1, 4),
  mhr_104b = c(1, 2, 4, 3),
  mhr_105b = c(3, 2, 1, 4),
  mhr_106b = c(3, 2, 1, 4),
  mhr_107b = c(3, 2, 1, 4),
  mhr_108b = c(3, 2, 1, 4),
  mhr_109b = c(3, 2, 1, 4),
  mhr_110b = c(3, 2, 1, 4),
  mhr_111b = c(3, 2, 1, 4),
  mhr_112b = c(3, 2, 1, 4),
  mhr_113b = c(3, 2, 1, 4),
  mhr_114b = c(3, 2, 1, 4),
  mhr_115b = c(3, 2, 1, 4),
  mhr_201b = c(3, 2, 2, 3),
  mhr_202b = c(2, 3, 1, 3),
  mhr_203b = c(3, 2, 2, 3),
  mhr_204b = c(3, 1, 5, 1),
  mhr_205b = c(1, 2, 3, 4),
  mhr_206b = c(1, 4, 3, 2),
  mhr_207b = c(3, 2, 1, 4),
  mhr_208b = c(1, 2, 4, 3),
  mhr_209b = c(3, 2, 1, 4),
  mhr_210b = c(3, 2, 1, 4),
  mhr_211b = c(3, 2, 1, 4),
  mhr_212b = c(3, 2, 1, 4),
  mhr_213b = c(3, 2, 1, 4),
  mhr_214b = c(3, 2, 1, 4),
  mhr_215b = c(3, 2, 1, 4),
  mhr_131b = c(2, 3, 1, 3),
  mhr_132b = c(3, 2, 2, 3),
  mhr_133b = c(3, 1, 5, 1),
  mhr_134b = c(1, 2, 3, 4),
  mhr_135b = c(1, 4, 3, 2),
  mhr_231b = c(3, 2, 1, 4),
  mhr_232b = c(1, 2, 4, 3),
  mhr_233b = c(3, 2, 1, 4),
  mhr_234b = c(3, 2, 1, 4),
  mhr_235b = c(3, 2, 1, 4)
) 

# Count the number of columns in cycle1, excluding the clinicid column
num_vars_cycle1 <- ncol(cycle1) - 1

# Replicate rows for each clinicid to match the number of columns in cycle1
clinicids <- unique(cycle1$clinicid)
n_clinicids <- length(clinicids)

# Create cycle3 with replicated rows; only med data is long in cycles 3-6, while rest is actually wide at RDC but made long for this qmd file
cycle3 <- data.frame(
  clinicid = rep(clinicids, each = num_vars_cycle1),
  clc_age = rep(c(20, 30, 40, 50), each = num_vars_cycle1),
  clc_sex = rep(c(1, 2, 1, 2), each = num_vars_cycle1),
  pgdcgt = rep(c(1, 1, 1, 2), each = num_vars_cycle1),
  lab_hba1 = rep(c(0.07, 0.06, 0.05, 0.04), each = num_vars_cycle1),
  lab_bcre = rep(c(20, 30, 40, 50), each = num_vars_cycle1),
  bpmdpbps = rep(c(140, 130, 120, 110), each = num_vars_cycle1),
  bpmdpbpd = rep(c(95, 85, 75, 65), each = num_vars_cycle1),
  ccc_51 = rep(c(1, 2, 2, 2), each = num_vars_cycle1),
  ccc_61 = rep(c(2, 2, 2, 2), each = num_vars_cycle1),
  ccc_63 = rep(c(2, 2, 2, 2), each = num_vars_cycle1),
  ccc_81 = rep(c(1, 2, 2, 1), each = num_vars_cycle1),
  ccc_32 = rep(c(2, 1, 1, 1), each = num_vars_cycle1),
  meucatc = rep(c("C07AA05", "C09AA06", "C08CA01", "A10BC02"), length.out = num_vars_cycle1 * n_clinicids),
  npi_25b = rep(c(2, 3, 1, 3), length.out = num_vars_cycle1 * n_clinicids)
) 
```

2. Recode medication variables for individual cycles.
```{r}
# Recoding basic variables from cycles 1 and 3
cycle1_medication_data <- rec_with_table(cycle1, c("clinicid", "atc_101a", "mhr_101b"), variable_details = my_variable_details)
head(cycle1_medication_data)

cycle3_medication_data <- rec_with_table(cycle3, c("clinicid", "meucatc", "npi_25b"), variable_details = my_variable_details)
head(cycle3_medication_data)

# Recoding derived variable acemed for cycle1. Select vars by role used to avoid writing all med variables in one line
cycle1_ace_medication_data <- rec_with_table(cycle1, c("clinicid", "acemed", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)
head(select(cycle1_ace_medication_data, clinicid, acemed)) 

# Recoding derived variable acemed for cycle3. Much simpler function used here.
cycle3_ace_medication_data <- rec_with_table(cycle3, c("clinicid", "meucatc", "npi_25b", "acemed"), variable_details = my_variable_details)
head(cycle3_ace_medication_data)
```

3. Merge recoded medication data
```{r}
# Aggregating recoded cycle3 data by clinicid
cycle3_ace_medication_data <- cycle3_ace_medication_data %>%
  group_by(clinicid) %>%
  summarize(
    meucatc = paste(unique(meucatc), collapse = ", "),  # Concatenate unique values of meucatc
    npi_25b = paste(unique(npi_25b), collapse = ", "),  # Concatenate unique values of npi_25b
    acemed = max(as.numeric(as.character(acemed))) # Find maximum of acemed
  )
head(cycle3_ace_medication_data)

# De-factorizing acemed variable in recoded cycle1 data
cycle1_ace_medication_data$acemed <- as.numeric(as.character(cycle1_ace_medication_data$acemed))

# Merging recoded cycle1 and cycle3 data, and ensuring one acemed column in the end
cycles1and3_ace_medication_data <- merge(cycle1_ace_medication_data, cycle3_ace_medication_data, by = "clinicid")
head(cycles1and3_ace_medication_data)

cycles1and3_ace_medication_data <- cycles1and3_ace_medication_data %>%
  mutate(acemed = pmax(acemed.x, acemed.y)) %>%
  select(-c(acemed.x, acemed.y))
head(cycles1and3_ace_medication_data)
```

4. Determine hypertension status by recoding medications 
```{r}
# Cycles 1-2
# Recode medication variables first - anymed for hypertension and diab_drug for diabetes which is involved in determining hypertension status
cycle1_htn_medication_data <- rec_with_table(cycle1, c("clinicid", recodeflow:::select_vars_by_role("Drugs", my_variables)), variable_details = my_variable_details)

# Create dummy medication variable by duplicating recoded medication variable
cycle1_htn_medication_data$anymed2 <- as.numeric(as.character(cycle1_htn_medication_data$anymed))
cycle1_htn_medication_data$diab_drug2 <- as.numeric(as.character(cycle1_htn_medication_data$diab_drug))
cycle1_htn_medication_data <- select(cycle1_htn_medication_data, clinicid, anymed2, diab_drug2)

# Merge medication data with original data
cycle1 <- merge(cycle1, cycle1_htn_medication_data, by = "clinicid")

# Recode hypertension (and diabetes) status using recoded, dummy medication variables
cycle1_htn_data <- rec_with_table(cycle1, c(recodeflow:::select_vars_by_role("Test", my_variables)), variable_details = my_variable_details)
head(cycle1_htn_data)

# Cycles 3-6
# Recode medication variables first - - anymed for hypertension and diab_drug for diabetes which is involved in determining hypertension status
cycle3_htn_medication_data <- rec_with_table(cycle3, c("clinicid", "meucatc", "npi_25b", "anymed", "diab_drug"), variable_details = my_variable_details)

# Aggregating recoded cycle3 data by clinicid
cycle3_htn_medication_data <- cycle3_htn_medication_data %>%
  group_by(clinicid) %>%
  summarize(
    meucatc = paste(unique(meucatc), collapse = ", "),   # Concatenate unique values of meucatc
    npi_25b = paste(unique(npi_25b), collapse = ", "),   # Concatenate unique values of npi_25b
    anymed = max(as.numeric(as.character(anymed))),      # Find maximum of anymed
    diab_drug = max(as.numeric(as.character(diab_drug))) # Find maximum of diab_drug
  )

# Create dummy medication variable by duplicating recoded medication variable
cycle3_htn_medication_data$anymed2 <- as.numeric(as.character(cycle3_htn_medication_data$anymed))
cycle3_htn_medication_data$diab_drug2 <- as.numeric(as.character(cycle3_htn_medication_data$diab_drug))
cycle3_htn_medication_data <- select(cycle3_htn_medication_data, clinicid, anymed2, diab_drug2)

# Aggregating original cycle3 data by clinicid to make it like the RDC cycle3 data (only being done here in qmd)
cycle3 <- cycle3 %>%
  select(-c(meucatc, npi_25b)) %>%
  group_by(clinicid) %>%
  summarize(
    clc_age = max(as.numeric(as.character(clc_age))),
    clc_sex = max(as.numeric(as.character(clc_sex))),
    pgdcgt = max(as.numeric(as.character(pgdcgt))),
    lab_hba1 = max(as.numeric(as.character(lab_hba1))),
    lab_bcre = max(as.numeric(as.character(lab_bcre))),
    bpmdpbps = max(as.numeric(as.character(bpmdpbps))),
    bpmdpbpd = max(as.numeric(as.character(bpmdpbpd))),
    ccc_51 = max(as.numeric(as.character(ccc_51))),
    ccc_61 = max(as.numeric(as.character(ccc_61))),
    ccc_63 = max(as.numeric(as.character(ccc_63))),
    ccc_81 = max(as.numeric(as.character(ccc_81))),
    ccc_32 = max(as.numeric(as.character(ccc_32)))
  )

# Merge medication data with original data
cycle3 <- merge(cycle3, cycle3_htn_medication_data, by = "clinicid")

# Recode hypertension (and diabetes) status using recoded, dummy medication variables
cycle3_htn_data <- rec_with_table(cycle3, c(recodeflow:::select_vars_by_role("Test", my_variables)), variable_details = my_variable_details)
head(cycle3_htn_data)
```